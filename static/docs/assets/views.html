<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>views.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>views.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.db.models.related</span> <span class="kn">import</span> <span class="n">RelatedObject</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">django_auth_ldap.backend</span> <span class="kn">import</span> <span class="n">LDAPBackend</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">restless.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">import</span> <span class="nn">models</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ImportForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">assets_to_import</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">FileField</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Performs validation on the CSV file at fileobj.</p>
<p>Returns a tuple (num_assets, errors, warnings, notes).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">validate_import</span><span class="p">(</span><span class="n">fileobj</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">c</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

    <span class="n">critical_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;asset_tag&#39;</span><span class="p">,</span> <span class="s">&#39;manufacturer&#39;</span><span class="p">,</span> <span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="s">&#39;serial&#39;</span><span class="p">,</span> <span class="s">&#39;date_purchased&#39;</span><span class="p">,</span> <span class="s">&#39;location_name&#39;</span><span class="p">,</span> <span class="s">&#39;location_block&#39;</span><span class="p">,</span> <span class="s">&#39;location_site&#39;</span><span class="p">)</span>
    <span class="n">all_fields</span> <span class="o">=</span> <span class="n">critical_fields</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39;model_lifecycle&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;assigned_user&#39;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>Initialise an LDAP connection</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">ldapbackend</span> <span class="o">=</span> <span class="n">LDAPBackend</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>List to hold errors found during the validation process</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>List of asset tags, to confirm uniqueness</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">asset_tag_list</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>Inspect the first row to see what columns we've got</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">critical_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;The mandatory column </span><span class="si">%s</span><span class="s"> is missing from the spreadsheet.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_fields</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Your spreadsheet contains an unknown column &#39;</span><span class="si">%s</span><span class="s">&#39;. This column will be ignored during the import process.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Your spreadsheet does not contain a column called &#39;status&#39; - the status field of every new asset will be set to &#39;In storage&#39;.&quot;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>Inspect each row and do field-specific validation</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Check asset tag syntax</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">asset_tag_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^IT\d{5}$&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">asset_tag_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The value &#39;</span><span class="si">%s</span><span class="s">&#39; in the asset_tag column is invalid. Asset tags should be in the form ITXXXXX.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">asset_tag_list</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The asset tag &#39;</span><span class="si">%s</span><span class="s">&#39; exists in several locations in the spreadsheet. Remove the duplicate values to continue.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]))</span>

            <span class="n">asset_tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset_tag__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The asset tag &#39;</span><span class="si">%s</span><span class="s">&#39; already exists in the database. Asset tags must be unique.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>This is ok, it means there's no duplicate asset in the database</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p>Check manufacturer</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">]:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The mandatory field &#39;manufacturer&#39; is blank.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">Manufacturer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">]:</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Manufacturer &#39;</span><span class="si">%s</span><span class="s">&#39; on line </span><span class="si">%d</span><span class="s"> is unknown - a new manufacturer record will be created.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p>Check model</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The mandatory field &#39;model&#39; is blank.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">manufacturer__name__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]:</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Model &#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39; on line </span><span class="si">%d</span><span class="s"> is unknown - a new model record will be created.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">manufacturer__name__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;model_lifecycle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model_lifecycle&#39;</span><span class="p">]):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: A new model is to be created, and model_lifecycle has not been specified.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p>Check model_lifecycle</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;model_lifecycle&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The value &#39;</span><span class="si">%s</span><span class="s">&#39; in the model_lifecycle column is invalid. The model_lifecycle field should consist of a single positive integer.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model_lifecycle&#39;</span><span class="p">]))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p>Check serial</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;serial&#39;</span><span class="p">]:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The mandatory field &#39;serial&#39; is blank.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p>Check purchased_date</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;date_purchased&#39;</span><span class="p">]:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The mandatory field &#39;purchased_date&#39; is blank.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">))</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;date_purchased&#39;</span><span class="p">],</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">/%m/%Y&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The value &#39;</span><span class="si">%s</span><span class="s">&#39; in the date_purchased column is invalid. Dates must be in the form dd/mm/yyyy.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;date_purchased&#39;</span><span class="p">]))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <p>Check status</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="s">&#39;In storage&#39;</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">!=</span> <span class="s">&#39;Deployed&#39;</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">!=</span> <span class="s">&#39;Disposed&#39;</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The value &#39;</span><span class="si">%s</span><span class="s">&#39; in the status column is invalid. The asset status must be one of &#39;In storage&#39;, &#39;Deployed&#39; or &#39;Disposed&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p>Check location fields</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">block__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_block&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">site__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_site&#39;</span><span class="p">]):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: There is no defined location matching </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">. Locations must be pre-defined in the Locations table before importing data.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_name&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_block&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_site&#39;</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p>Check assigned_user - make sure everything's a valid LDAP user</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p>This might be a bad way of doing this - the user table will be
populated with lots of people from LDAP</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">ldapbackend</span><span class="o">.</span><span class="n">populate_user</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;assigned_user&#39;</span><span class="p">])</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;assigned_user&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        <p>Missing fields will have been caught above</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">pass</span>
        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: The username &#39;</span><span class="si">%s</span><span class="s">&#39; in column assigned_user does not exist. Ensure it refers to a valid AD user.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;assigned_user&#39;</span><span class="p">]))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <p>Reset fileobj now we're finished with it</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_tag_list</span><span class="p">),</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">redirect_field_name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>Receives a POST request from the user, indicating that they would like to
proceed with the import.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">do_import</span><span class="p">(</span><span class="n">request</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">&quot;/assets/import&quot;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p>Build a file object from the CSV data in POST and validate the input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">fileobj</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;csv&#39;</span><span class="p">])</span>
    <span class="p">(</span><span class="n">num_assets</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span> <span class="o">=</span> <span class="n">validate_import</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&quot;assets/import_criticalerrors.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;errors&#39;</span><span class="p">:</span><span class="n">errors</span><span class="p">,</span> <span class="s">&#39;warnings&#39;</span><span class="p">:</span><span class="n">warnings</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">:</span><span class="n">notes</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;Bulk Import&#39;</span><span class="p">})</span>

    <span class="n">assets_created</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>Get the manufacturer and model first, and create if required</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manufacturer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manufacturer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;manufacturer&#39;</span><span class="p">])</span>
            <span class="n">ma</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="n">ma</span><span class="p">,</span> <span class="n">model__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">manufacturer</span><span class="o">=</span><span class="n">ma</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">],</span> <span class="n">lifecycle</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;model_lifecycle&#39;</span><span class="p">])</span>
            <span class="n">mo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_name&#39;</span><span class="p">],</span> <span class="n">block__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_block&#39;</span><span class="p">],</span> <span class="n">site__iexact</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;location_site&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p>This should never happen, but abort gracefully if it does</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&quot;assets/import_criticalerrors.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;errors&#39;</span><span class="p">:[</span><span class="s">&quot;Line </span><span class="si">%d</span><span class="s">: A critical error occurred while attempting to load the location record.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">line_num</span><span class="p">)],</span> <span class="s">&#39;warnings&#39;</span><span class="p">:[],</span> <span class="s">&#39;notes&#39;</span><span class="p">:[],</span> <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;Bulk Import&#39;</span><span class="p">})</span>
        </pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Finally, create the asset record</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">assigned_user</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;assigned_user&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">assigned_user</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">asset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="p">(</span><span class="n">asset_tag</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;asset_tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">model</span> <span class="o">=</span> <span class="n">mo</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">serial</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;serial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">date_purchased</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;date_purchased&#39;</span><span class="p">],</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">/%m/%Y&#39;</span><span class="p">),</span> <span class="n">location</span> <span class="o">=</span> <span class="n">loc</span><span class="p">,</span> <span class="n">assigned_user</span> <span class="o">=</span> <span class="n">assigned_user</span><span class="p">)</span>
        <span class="n">asset</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">assets_created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&quot;assets/import_complete.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;record_count&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">assets_created</span><span class="p">),</span> <span class="s">&#39;assets_created&#39;</span><span class="p">:</span><span class="n">assets_created</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;Bulk Import&#39;</span><span class="p">})</span>
    </pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <p>Receives a file object from import_asset, and does validation, shows a
confirmation/error page and finally does the actual import.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">confirm_import</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>Perform validation on the input given to us</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="p">(</span><span class="n">num_assets</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span> <span class="o">=</span> <span class="n">validate_import</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p>Stop and complain if we've got errors</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&quot;assets/import_criticalerrors.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;errors&#39;</span><span class="p">:</span><span class="n">errors</span><span class="p">,</span> <span class="s">&#39;warnings&#39;</span><span class="p">:</span><span class="n">warnings</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">:</span><span class="n">notes</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;Bulk Import&#39;</span><span class="p">})</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        <p>Otherwise, render the confirmation page</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&quot;assets/import_confirm.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;warnings&#39;</span><span class="p">:</span><span class="n">warnings</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">:</span><span class="n">notes</span><span class="p">,</span> <span class="s">&#39;record_count&#39;</span><span class="p">:</span><span class="n">num_assets</span><span class="p">,</span> <span class="s">&#39;csv&#39;</span><span class="p">:</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;Bulk Import&#39;</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">redirect_field_name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p>Displays a form prompting user to upload CSV containing assets. Passes
uploaded file object to confirm_import to validate data and prompt the user
for confirmation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">import_asset</span><span class="p">(</span><span class="n">request</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ImportForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">confirm_import</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">&#39;assets_to_import&#39;</span><span class="p">],</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ImportForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&quot;assets/import_intro.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;Bulk import&#39;</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Builds a list of fields on the specified Model, recursing into ForeignKey
relationships as necessary.</p>
<p>Returns a list of field names. If a queryset is provided to a set of model
instances, return a list of tuples, where list[0] is a tuple of field names
and the remaining items are tuples of field values.</p>
<p>Caveats:
<pre>- Unsure how this handles ManyToMany relationships, YMMV
- This function probably uses internal django methods</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">build_fields</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_all_field_names</span><span class="p">():</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Skip a variety uninteresting field names, from reversion or restless</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="s">&#39;modified&#39;</span><span class="p">,</span> <span class="s">&#39;modifier&#39;</span><span class="p">,</span> <span class="p">):</span>
            <span class="k">continue</span>

        <span class="p">(</span><span class="n">f_obj</span><span class="p">,</span> <span class="n">_model</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">_m2m</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p>Construct django-style relational field names, so we can just
dump them into values_list() below to get values</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">field_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">__</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">build_fields</span><span class="p">(</span><span class="n">f_obj</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>Reverse relations are RelatedObjects with no .rel attribute</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f_obj</span><span class="p">,</span> <span class="n">RelatedObject</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">queryset</span><span class="p">:</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_names</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        <p>I &lt;3 Python</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">field_data</span> <span class="o">+=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="o">*</span><span class="n">field_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field_names</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">redirect_field_name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p></pre>Dumps assets out as a CSV. Filters may be applied using the following GET
attributes:</p>
<ul>
<li>manufacturer</li>
<li>manufacturer_id</li>
<li>model</li>
<li>site</li>
<li>status</li>
<li>asset_tag</li>
<li>serial</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="n">request</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>response = HttpResponse(mimetype="text/csv")</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">mimetype</span><span class="o">=</span><span class="s">&quot;text/plain&quot;</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;assets_</span><span class="si">%s</span><span class="s">.csv&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p>response['Content-Disposition'] = 'attachment; filename=%s' % (filename)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">c</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="o">.</span><span class="n">objects</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p>Read in filters</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">manufacturer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;manufacturer&#39;</span><span class="p">)</span>
    <span class="n">manufacturer_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;manufacturer_id&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;model&#39;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;site&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">)</span>
    <span class="n">asset_tag</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;asset_tag&#39;</span><span class="p">)</span>
    <span class="n">serial</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;serial&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">manufacturer</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model__manufacturer__name__icontains</span> <span class="o">=</span> <span class="n">manufacturer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">manufacturer_id</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model__manufacturer__id__exact</span> <span class="o">=</span> <span class="n">manufacturer_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model__model__icontains</span> <span class="o">=</span> <span class="n">model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">site</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">location__site__icontains</span> <span class="o">=</span> <span class="n">site</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status__icontains</span> <span class="o">=</span> <span class="n">status</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">asset_tag</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">asset_tag__icontains</span> <span class="o">=</span> <span class="n">asset_tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">serial</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">serial__icontains</span> <span class="o">=</span> <span class="n">serial</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">manufacturer</span> <span class="ow">or</span> <span class="n">model</span> <span class="ow">or</span> <span class="n">site</span> <span class="ow">or</span> <span class="n">status</span> <span class="ow">or</span> <span class="n">asset_tag</span> <span class="ow">or</span> <span class="n">serial</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">output_rows</span> <span class="o">=</span> <span class="n">build_fields</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Asset</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">output_rows</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p>If there's no data, output_rows will be a single row</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">c</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">output_rows</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
