<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>regress.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>regress.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2008, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql_ctl.regress</code></h1>
<p>This module implements the <code>regress</code> routine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">ScriptError</span>
<span class="kn">from</span> <span class="nn">.routine</span> <span class="kn">import</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">Routine</span>
<span class="kn">from</span> <span class="nn">.option</span> <span class="kn">import</span> <span class="p">(</span><span class="n">InputOption</span><span class="p">,</span> <span class="n">TrainOption</span><span class="p">,</span> <span class="n">PurgeOption</span><span class="p">,</span>
                     <span class="n">ForceOption</span><span class="p">,</span> <span class="n">QuietOption</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.request</span> <span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">htsql.validator</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Validator</span><span class="p">,</span> <span class="n">BoolVal</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">,</span> <span class="n">WordVal</span><span class="p">,</span>
                             <span class="n">ChoiceVal</span><span class="p">,</span> <span class="n">IntVal</span><span class="p">,</span> <span class="n">UFloatVal</span><span class="p">,</span> <span class="n">DBVal</span><span class="p">,</span> <span class="n">SeqVal</span><span class="p">,</span>
                             <span class="n">MapVal</span><span class="p">,</span> <span class="n">ClassVal</span><span class="p">,</span> <span class="n">AnyVal</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">htsql.util</span> <span class="kn">import</span> <span class="n">maybe</span><span class="p">,</span> <span class="n">trim_doc</span><span class="p">,</span> <span class="n">DB</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">yaml</span><span class="o">,</span> <span class="nn">yaml.constructor</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Indicates that a field has no default value and therefore cannot be omitted.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="n">MANDATORY_FIELD</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Return values for <code>ask_*</code> methods indicating the user-chosen action.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="n">DO_CONTINUE</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">DO_DISCARD</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">DO_HALT</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">DO_RECORD</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">DO_SAVE</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">DO_SKIP</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>A readable file-like object with an "echo".  Whenever some content is read
from it, the same content is echoed to the specified <code>output</code> stream.</p>
<p>Use :class:<code>TermStringIO</code> to preserve the content of interactive
sessions with pre-recorded input.  Assign::</p>
<pre>sys.stdout = StringIO.StringIO()
sys.stdin = TermStringIO(input, sys.stdout)
</pre>

<p>where <code>input</code> contains the pre-recorded input data.  After the
session is done, the content of <code>sys.stdout</code> will be the same as
if the session was performed on a real terminal with echo enabled.</p>
<p><code>buf</code> (a string)
The content of the stream.</p>
<p><code>output</code> (a writable file-like object)
A stream that records data being read.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">TermStringIO</span><span class="p">(</span><span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Describes a parameter of test data.</p>
<p><code>attribute</code> (a string)
<pre>The name of the attribute that contains the field value.
</pre>
<code>val</code> (:class:<code>htsql.validator.Validator</code>)
The validator for the field values.</p>
<p><code>default</code>
The default value of the field.  If not provided, the field
cannot be omitted.  The <code>is_mandatory</code> attribute indicates if
the <code>default</code> value is provided.</p>
<p><code>hint</code> (a string or <code>None</code>)
A short one-line description of the field.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>Use it to filter out <code>AnyField</code> instances.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_any</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
                 <span class="n">default</span><span class="o">=</span><span class="n">MANDATORY_FIELD</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^[a-zA-Z_][0-9a-zA-Z_]*$&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Validator</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_mandatory</span> <span class="o">=</span> <span class="p">(</span><span class="n">default</span> <span class="ow">is</span> <span class="n">MANDATORY_FIELD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hint</span> <span class="o">=</span> <span class="n">hint</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p>Returns short one-line description of the field.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_hint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hint</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p>Returns the field name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mandatory</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">+=</span> <span class="s">&#39;*&#39;</span>
        <span class="k">return</span> <span class="n">signature</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p>Indicates that test data may contain extra fields.</p>
<p>Add <code>AnyField()</code> to the <code>fields</code> list to indicate that YAML
representation of test data may contain some attributes not
described by other fields.  These extra attributes will be
silently ignored.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AnyField</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p>Use it to filter out <code>AnyField</code> instances.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_any</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p>Represents input or output data of a test case.</p>
<p>This is an abstract class.  Create a subclass of :class:<code>TestData</code>
to describe input or output data for a specific test kind.  You need
to specify the format of test data using the <code>fields</code> class attribute.</p>
<p>The <code>fields</code> attribute is a list of :class:<code>Field</code> instances.  Each
field describes an attribute of test data.</p>
<p>Instances if :class:<code>TestData</code> are YAML-serializable.  A instance of
a :class:<code>TestData</code> subclass is represented as a mapping YAML node.
The sets of keys and the format of the values come from the <code>fields</code>
list.  Add an :class:<code>AnyField</code> instance to <code>fields</code> to indicate
that the mapping node may contain some extra fields (which are to
be ignored).</p>
<p>The constructor of :class:<code>TestData</code> accepts the following arguments:</p>
<p><code>routine</code> (:class:<code>RegressRoutine</code>)
<pre>The routine that started the testing.
</pre>
<code>case_class</code> (a subclass of :class:<code>TestCase</code>)
A test type.  The object being constructed is an instance
of either <code>case_class.Input</code> or <code>case_class.Output</code>.</p>
<p><code>attributes</code> (a dictionary)
A dictionary of attributes and their values.  The set of
attributes is declared using the <code>fields</code> class variable.</p>
<p><code>location</code> (a string or <code>None</code>)
When the test data is loaded from a YAML file, <code>location</code>
indicates the location of the corresponding YAML node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">TestData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">,</span> <span class="n">case_class</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">routine</span><span class="p">,</span> <span class="n">RegressRoutine</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">case_class</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">in</span> <span class="p">[</span><span class="n">case_class</span><span class="o">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">case_class</span><span class="o">.</span><span class="n">Output</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">routine</span> <span class="o">=</span> <span class="n">routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_class</span> <span class="o">=</span> <span class="n">case_class</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_attributes</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p>Normalize field values.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">init_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p>Override in a subclass if you need to massage some field values.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        <p>Produces the value of the first mandatory field.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">title_attribute</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">is_any</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">is_mandatory</span><span class="p">:</span>
                <span class="n">title_attribute</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attribute</span>
        <span class="k">if</span> <span class="n">title_attribute</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title_attribute</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>Describes a test type.</p>
<p>This an abstract class.  Create a subclass of :class:<code>TestCase</code>
to describe a new type of test case.  When subclassing, define
the following class attributes:</p>
<p><code>name</code> (a string)
<pre>The name of the test.
</pre>
<code>hint</code> (a string)
Short one-line description of the test.</p>
<p><code>help</code> (a string)
Long description of the test.</p>
<p><code>Input</code> (a subclass of :class:<code>TestData</code>)
The format of the test input.</p>
<p><code>Output</code> (a subclass of :class:<code>TestData</code> or <code>None</code>)
The format of the test output.</p>
<p>You also need to override methods :meth:<code>verify</code> and :meth:<code>train</code>
to specify how to execute the test case in a normal and in a train mode.</p>
<p>The constructor of :class:<code>TestCase</code> takes the following arguments:</p>
<p><code>routine</code> (:class:<code>RegressRoutine</code>)
The routine that started the testing.</p>
<p><code>state</code>
An object keeping the mutable testing state.</p>
<p><code>input</code> (an instance of <code>Input</code>)
Input test data.</p>
<p><code>output</code> (an instance of <code>Output</code> or <code>None</code>)
Expected output test data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">hint</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">help</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p>Override to declare the format of input and output test data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">Input</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Output</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>Returns short one-line description of the test case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_hint</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">hint</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Returns long description of the test case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_help</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <p>Produce:
{help}</p>
<p>Input data:
  {field.signature} - {field.hint}
  ...</p>
<p>Output data:
  {field.signature} - {field.hint}
  ...</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">trim_doc</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">help</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">help</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">help</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data_class</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">Output</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">data_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> data:&quot;</span> <span class="o">%</span> <span class="n">data_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">data_class</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">is_any</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_signature</span><span class="p">()</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_hint</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">hint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  </span><span class="si">%-24s</span><span class="s"> : </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">hint</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routine</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">routine</span><span class="p">,</span> <span class="n">RegressRoutine</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">routine</span><span class="o">.</span><span class="n">state_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Input</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">input</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Input</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Output</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">routine</span> <span class="o">=</span> <span class="n">routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p>When the test case is in the quiet mode (indicated by <code>is_quiet</code>),
all output is redirected to <code>quiet_buffer</code>.  If for some reason
the test case leaves the quiet mode, all the accumulated data
is dumped to the standard output stream.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">is_quiet</span> <span class="o">=</span> <span class="n">routine</span><span class="o">.</span><span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">make_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p>Generate a new test output record with the given attributes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        <p>Checks if the given input and output records belong to the same
test case.</p>
<p>Note that we assume that both test input and test output have
a field with the same attribute name.  This attribute is called
the key attribute.  Input data matches output data when the
values of their key attribute are equal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="n">TestData</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="n">TestData</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        <p><code>input</code> and <code>output</code> must be instances of <code>Input</code> and <code>Output</code>
classes of the test case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">Input</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cls</span><span class="o">.</span><span class="n">Output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">Input</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">Output</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Find the key attribute: one that is declared both as an input field
and as an output field.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">key_attribute</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">input_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">attribute</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">fields</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">is_any</span><span class="p">]</span>
        <span class="n">output_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">attribute</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">fields</span>
                                             <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">is_any</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">input_attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">output_attributes</span><span class="p">:</span>
                <span class="n">key_attribute</span> <span class="o">=</span> <span class="n">attribute</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">key_attribute</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p><code>input</code> and <code>output</code> are matched when the values of their key
attributes are equal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">key_attribute</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">key_attribute</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>For container test cases, returns a set of test suites that belong
to the test case; otherwise returns an empty set.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_suites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>Print values to the standard output stream.</p>
<p>:meth:<code>out</code> supports the same options as
:meth:<code>htsql.ctl.script.Script.out</code> and an extra option:</p>
<p><code>indent</code>
<pre>A number of spaces to print before the first value,
default is <code>0</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">indent</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;indent&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">indent</span><span class="o">-</span><span class="mi">1</span><span class="p">),)</span> <span class="o">+</span> <span class="n">values</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p>If the test case is in the quiet mode, redirect the output
to <code>quiet_buffer</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quiet</span> <span class="ow">and</span> <span class="s">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet_buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">ctl</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p></pre>Asks the user a question; returns the reply.</p>
<p><code>message</code> (a string)
<pre>The question.
</pre>
<code>choices</code> (a list of strings)
The list of valid replies.</p>
<p>Typically the question has the form::</p>
<p>Press ENTER to perform <the default action>,
<pre>'x'+ENTER to perform <another action>,
'y'+ENTER to perform <another action>,
'z'+ENTER to perform <another action>.
</pre>
In this case, <code>choices</code> should be equal to::</p>
<p>['', 'x', 'y', 'z']</p>
<p>The reply is stripped of leading and trailing whitespaces
and translated to the lower case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">choices</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p>Leave the quiet mode and print the question.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">force_out</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        <p>Repeat till we get a valid answer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">line</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;&gt; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">ctl</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">line</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        <p>Ask if the user wants to halt the tests.</p>
<p>Returns <code>DO_HALT</code> or <code>DO_CONTINUE</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">ask_halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&quot;Press ENTER to halt,&quot;</span>
                        <span class="s">&quot; &#39;c&#39;+ENTER to continue&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_HALT</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_CONTINUE</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Ask if the user wants to remember the new output of a test case.</p>
<p>Returns <code>DO_RECORD</code>, <code>DO_SKIP</code>, or <code>DO_HALT</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">ask_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&quot;Press ENTER to record,&quot;</span>
                        <span class="s">&quot; &#39;s&#39;+ENTER to skip,&quot;</span>
                        <span class="s">&quot; &#39;h&#39;+ENTER to halt&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_RECORD</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_SKIP</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;h&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_HALT</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        <p>Ask if the user wants to save the updated output data.</p>
<p>Returns <code>DO_SAVE</code> or <code>DO_DISCARD</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">ask_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s">&quot;Press ENTER to save changes,&quot;</span>
                        <span class="s">&quot; &#39;d&#39;+ENTER to discard changes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_SAVE</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DO_DISCARD</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>Prints an exception traceback.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">out_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        <p>Obey the quiet mode: redirect to <code>quiet_buffer</code> if necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quiet</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet_buffer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">ctl</span><span class="o">.</span><span class="n">stdout</span>

        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">exc_info</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">,</span>
                                  <span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        <p>Prints a separator: a long line of dashes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">out_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">72</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">sep</span><span class="o">*</span><span class="n">length</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        <p>Prints a nice header describing the test case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">out_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        <h2>Print:</h2>
<p>{NAME} {value}
  ({input.location})
where {value} is the value of the first field of the input data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">out_sep</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">fields</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_any</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attribute</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">value</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        <p>Indicate that the test case failed and stop the tests.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">halted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">force_out</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_exiting</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Indicate that the test case failed; stop the tests unless
<code>--force</code> or <code>--train</code> flags are set.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">force_out</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">failed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">train</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_exiting</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        <p>Indicate that the output of the test case has been updated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">force_out</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">updated</span> <span class="o">+=</span> <span class="mi">1</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        <p>Indicate that the test case passed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">passed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">passed</span> <span class="o">+=</span> <span class="mi">1</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">force_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        <p>Leave the quiet mode; flush the content of <code>quiet_buffer</code>
to the standard output stream.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quiet</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_quiet</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">ctl</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">ctl</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        <p>Executes the test case.</p>
<p>This method runs the test case with the given input data.
If the test completed without errors, compare the produced
output with the given expected output.</p>
<p>The test case fails if</p>
<ul>
<li>the test failed to complete without errors;</li>
<li>or the expected test output is not provided;</li>
<li>or the expected test output is not equal to the actual test output.</li>
</ul>
<p>Some test cases may not generate output; in this case the test
passes if it is completed without errors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        <p>Override when subclassing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="n">ScriptError</span><span class="p">(</span><span class="s">&quot;test </span><span class="si">%r</span><span class="s"> is not implemented&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        <p>Executes the test case in the training mode; returns the output data.</p>
<p>In the train mode, when the expected test output is not equal to the
actual test output, the user is given a choice to update the expected
test output.</p>
<p>Note that when the output has not been changed or the user refused
to update it, the method must return the original output data,
<code>self.output</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        <p>Override when subclassing if the test case requires test output data.
Otherwise, just run the test case in the normal mode.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        <p>Implements a skippable test case.</p>
<p>This is an abstract mixin class; subclasses should call :meth:<code>skipped</code>
to check if the test case is enabled or not.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">SkipTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">TestData</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;skip&#39;</span><span class="p">,</span> <span class="n">BoolVal</span><span class="p">(),</span> <span class="bp">False</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;do not run the test&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ifdef&#39;</span><span class="p">,</span> <span class="n">SeqVal</span><span class="p">(</span><span class="n">StrVal</span><span class="p">()),</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;run only if a given toggle is active&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ifndef&#39;</span><span class="p">,</span> <span class="n">SeqVal</span><span class="p">(</span><span class="n">StrVal</span><span class="p">()),</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;run only if a given toggle is inactive&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        <p>Checks if the test is disabled.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">skipped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        <p>Verify if the test is unconditionally disabled.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        <p>If a positive guard is set, check that at least one of the required
toggles is active.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ifdef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">toggles</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ifdef</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>If a negative guard is set, check that none of the suppressed
toggles is active.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ifndef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">toggles</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ifndef</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>The test is not skipped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        <p>Activates a named toggle.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">DefineTestCase</span><span class="p">(</span><span class="n">SkipTestCase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('define', SeqVal(StrVal()),
hint="""activate the given toggles"""),
] + SkipTestCase.Input.fields
</pre>
def verify(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return</p>
<h1>Activates the toggles.</h1>
<p>for toggle in self.input.define:
self.state.toggles.add(toggle)</p>
<p>class RunAndCompareTestCase(SkipTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;define&quot;</span>
    <span class="n">hint</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;activates a toggle&quot;&quot;&quot;</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    This test case activates a toggle variable.  A toggle allows one</span>
<span class="s">    to conditionally enable or disable some test cases using `ifdef`</span>
<span class="s">    and `ifndef` directives.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Implements common methods for a broad category of test cases.</span>

<span class="s">    This class implements common scenario: run the test, get the output</span>
<span class="s">    and compare it with the expected output.</span>

<span class="s">    This is an abstract class; create a subclass to implement a concrete</span>
<span class="s">    test case.  The following methods has to be overridden: :meth:`execute`,</span>
<span class="s">    :meth:`render` and :meth:`differs`.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Prints the lines with the specified identation.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Prints the delta between two test outputs.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Converts the output data to a list of lines.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Runs the test case; returns the produced output.</span>

<span class="s">        Returns ``None`` if an error occured when running the test case.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Checks if the actual test output differs from the expected test output.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Configures the HTSQL application.</span>
<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Input(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;db&#39;, DBVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">connection</span> <span class="n">URI</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;extensions&#39;, MapVal(StrVal(),</span>
<span class="s">                                           MapVal(StrVal(), AnyVal())),</span>
<span class="s">                      default=[],</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">include</span> <span class="n">extra</span> <span class="n">extensions</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ] + SkipTestCase.Input.fields</span>


<span class="s">#DIVIDER</span>
<span class="s">    def out_header(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        db = self.input.db</span>
<span class="s">        sanitized_db = DB(engine=db.engine,</span>
<span class="s">                          username=db.username,</span>
<span class="s">                          password=None,</span>
<span class="s">                          host=db.host,</span>
<span class="s">                          port=db.port,</span>
<span class="s">                          database=db.database,</span>
<span class="s">                          options=db.options)</span>


<span class="s">#DIVIDER</span>
<span class="s">        self.out_sep()</span>
<span class="s">        self.out(&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot; % (self.name.upper(), sanitized_db), indent=2)</span>
<span class="s">        if self.input.location is not None:</span>
<span class="s">            self.out(&quot;(</span><span class="si">%s</span><span class="s">)&quot; </span><span class="si">% s</span><span class="s">elf.input.location, indent=2)</span>


<span class="s">#DIVIDER</span>
<span class="s">    def verify(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">        if self.skipped():</span>
<span class="s">            return</span>


<span class="s">#DIVIDER</span>
<span class="s">        self.out_header()</span>


<span class="s">#DIVIDER</span>
<span class="s">        from htsql.application import Application</span>
<span class="s">        self.state.app = None</span>
<span class="s">        try:</span>
<span class="s">            self.state.app = Application(self.input.db,</span>
<span class="s">                                         *self.input.extensions)</span>
<span class="s">        except Exception:</span>
<span class="s">            self.out_exception(sys.exc_info())</span>
<span class="s">            return self.failed(&quot;*** an exception occured while&quot;</span>
<span class="s">                               &quot; initializing an HTSQL application&quot;)</span>

<span class="s">        return self.passed()</span>



<span class="s">#DIVIDER</span>
<span class="s">class IncludeTestCase(SkipTestCase):</span>
<span class="s">#DIVIDER</span>

<span class="s">    name = &quot;include&quot;</span>
<span class="s">    hint = &quot;&quot;&quot;</span><span class="n">load</span> <span class="nb">input</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">a</span><span class="err"> </span><span class="nn">file</span><span class="err">&quot;&quot;&quot;</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    This test case allows you to execute a test case or a test suite defined</span>
<span class="s">    in a separate file.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Implements a container of test cases.</span>
<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Input(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;title&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">description</span> <span class="n">of</span> <span class="n">the</span> <span class="n">suite</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;id&#39;, StrVal(), None,</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">code</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">suite</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;output&#39;, StrVal(), None,</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="nb">file</span> <span class="n">to</span> <span class="n">save</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">the</span> <span class="n">tests</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;tests&#39;, SeqVal(ClassVal(TestData)),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">test</span> <span class="n">inputs</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ] + SkipTestCase.Input.fields</span>


<span class="s">#DIVIDER</span>
<span class="s">        def init_attributes(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">            if self.id is None:</span>
<span class="s">                self.id = self.title.lower().replace(&#39; &#39;, &#39;-&#39;)</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Output(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;id&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">code</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">suite</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;tests&#39;, SeqVal(ClassVal(TestData)),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">test</span> <span class="n">outputs</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ]</span>


<span class="s">#DIVIDER</span>
<span class="s">    def __init__(self, routine, state, input, output):</span>
<span class="s">        super(SuiteTestCase, self).__init__(routine, state, input, output)</span>


<span class="s">#DIVIDER</span>
<span class="s">        self.ext_output = None</span>
<span class="s">        if input.output is not None and os.path.exists(input.output):</span>
<span class="s">            ext_output = routine.load_output(input.output)</span>
<span class="s">            if self.matches(input, ext_output):</span>
<span class="s">                self.ext_output = ext_output</span>


<span class="s">#DIVIDER</span>
<span class="s">        self.cases = []</span>
<span class="s">        self.cases_state = TestState()</span>
<span class="s">        self.init_cases()</span>


<span class="s">#DIVIDER</span>
<span class="s">    def init_cases(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        pairs = []</span>


<span class="s">#DIVIDER</span>
<span class="s">        available_outputs = []</span>
<span class="s">        if self.ext_output is not None:</span>
<span class="s">            available_outputs = self.ext_output.tests[:]</span>
<span class="s">        elif self.output is not None:</span>
<span class="s">            available_outputs = self.output.tests[:]</span>


<span class="s">#DIVIDER</span>
<span class="s">        for input in self.input.tests:</span>
<span class="s">            case_class = input.case_class</span>
<span class="s">            for idx, output in enumerate(available_outputs):</span>
<span class="s">                if case_class.matches(input, output):</span>
<span class="s">                    pairs.append((input, output))</span>
<span class="s">                    del available_outputs[idx]</span>
<span class="s">                    break</span>
<span class="s">            else:</span>
<span class="s">                pairs.append((input, None))</span>


<span class="s">#DIVIDER</span>
<span class="s">        for input, output in pairs:</span>
<span class="s">            case_class = input.case_class</span>
<span class="s">            case = case_class(self.routine, self.cases_state, input, output)</span>
<span class="s">            self.cases.append(case)</span>


<span class="s">#DIVIDER</span>
<span class="s">    def get_suites(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">        suites = set([self.input.id])</span>
<span class="s">        for case in self.cases:</span>
<span class="s">            suites |= case.get_suites()</span>
<span class="s">        return suites</span>


<span class="s">#DIVIDER</span>
<span class="s">    def out_header(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.out_sep(&quot;=&quot;)</span>
<span class="s">        self.out(self.input.title, indent=2)</span>
<span class="s">        if self.input.location is not None:</span>
<span class="s">            self.out(&quot;(</span><span class="si">%s</span><span class="s">)&quot; </span><span class="si">% s</span><span class="s">elf.input.location, indent=2)</span>


<span class="s">#DIVIDER</span>
<span class="s">    def skipped(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        if super(SuiteTestCase, self).skipped():</span>
<span class="s">            return True</span>


<span class="s">#DIVIDER</span>
<span class="s">        if not self.routine.suites:</span>
<span class="s">            return False</span>
<span class="s">        if self.state.with_all_suites:</span>
<span class="s">            return False</span>
<span class="s">        if self.input.id in self.routine.suites:</span>
<span class="s">            self.cases_state.with_all_suites = True</span>
<span class="s">            return False</span>
<span class="s">        if self.get_suites() &amp; set(self.routine.suites):</span>
<span class="s">            return False</span>
<span class="s">        return True</span>


<span class="s">#DIVIDER</span>
<span class="s">    def verify(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        self.state.push(self.cases_state)</span>

<span class="s">#DIVIDER</span>
<span class="s">        if self.skipped():</span>
<span class="s">            return</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.out_header()</span>

<span class="s">#DIVIDER</span>
<span class="s">        for case in self.cases:</span>
<span class="s">            case.verify()</span>

<span class="s">#DIVIDER</span>
<span class="s">            if self.cases_state.is_exiting:</span>
<span class="s">                break</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.state.pull(self.cases_state)</span>


<span class="s">#DIVIDER</span>
<span class="s">    def train(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        self.state.push(self.cases_state)</span>

<span class="s">#DIVIDER</span>
<span class="s">        if self.skipped():</span>
<span class="s">            return self.output</span>

<span class="s">#DIVIDER</span>
<span class="s">        new_output_by_case = {}</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.out_header()</span>

<span class="s">#DIVIDER</span>
<span class="s">        for case in self.cases:</span>
<span class="s">            new_output = case.train()</span>

<span class="s">#DIVIDER</span>
<span class="s">            if new_output is not case.output:</span>
<span class="s">                new_output_by_case[case] = new_output</span>

<span class="s">#DIVIDER</span>
<span class="s">            if self.cases_state.is_exiting:</span>
<span class="s">                break</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.state.pull(self.cases_state)</span>

<span class="s">#DIVIDER</span>
<span class="s">        output = self.make_output(new_output_by_case)</span>

<span class="s">#DIVIDER</span>
<span class="s">        if self.input.output is not None:</span>

<span class="s">#DIVIDER</span>
<span class="s">            if output is not self.ext_output:</span>
<span class="s">                self.out_sep()</span>
<span class="s">                reply = self.ask_save()</span>
<span class="s">                if reply is DO_DISCARD:</span>

<span class="s">#DIVIDER</span>
<span class="s">                    return self.output</span>
<span class="s">                self.out(&quot;*** saving test output data to </span><span class="si">%r</span><span class="s">&quot;</span>
<span class="s">                         </span><span class="si">% s</span><span class="s">elf.input.output)</span>
<span class="s">                self.routine.save_output(self.input.output, output)</span>

<span class="s">#DIVIDER</span>
<span class="s">            return None</span>
<span class="s">        return output</span>


<span class="s">#DIVIDER</span>
<span class="s">    def make_output(self, new_output_by_case):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        </span>

<span class="s">#DIVIDER</span>
<span class="s">        tests = []</span>


<span class="s">#DIVIDER</span>
<span class="s">        if self.output is not None:</span>
<span class="s">            tests = self.output.tests[:]</span>
<span class="s">        if self.ext_output is not None:</span>
<span class="s">            tests = self.ext_output.tests[:]</span>


<span class="s">#DIVIDER</span>
<span class="s">        if self.routine.purge and not self.state.is_exiting:</span>
<span class="s">            tests = []</span>
<span class="s">            for case in self.cases:</span>
<span class="s">                output = case.output</span>
<span class="s">                if case in new_output_by_case:</span>
<span class="s">                    output = new_output_by_case[case]</span>
<span class="s">                if output is not None:</span>
<span class="s">                    tests.append(output)</span>


<span class="s">#DIVIDER</span>
<span class="s">        elif new_output_by_case:</span>


<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">            next_idx = 0</span>
<span class="s">            for case in self.cases:</span>

<span class="s">#DIVIDER</span>
<span class="s">                if case in new_output_by_case:</span>
<span class="s">                    new_output = new_output_by_case[case]</span>

<span class="s">#DIVIDER</span>
<span class="s">                    if new_output is not None:</span>

<span class="s">#DIVIDER</span>
<span class="s">                        if case.output in tests:</span>
<span class="s">                            idx = tests.index(case.output)</span>
<span class="s">                            tests[idx] = new_output</span>
<span class="s">                            if idx &gt;= next_idx:</span>
<span class="s">                                next_idx = idx+1</span>

<span class="s">#DIVIDER</span>
<span class="s">                        else:</span>
<span class="s">                            tests.insert(next_idx, new_output)</span>
<span class="s">                            next_idx += 1</span>


<span class="s">#DIVIDER</span>
<span class="s">                else:</span>

<span class="s">#DIVIDER</span>
<span class="s">                    if case.output in tests:</span>
<span class="s">                        idx = tests.index(case.output)</span>
<span class="s">                        if idx &gt;= next_idx:</span>
<span class="s">                            next_idx = idx+1</span>


<span class="s">#DIVIDER</span>
<span class="s">        if not tests:</span>
<span class="s">            return None</span>


<span class="s">#DIVIDER</span>
<span class="s">        if self.input.output is not None:</span>
<span class="s">            if self.ext_output is not None and self.ext_output.tests == tests:</span>
<span class="s">                return self.ext_output</span>
<span class="s">        else:</span>
<span class="s">            if self.output is not None and self.output.tests == tests:</span>
<span class="s">                return self.output</span>


<span class="s">#DIVIDER</span>
<span class="s">        output = super(SuiteTestCase, self).make_output(id=self.input.id,</span>
<span class="s">                                                        tests=tests)</span>
<span class="s">        return output</span>



<span class="s">#DIVIDER</span>
<span class="s">class QueryTestCase(RunAndCompareTestCase):</span>
<span class="s">#DIVIDER</span>

<span class="s">    name = &quot;query&quot;</span>
<span class="s">    hint = &quot;&quot;&quot;</span><span class="n">execute</span> <span class="n">an</span> <span class="n">HTSQL</span> <span class="n">query</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    help = &quot;&quot;&quot;</span>
    <span class="n">This</span> <span class="n">test</span> <span class="n">case</span> <span class="n">executes</span> <span class="n">an</span> <span class="n">HTSQL</span> <span class="n">query</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        <p>def out_lines(self, lines, indent=0):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">Executes</span> <span class="n">a</span> <span class="n">script</span> <span class="n">routine</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        <p>for line in lines:
<pre># If <code>line</code> is UTF-8 encoded, print it literally;</p>
<h1>otherwise, replace special and non-ASCII characters</h1>
<h1>with dots.</h1>
<p>try:
line.decode('utf-8')
except UnicodeDecodeError:
line = re.sub(r'[x00-x1Fx7E-xFF]', '.', line)
self.out(line.rstrip(), indent=indent)
</pre>
def out_diff(self, old_output, new_output):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <h1>Sanity check on the arguments.</h1>
<p>assert isinstance(old_output, maybe(self.Output))
assert isinstance(new_output, self.Output)</p>
<h1>Render the outputs to the lists of lines.</h1>
<p>old_lines = self.render(old_output)
new_lines = self.render(new_output)</p>
<h1>This function is supposed to be called in two cases:</h1>
<h1>when there is no expected output, but only the actual output,</h1>
<h1>and when the expected output differs from the actual output.</h1>
<h1>However it may also happen that the function is called with</h1>
<h1>two identical outputs, or that the <code>render</code> method hides</h1>
<h1>the difference.</h1>
<p>if old_lines is None:
<pre>self.out("=== the test output is new")
elif old_lines != new_lines:
self.out("=== the test output is changed")
else:
self.out("=== the test output is not changed")
self.out()
</pre></p>
<h1>Display the actual output if there is no expected output;</h1>
<h1>otherwise display the delta between the expected and the actual</h1>
<h1>output in the unified diff format.</h1>
<p>if old_lines is None or old_lines == new_lines:
lines = new_lines
else:
diff = difflib.unified_diff(old_lines, new_lines,
<pre>n=2, lineterm='')</p>
<h1>Strip the leading <code>---</code> and <code>+++</code> lines of the unified diff.</h1>
<p>lines = list(diff)[2:]
self.out_lines(lines, indent=2)
</pre>
def render(self, output):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">TestData</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ctl&#39;</span><span class="p">,</span> <span class="n">SeqVal</span><span class="p">(</span><span class="n">StrVal</span><span class="p">()),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;a list of command-line parameters&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;stdin&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the content of the standard input&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;expect&#39;</span><span class="p">,</span> <span class="n">IntVal</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the exit code to expect&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">BoolVal</span><span class="p">(),</span> <span class="bp">False</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;ignore the exit code and the standard output&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">SkipTestCase</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">fields</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        <h1>Override when subclassing.</h1>
<p>raise NotImplementedError()</p>
<p>def execute(self):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Output</span><span class="p">(</span><span class="n">TestData</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ctl&#39;</span><span class="p">,</span> <span class="n">SeqVal</span><span class="p">(</span><span class="n">StrVal</span><span class="p">()),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;a list of command-line parameters&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the content of the standard output&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;exit&#39;</span><span class="p">,</span> <span class="n">IntVal</span><span class="p">(),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the exit code&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        <h1>Override when subclassing.</h1>
<p>raise NotImplementedError()</p>
<p>def differs(self, old_output, new_output):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">out_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        <h1>Override when subclassing.</h1>
<p>raise NotImplementedError()</p>
<p>def verify(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
<pre>return
</pre></p>
<h1>Display the header.</h1>
<p>self.out_header()</p>
<h1>When no expected test output, fail without executing the test.</h1>
<p>if self.output is None:
return self.failed("*** no output data found")</p>
<h1>Execute the test; get the actual test output.</h1>
<p>new_output = self.execute()</p>
<h1><code>None</code> indicates that an error occurred; <code>execute()</code> is responsible</h1>
<h1>for displaying an error message, so we just update the status and</h1>
<h1>exit.</h1>
<p>if new_output is None:
return self.failed()</p>
<h1>Compare the expected and the actual outputs, fail if they are</h1>
<h1>different.</h1>
<p>if self.differs(self.output, new_output):
self.out_diff(self.output, new_output)
return self.failed("*** unexpected test output")</p>
<h1>The actual output coincides with the expected output; we are good.</h1>
<p>return self.passed()</p>
<p>def train(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return self.output</p>
<h1>Display the header.</h1>
<p>self.out_header()</p>
<h1>Execute the test; get the actual test output.</h1>
<p>new_output = self.execute()</p>
<h1>We need to handle three possible outcomes: an error occurred</h1>
<h1>when running the test, the expected output differs from the</h1>
<h1>actual output and the expected output coincides with the actual</h1>
<h1>output.</h1>
<h1>An error occurred while running the test.</h1>
<p>if new_output is None:</p>
<h1>Ask the user if they want to stop the testing; the expected</h1>
<h1>output is not updated.</h1>
<p>reply = self.ask_halt()
if reply is DO_HALT:
<pre>self.halted("*** halting")
else:
self.failed()
return self.output
</pre></p>
<h1>The actual output differs from the expected output.</h1>
<p>if self.differs(self.output, new_output):</p>
<h1>Display the difference.</h1>
<p>self.out_diff(self.output, new_output)</p>
<h1>Ask the user if they want to record the new output,</h1>
<h1>keep the old output, or halt the testing.</h1>
<p>reply = self.ask_record()
if reply is DO_HALT:
self.halted("<strong><em> halting")
return self.output
if reply is DO_RECORD:
if self.output is None:
<pre>self.updated("</em></strong> recording new test output")
else:
self.updated("*** recording updated test output")
return new_output
self.failed()
return self.output
</pre></p>
<h1>The actual output coincides with the expected output; note that</h1>
<h1>the caller checks if <code>case.train() is case.output</code> to learn</h1>
<h1>if the output is updated.</h1>
<p>self.passed()
return self.output</p>
<p>class AppTestCase(SkipTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">out_sep</span><span class="p">()</span>
        <span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">executable</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ctl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        <p>name = "app"
hint = """configure the HTSQL application"""
help = """
To run HTSQL requests, the testing engine needs to create an HTSQL
application.  This test case allows you to configure the application
parameters.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">differs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_output</span><span class="p">,</span> <span class="n">new_output</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">old_output</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">new_output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_output</span><span class="o">.</span><span class="n">exit</span> <span class="o">!=</span> <span class="n">new_output</span><span class="o">.</span><span class="n">exit</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">old_output</span><span class="o">.</span><span class="n">stdout</span> <span class="o">!=</span> <span class="n">new_output</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        <p>Overriden to avoid printing the password to the database.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        <p>Clone <code>input.db</code>, but omit the password.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <h2>Print:</h2>
<p>APP {sanitized_db}
  ({input.location})</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">stdout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">stdout</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="n">TermStringIO</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
        <span class="n">command_line</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ctl</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ctl_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routine</span><span class="o">.</span><span class="n">ctl</span><span class="o">.</span><span class="n">__class__</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        <p>Check if the test is skipped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">ctl</span> <span class="o">=</span> <span class="n">ctl_class</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="nb">exit</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">command_line</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;*** an exception occured&quot;</span>
                            <span class="s">&quot; while running the application&quot;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        <p>Display the header.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">exit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">exit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">exit</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">exit</span><span class="p">))</span>
            <span class="nb">exit</span> <span class="o">=</span> <span class="mi">1</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        <p>Create an application and update the testing state.  The created
application will be in effect for the subsequent tests in the
current suite and all the nested suites unless overridden.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">new_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_output</span><span class="p">(</span><span class="n">ctl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ctl</span><span class="p">,</span>
                                      <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
                                      <span class="nb">exit</span><span class="o">=</span><span class="nb">exit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        <p>Loads input test data from a file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_output</span><span class="o">.</span><span class="n">exit</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">expect</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">new_output</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;*** unexpected exit code: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">exit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_output</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('include', StrVal(),
hint="""file containing input test data"""),
] + SkipTestCase.Input.fields
</pre>
class Output(TestData):
fields = [
Field('include', StrVal(),
hint="""file containing input test data"""),
Field('output', ClassVal(TestData),
hint="""the corresponding output test data"""),
]</p>
<p>def <strong>init</strong>(self, routine, state, input, output):
super(IncludeTestCase, self).<strong>init</strong>(routine, state, input, output)</p>
<h1>Load the input data and create the corresponding test case.</h1>
<p>self.included_input = routine.load_input(self.input.include)
case_class = self.included_input.case_class
self.included_output = None
if self.output is not None:
if case_class.matches(self.included_input, self.output.output):
self.included_output = self.output.output
self.case = case_class(routine, state,
<pre>self.included_input,
self.included_output)
</pre>
def get_suites(self):</p>
<h1>Get the set of nested suites.</h1>
<p>return self.case.get_suites()</p>
<p>def verify(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return</p>
<h1>Run the included test.</h1>
<p>self.case.verify()</p>
<p>def train(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return self.output</p>
<h1>Run the included test; get the output.</h1>
<p>new_output = self.case.train()</p>
<h1>Three outcomes are possible: the test generated no output, in this</h1>
<h1>case we don't need to create an output record either; the test</h1>
<h1>generated new or updated output, we have to update our output as</h1>
<h1>well; and finally, the test output didn't change, we could keep</h1>
<h1>ours too.</h1>
<p>if new_output is None:
output = None
elif new_output is not self.included_output:
output = self.make_output(include=self.input.include,
<pre>output=new_output)
else:
output = self.output
return output
</pre></p>
<p>class SuiteTestCase(SkipTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Fork</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        <p>name = "suite"
hint = """contains other test cases"""
help = """
A test suite is a container of test cases.  Typically, it is the
top-level test case in a test file.</p>
<p>The testing engine allows you to specify what suites to run by their
ids.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">active_forks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_atexit_registered</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">temp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/input&quot;</span> <span class="o">%</span> <span class="n">temp_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">stdin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/input&quot;</span> <span class="o">%</span> <span class="n">temp_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/output&quot;</span> <span class="o">%</span> <span class="n">temp_path</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        <p>When <code>id</code> is not specified, generate it from the title.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">executable</span><span class="p">]</span><span class="o">+</span><span class="n">arguments</span><span class="p">,</span>
                                       <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
                                       <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                       <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            <span class="k">raise</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">)</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">atexit</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        <p>A test suite has an ability to save its test output to a separate
file.  In this case, <code>self.ext_output</code> contains the test data
loaded from the file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">fork</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">active_forks</span><span class="p">:</span>
            <span class="n">fork</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>Generate a list of test cases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">atexit_register</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="o">.</span><span class="n">is_atexit_registered</span><span class="p">:</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">atexit</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">is_atexit_registered</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        <p>Generate a list of test cases.  We have two independent lists:
one containing input test records and the other containing
output test records.  Our goal is to find matching pairs and
generate the corresponding test cases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        <p>The matching pairs of input and output data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span> <span class="o">=</span> <span class="n">temp_path</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        <p>List of available output records.  We need to copy it since
it is going to be modified.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">active_forks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        <p>For each input record, find the matching output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">atexit_register</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        <p>Initialize the test cases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        <p>Get a set of (this and) the nested suites.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/output&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        <h1>Print the header:</h1>
<p>{input.title}
  ({input.location})</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">active_forks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        <p>Check if the suite should not be executed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">StartCtlTestCase</span><span class="p">(</span><span class="n">SkipTestCase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        <p>Check if the test case was explicitly disabled.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;start-ctl&quot;</span>
    <span class="n">hint</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;execute a long-running routine&quot;&quot;&quot;</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    This test case starts a long-running the HTSQL command-line</span>
<span class="s">    application.  Use the `end-ctl` test case to finalize the application</span>
<span class="s">    and check the output.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Terminates a long-running routine.</span>
<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Input(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;end_ctl&#39;, SeqVal(StrVal()),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">command</span><span class="o">-</span><span class="n">line</span> <span class="n">parameters</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;ignore&#39;, BoolVal(), False,</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">ignore</span> <span class="n">the</span> <span class="nb">exit</span> <span class="n">code</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">output</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ] + SkipTestCase.Input.fields</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Output(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;end_ctl&#39;, SeqVal(StrVal()),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">command</span><span class="o">-</span><span class="n">line</span> <span class="n">parameters</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;stdout&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">ignore</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">output</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ]</span>


<span class="s">#DIVIDER</span>
<span class="s">    def differs(self, old_output, new_output):</span>

<span class="s">#DIVIDER</span>
<span class="s">        if old_output is None or new_output is None:</span>
<span class="s">            return True</span>
<span class="s">        if not self.input.ignore:</span>
<span class="s">            if old_output.stdout != new_output.stdout:</span>
<span class="s">                return True</span>
<span class="s">        return False</span>


<span class="s">#DIVIDER</span>
<span class="s">    def render(self, output):</span>

<span class="s">#DIVIDER</span>
<span class="s">        if output is None:</span>
<span class="s">            return None</span>
<span class="s">        return output.stdout.splitlines()</span>


<span class="s">#DIVIDER</span>
<span class="s">    def execute(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        key = tuple(self.input.end_ctl)</span>
<span class="s">        if key not in self.state.forks:</span>
<span class="s">            return self.out(&quot;*** the application has not been started&quot;)</span>
<span class="s">        fork = self.state.forks.pop(key)</span>


<span class="s">#DIVIDER</span>
<span class="s">        stdout = fork.end()</span>


<span class="s">#DIVIDER</span>
<span class="s">        new_output = self.make_output(end_ctl=self.input.end_ctl,</span>
<span class="s">                                      stdout=stdout)</span>
<span class="s">        return new_output</span>



<span class="s">#DIVIDER</span>
<span class="s">class PythonCodeTestCase(RunAndCompareTestCase):</span>
<span class="s">#DIVIDER</span>

<span class="s">    name = &quot;python&quot;</span>
<span class="s">    hint = &quot;&quot;&quot;</span><span class="n">execute</span> <span class="n">Python</span> <span class="n">code</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    help = &quot;&quot;&quot;</span>
    <span class="n">This</span> <span class="n">test</span> <span class="n">case</span> <span class="n">allows</span> <span class="n">you</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">arbitrary</span> <span class="n">Python</span> <span class="n">code</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        <p>The suite is skipped when:
- the user specified an explicit list of the suites to run;
- and the suite is not one of them;
- and the suite does not contain any selected nested suite;
- and the suite is not nested in some selected suite.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">Executes</span> <span class="n">arbitrary</span> <span class="n">Python</span> <span class="n">code</span> <span class="n">loaded</span> <span class="kn">from</span> <span class="nn">a</span><span class="err"> </span><span class="nn">file.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        <p>Run the suite.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">TestData</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;py_include&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the file containing Python code&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;stdin&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the content of the standard input&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;expect&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span> <span class="bp">None</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the name of an exception to expect&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">BoolVal</span><span class="p">(),</span> <span class="bp">False</span><span class="p">,</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;ignore the standard output&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">SkipTestCase</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">fields</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        <p>Push the current state to the cases state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Output</span><span class="p">(</span><span class="n">TestData</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;py_include&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the file containing Python code&quot;&quot;&quot;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the content of the standard output&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>Check if the suite is disabled or if the user specified
the suites to run and this one is not among them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        <p>Display the headers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">py_include</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">code</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        <p>Run the nested test cases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">SQLTestCase</span><span class="p">(</span><span class="n">SkipTestCase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>Check if the user asked to halt the testing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sql&quot;</span>
    <span class="n">hint</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;execute a SQL statement&quot;&quot;&quot;</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    This test case executes one or multiple SQL statements.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Returns the SQL data to execute.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Loads SQL queries from a file and executes them.</span>
<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Input(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;connect&#39;, DBVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">connection</span> <span class="n">URI</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;sql_include&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="nb">file</span> <span class="n">containing</span> <span class="n">SQL</span> <span class="n">statements</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;autocommit&#39;, BoolVal(), False,</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">use</span> <span class="n">the</span> <span class="n">auto</span><span class="o">-</span><span class="n">commit</span> <span class="n">mode</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;ignore&#39;, BoolVal(), False,</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">ignore</span> <span class="nb">any</span> <span class="n">errors</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ] + SkipTestCase.Input.fields</span>


<span class="s">#DIVIDER</span>
<span class="s">    def out_header(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.out_sep()</span>
<span class="s">        self.out(&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot; % (self.name.upper(), self.input.sql_include),</span>
<span class="s">                 indent=2)</span>
<span class="s">        if self.input.location is not None:</span>
<span class="s">            self.out(&quot;(</span><span class="si">%s</span><span class="s">)&quot; </span><span class="si">% s</span><span class="s">elf.input.location, indent=2)</span>


<span class="s">#DIVIDER</span>
<span class="s">    def load(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">        stream = open(self.input.sql_include, &#39;rb&#39;)</span>
<span class="s">        sql = stream.read()</span>
<span class="s">        stream.close()</span>
<span class="s">        return sql</span>



<span class="s">#DIVIDER</span>
<span class="s">class WriteToFileTestCase(SkipTestCase):</span>
<span class="s">#DIVIDER</span>

<span class="s">    name = &quot;write-to-file&quot;</span>
<span class="s">    hint = &quot;&quot;&quot;</span><span class="n">write</span> <span class="n">some</span> <span class="n">data</span> <span class="n">to</span> <span class="n">a</span> <span class="nb">file</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    help = None</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Input(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;write&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="nb">file</span> <span class="n">name</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;data&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">write</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ] + SkipTestCase.Input.fields</span>


<span class="s">#DIVIDER</span>
<span class="s">    def verify(self):</span>

<span class="s">#DIVIDER</span>
<span class="s">        if self.skipped():</span>
<span class="s">            return</span>

<span class="s">#DIVIDER</span>
<span class="s">        self.out_header()</span>

<span class="s">#DIVIDER</span>
<span class="s">        stream = open(input.write, &#39;wb&#39;)</span>
<span class="s">        stream.write(input.data)</span>
<span class="s">        stream.close()</span>



<span class="s">#DIVIDER</span>
<span class="s">class ReadFromFileTestCase(RunAndCompareTestCase):</span>
<span class="s">#DIVIDER</span>

<span class="s">    name = &quot;read-from-file&quot;</span>
<span class="s">    hint = &quot;&quot;&quot;</span><span class="n">read</span> <span class="n">the</span> <span class="n">content</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">file</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    help = None</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Input(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;read&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="nb">file</span> <span class="n">name</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ] + SkipTestCase.Input.fields</span>


<span class="s">#DIVIDER</span>
<span class="s">    class Output(TestData):</span>
<span class="s">        fields = [</span>
<span class="s">                Field(&#39;read&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="nb">file</span> <span class="n">name</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">                Field(&#39;data&#39;, StrVal(),</span>
<span class="s">                      hint=&quot;&quot;&quot;</span><span class="n">the</span> <span class="n">content</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">file</span><span class="s">&quot;&quot;&quot;),</span>
<span class="s">        ]</span>


<span class="s">#DIVIDER</span>
<span class="s">    def differs(self, old_output, new_output):</span>

<span class="s">#DIVIDER</span>
<span class="s">        if old_output is None or new_output is None:</span>
<span class="s">            return True</span>
<span class="s">        return (old_output.data != new_output.data)</span>


<span class="s">#DIVIDER</span>
<span class="s">    def render(self, output):</span>

<span class="s">#DIVIDER</span>
<span class="s">        if output is None:</span>
<span class="s">            return None</span>
<span class="s">        return output.data.splitlines()</span>


<span class="s">#DIVIDER</span>
<span class="s">    def execute(self):</span>

<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">        if not os.path.exists(self.input.read):</span>
<span class="s">            return self.out(&quot;*** file </span><span class="si">%r</span><span class="s"> does not exist&quot; </span><span class="si">% s</span><span class="s">elf.input.read)</span>


<span class="s">#DIVIDER</span>
<span class="s">        stream = open(self.input.read, &#39;rb&#39;)</span>
<span class="s">        data = stream.read()</span>
<span class="s">        stream.close()</span>
<span class="s">        new_output = self.make_output(read=self.input.read, data=data)</span>
<span class="s">        return new_output</span>



<span class="s">#DIVIDER</span>
<span class="s">class RemoveFilesTestCase(TestCase):</span>
<span class="s">#DIVIDER</span>

<span class="s">    name = &quot;remove-files&quot;</span>
<span class="s">    hint = &quot;&quot;&quot;</span><span class="n">remove</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">files</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    help = &quot;&quot;&quot;</span>
    <span class="n">Remove</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">files</span><span class="o">.</span>  <span class="n">It</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">some</span> <span class="n">of</span> <span class="n">the</span> <span class="n">files</span> <span class="n">do</span> <span class="ow">not</span>
    <span class="n">exist</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        <p>Pull the statistical information from the cases state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">Creates</span> <span class="n">a</span> <span class="n">directory</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        <p>Run the suite; update the test output if necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">TestData</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Field</span><span class="p">(</span><span class="s">&#39;mkdir&#39;</span><span class="p">,</span> <span class="n">StrVal</span><span class="p">(),</span>
                      <span class="n">hint</span><span class="o">=</span><span class="s">&quot;&quot;&quot;the directory name&quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">SkipTestCase</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">fields</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        <p>Push the current state to the cases state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        <p>Check if the suite is disabled or if the user specified
the suites to run and this one is not among them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipped</span><span class="p">():</span>
            <span class="k">return</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        <p>A dictionary containing the output (or <code>None</code>) generated by test
cases when it differs from the existing test output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">out_header</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        <p>Display the header.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">mkdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">mkdir</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        <p>Run the nested tests.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RemoveDirTestCase</span><span class="p">(</span><span class="n">SkipTestCase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        <p>Record modified output data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;remove-dir&quot;</span>
    <span class="n">hint</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;remove a directory&quot;&quot;&quot;</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    Removes a directory with all its content.  It is not an error if the</span>
<span class="s">    directory does not exist.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Keeps the mutable state of the testing process.</span>

<span class="s">    `app`</span>
<span class="s">        The current HTSQL application.</span>

<span class="s">    `forks`</span>
<span class="s">        A mapping from command-line parameters to :class:`Fork`</span>
<span class="s">        instances; contains long-running applications.</span>

<span class="s">    `toggles`</span>
<span class="s">        A set of active named toggles.</span>

<span class="s">    `with_all_suites`</span>
<span class="s">        Indicates that the current suite or one of its ancestors</span>
<span class="s">        was explicitly selected by the user.</span>

<span class="s">    `passed`</span>
<span class="s">        The current number of passed tests.</span>

<span class="s">    `failed`</span>
<span class="s">        The current number of failed tests.</span>

<span class="s">    `updated`</span>
<span class="s">        The current number of updated tests.</span>

<span class="s">    `is_exiting`</span>
<span class="s">        Indicates whether the user asked to halt the testing.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Push the state data to a derived state.</span>

<span class="s">        `other` (:class:`TestState`)</span>
<span class="s">            A derived state, the state created by a suite for</span>
<span class="s">            the suite test cases.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Pull the state from a derived state.</span>

<span class="s">        Note that only statistical information is pulled from</span>
<span class="s">        the derived state.</span>

<span class="s">        `other` (:class:`TestState`)</span>
<span class="s">            A derived state, the state created by a suite for</span>
<span class="s">            the suite test cases.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Loads test data from a YAML file.</span>

<span class="s">    `routine` (:class:`RegressRoutine`)</span>
<span class="s">        The testing engine.</span>

<span class="s">    `with_input` (Boolean)</span>
<span class="s">        Indicates that the YAML file contains input records.</span>

<span class="s">    `with_output` (Boolean)</span>
<span class="s">        Indicates that the YAML file contains output records.</span>

<span class="s">    `stream` (a file or a file-like object)</span>
<span class="s">        The YAML stream.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Loads test data from the YAML stream.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps test data to a YAML file.</span>

<span class="s">    `routine` (:class:`RegressRoutine`)</span>
<span class="s">        The testing engine.</span>

<span class="s">    `with_input` (Boolean)</span>
<span class="s">        Indicates that the YAML file will contain input records.</span>

<span class="s">    `with_output` (Boolean)</span>
<span class="s">        Indicates that the YAML file will contain output records.</span>

<span class="s">    `stream` (a file or a file-like object)</span>
<span class="s">        The stream where the YAML document is written.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Dumps the data to the YAML stream.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Implements the `regress` routine.</span>
<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">    output_help = &quot;&quot;&quot;</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        <p>Check if the user asked to halt the testing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">Returns</span> <span class="n">a</span> <span class="nb">long</span> <span class="n">description</span> <span class="n">of</span> <span class="n">the</span> <span class="n">routine</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        <p>Pull the statistical information from the cases state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">Finds</span> <span class="n">the</span> <span class="n">test</span> <span class="n">case</span> <span class="n">by</span> <span class="n">name</span><span class="o">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>Generate a new output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        <p>The output is kept in a separate file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        <p>If the output has been updated, ask the user if they want
to save it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p><code>self.output</code> may still be not <code>None</code> if the <code>output</code>
field was recently added.  In that case, we don't want
to delete the regular output data until it is saved
to a separate file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        <p>Returning <code>None</code> since the output is saved to a separate file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        <p>Generate the output test data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>Here we update the list of output test records.  Note that the list
may contain some inactive output records.  These output records
do not correspond to any input records and thus have no respective
test case.  It may happen if the user removed or modified the input
data.  Since a test case may be only temporarily disabled, we never
remove inactive output records unless the <code>--purge</code> option is enabled.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        <p>The list of the output records.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-160'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-160">#</a>
        </div>
        <p>Start with the original list of output records.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-161'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-161">#</a>
        </div>
        <p><code>--purge</code> is enabled, we don't have to keep inactive records,
so simply generate the list from scratch.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-162'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-162">#</a>
        </div>
        <p>Some test cases generated new output, so we need to update the list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-163'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-163">#</a>
        </div>
        <p>Here we take the original list of records and replace those
that have been updated.  We may also encounter a new output
record, which has no corresponding old record in the list.
For that new record, we need to find a position in the list.
We want the order of the output records to match the order
of their respective input records, so to ensure this, we
put any new record immediately after all other records processed
so far.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-164'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-164">#</a>
        </div>
        <p>Position to put new records.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-165'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-165">#</a>
        </div>
        <p>The record has been added, removed or updated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-166'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-166">#</a>
        </div>
        <p>The record is rarely entirely removed so we should almost
never get <code>None</code> here.  If we do, do nothing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-167'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-167">#</a>
        </div>
        <p>This is an updated record: replace the old record
and update the position for the following new
records.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-168'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-168">#</a>
        </div>
        <p>This is a new record: place it to the designated
position.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-169'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-169">#</a>
        </div>
        <p>The record has not been changed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-170'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-170">#</a>
        </div>
        <p>Make sure any new record will go after this one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-171'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-171">#</a>
        </div>
        <p>When there are no test output data, skip creating the output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-172'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-172">#</a>
        </div>
        <p>Now we need to check if the new output list coincides with the old
one, in which case we don't want to create a new output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-173'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-173">#</a>
        </div>
        <p>Generate and return new output data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-174'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-174">#</a>
        </div>
        <p>Performs an HTSQL query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-175'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-175">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('uri', StrVal(),
hint="""the HTSQL query"""),
Field('method', ChoiceVal(['GET', 'POST']), 'GET',
hint="""the HTTP method (GET or POST)"""),
Field('remote_user', StrVal(), None,
hint="""the HTTP remote user"""),
Field('headers', MapVal(StrVal(), StrVal()), None,
hint="""the HTTP headers"""),
Field('content_type', StrVal(), None,
hint="""the content type of HTTP POST data"""),
Field('content_body', StrVal(), None,
hint="""the HTTP POST data"""),
Field('expect', IntVal(), 200,
hint="""the HTTP status code to expect"""),
Field('ignore', BoolVal(), False,
hint="""ignore the response body"""),
] + SkipTestCase.Input.fields
</pre>
def init_attributes(self):</p>
<h1>Check that <code>content-type</code> and <code>content-body</code> are set only if</h1>
<h1>the HTTP method is <code>POST</code>.</h1>
<p>if self.method == 'GET':
if self.content_type is not None:
raise ValueError("unexpected content-type parameter"
<pre>" for a GET request")
if self.content_body is not None:
raise ValueError("unexpected content-body parameter"
" for a GET request")
if self.method == 'POST':
if self.content_body is None:
raise ValueError("no expected content-body parameter"
" for a POST request")
</pre>
class Output(TestData):
fields = [
Field('uri', StrVal(),
hint="""the HTSQL query"""),
Field('status', StrVal(),
hint="""the response status line"""),
Field('headers', SeqVal(SeqVal(StrVal(), length=2)),
hint="""the response headers"""),
Field('body', StrVal(),
hint="""the response body"""),
]</p>
<p>def init_attributes(self):</p>
<h1>Convert the list of two-element lists to a list of pairs.</h1>
<p>self.headers = [(key, value) for key, value in self.headers]</p>
<p>def out_header(self):</p>
<h1>Display the header:</h1>
<h1>---------------- ... -</h1>
<h1>{method} {uri}</h1>
<h1>({input.location})</h1>
<h1>Remote-User: {remote_user}</h1>
<h1>{header}: value</h1>
<h1>...</h1>
<h1>Content-Type: {content_type}</h1>
<h1 />
<h1>{content_body}</h1>
<p>self.out_sep()
self.out("%s %s" % (self.input.method, self.input.uri), indent=2)
self.out("(%s)" % self.input.location, indent=2)
if self.input.remote_user is not None:
self.out("Remote-User: %s" % self.input.remote_user, indent=2)
if self.input.headers:
for key in sorted(self.input.headers):
value = self.input.headers[key]
self.out("%s: %s" % (key, value), indent=2)
if self.input.content_type is not None:
self.out("Content-Type: %s" % self.input.content_type, indent=2)
self.out()
if self.input.content_body:
self.out_lines(self.input.content_body.splitlines(), indent=2)</p>
<p>def differs(self, old_output, new_output):</p>
<h1>Check if the actual output differs from the expected output.</h1>
<p>if old_output is None or new_output is None:
return True
if old_output.status != new_output.status:
return True
if old_output.headers != new_output.headers:
return True
if not self.input.ignore:
if old_output.body != new_output.body:
return True
return False</p>
<p>def render(self, output):</p>
<h1>Convert the output record to a list of lines.</h1>
<p>if output is None:
return None
lines = []
lines.append(output.status)
for header, value in output.headers:
lines.append("%s: %s" % (header, value))
lines.append("")
lines.extend(output.body.splitlines())
return lines</p>
<p>def execute(self):</p>
<h1>Execute the query; return the output.</h1>
<h1>Prepare the HTSQL application.</h1>
<p>app = self.state.app
if app is None:
return self.failed("*** no HTSQL application is defined")</p>
<h1>Prepare and execute the query.</h1>
<p>request = Request.prepare(method=self.input.method,
query=self.input.uri,
remote_user=self.input.remote_user,
content_type=self.input.content_type,
content_body=self.input.content_body,
extra_headers=self.input.headers)
response = request.execute(app)</p>
<h1>Check if the response is valid.</h1>
<p>if response.exc_info is not None:
self.out_exception(response.exc_info)
return self.out("<strong><em> an exception occured"
" while executing the query")
if not response.complete():
return self.out("</em></strong> the response is not complete")</p>
<h1>Generate the output record.</h1>
<p>new_output = self.make_output(uri=self.input.uri,
status=response.status,
headers=response.headers,
body=response.body)</p>
<h1>Check if we get the expected status code (200, by default).</h1>
<h1>If not, display the response and discard the output.</h1>
<p>if not response.status.startswith(str(self.input.expect)):
self.out_diff(self.output, new_output)
return self.out("*** unexpected status code: %s"
% response.status)</p>
<p>return new_output</p>
<p>class CtlTestCase(RunAndCompareTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-176'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-176">#</a>
        </div>
        <p>name = "ctl"
hint = """execute a routine"""
help = """
This test case simulates a run of the HTSQL command-line application.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-177'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-177">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-178'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-178">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-179'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-179">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-180'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-180">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-181'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-181">#</a>
        </div>
        <h2>Display the header:</h2>
<p>{EXECUTABLE} {ctl}
  ({input.location})</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-182'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-182">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-183'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-183">#</a>
        </div>
        <p>Check if the actual output differs from the expected output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-184'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-184">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-185'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-185">#</a>
        </div>
        <p>Convert the output to a list of lines.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-186'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-186">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-187'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-187">#</a>
        </div>
        <p>Run the routine; return the output</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-188'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-188">#</a>
        </div>
        <p>Prepare the standard streams and the script instance.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-189'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-189">#</a>
        </div>
        <p>The script class.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-190'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-190">#</a>
        </div>
        <p>Initialize and execute the script; check for exceptions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-191'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-191">#</a>
        </div>
        <p>Normalize the exit code.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-192'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-192">#</a>
        </div>
        <p>Generate a new output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-193'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-193">#</a>
        </div>
        <p>Check if we get the expected exit code; if not, display
the content of stdout and discard the output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-194'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-194">#</a>
        </div>
        <p>Keeps information on the started processes.</p>
<p>Class attributes:</p>
<p><code>active_forks</code>
<pre>The global list of active processes.
</pre>
<code>is_atexit_registered</code>
Indicates whether an :func:<code>atexit.atexit</code> callable was registered.
The callable is called when the script is about to finish and kills
any remaining active processes.</p>
<p>Attributes:</p>
<p><code>process</code> (an instance of :class:<code>subprocess.Popen</code>)
The wrapped process.</p>
<p><code>temp_path</code> (a string)
A directory containing two files: <code>input</code> and <code>output</code>, which
keeps the content of the standard input and the standard output
respectively.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-195'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-195">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-196'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-196">#</a>
        </div>
        <p>Starts a new process.</p>
<p><code>executable</code>
<pre>The path to the executable.
</pre>
<code>arguments</code>
The list of arguments (not including the executable).</p>
<p><code>input</code>
The content of the standard input.</p>
<p>Returns a new :class:<code>Fork</code> instance.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-197'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-197">#</a>
        </div>
        <p>Create a temporary directory with the files 'input' and 'output'.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-198'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-198">#</a>
        </div>
        <p>Prepare the standard input and the standard output streams.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-199'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-199">#</a>
        </div>
        <p>Start the process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-200'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-200">#</a>
        </div>
        <p>Return a new <code>Fork</code> instance.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-201'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-201">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-202'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-202">#</a>
        </div>
        <p>Finalize any remaining active processes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-203'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-203">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-204'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-204">#</a>
        </div>
        <p>Register the <code>atexit</code> callable if not done already.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-205'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-205">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-206'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-206">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-207'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-207">#</a>
        </div>
        <p>Save themselves in the global list of active processes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-208'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-208">#</a>
        </div>
        <p>Register the <code>atexit</code> callback.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-209'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-209">#</a>
        </div>
        <p>Ends the process.</p>
<p>Returns the content of the standard output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-210'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-210">#</a>
        </div>
        <p>Terminate the process if it is still alive.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-211'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-211">#</a>
        </div>
        <p>FIXME: Python 2.5 compatibility!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-212'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-212">#</a>
        </div>
        <p>Read the standard output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-213'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-213">#</a>
        </div>
        <p>Remove the temporary directory.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-214'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-214">#</a>
        </div>
        <p>Remove it from the list of active processes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-215'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-215">#</a>
        </div>
        <p>Starts a long-running routine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-216'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-216">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('start_ctl', SeqVal(StrVal()),
hint="""a list of command-line parameters"""),
Field('stdin', StrVal(), '',
hint="""the content of the standard output"""),
Field('sleep', UFloatVal(), 0,
hint="""sleep for the specified number of seconds"""),
] + SkipTestCase.Input.fields
</pre>
def verify(self):</p>
<h1>Execute the test.</h1>
<h1>Check if the test case is skipped.</h1>
<p>if self.skipped():
return</p>
<h1>Check if an application with the same command-line parameters</h1>
<h1>has already been started.</h1>
<p>key = tuple(self.input.start_ctl)
if key in self.state.forks:
return self.fork("*** the application is already started")</p>
<h1>Start and save the process.</h1>
<p>fork = Fork.start(self.routine.executable,
<pre>self.input.start_ctl,
self.input.stdin)
self.state.forks[key] = fork
</pre></p>
<p>class EndCtlTestCase(RunAndCompareTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-217'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-217">#</a>
        </div>
        <p>name = "end-ctl"
hint = """terminate a long-running routine"""
help = """
This test case allows you to terminate a long-running routine started
with <code>start-ctl</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-218'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-218">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-219'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-219">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-220'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-220">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-221'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-221">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-222'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-222">#</a>
        </div>
        <p>Check if the actual output differs from the expected output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-223'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-223">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-224'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-224">#</a>
        </div>
        <p>Convert the output record to a list of lines.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-225'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-225">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-226'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-226">#</a>
        </div>
        <p>Execute the test case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-227'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-227">#</a>
        </div>
        <p>Find the active process with the same command-line artguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-228'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-228">#</a>
        </div>
        <p>Terminate the process; get the standard output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-229'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-229">#</a>
        </div>
        <p>Create and return the output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-230'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-230">#</a>
        </div>
        <p>Executes arbitrary Python code.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-231'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-231">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('py', WordVal(),
hint="""the code name"""),
Field('code', StrVal(),
hint="""Python code"""),
Field('stdin', StrVal(), '',
hint="""the content of the standard input"""),
Field('expect', StrVal(), None,
hint="""the name of an exception to expect"""),
Field('ignore', BoolVal(), False,
hint="""ignore the standard output"""),
] + SkipTestCase.Input.fields
</pre>
class Output(TestData):
fields = [
Field('py', WordVal(),
hint="""the code name"""),
Field('stdout', StrVal(),
hint="""the content of the standard output"""),
]</p>
<p>def differs(self, old_output, new_output):</p>
<h1>Check if the actual output differs from the expected output.</h1>
<p>if old_output is None or new_output is None:
return True
if not self.input.ignore:
if old_output.stdout != new_output.stdout:
return True
return False</p>
<p>def render(self, output):</p>
<h1>Convert the output record to a list of lines.</h1>
<p>if output is None:
return None
return output.stdout.splitlines()</p>
<p>def execute(self):</p>
<h1>Execute the test case.</h1>
<h1>Prepare new standard streams.</h1>
<p>old_stdin = sys.stdin
old_stdout = sys.stdout
old_stderr = sys.stderr
sys.stdin = StringIO.StringIO(self.input.stdin)
sys.stdout = StringIO.StringIO()
sys.stderr = sys.stdout</p>
<h1>Prepare the code.</h1>
<p>code = self.load()
context = {'state': self.state}</p>
<h1>Execute the code.</h1>
<p>exc_info = None
try:
exec code in context
except:
exc_info = sys.exc_info()</p>
<h1>Make new output record.</h1>
<p>key = self.input.fields[0].attribute
new_output = self.make_output(stdout=sys.stdout.getvalue(),
<pre>**{key: getattr(self.input, key)})</p>
<h1>Restore old standard streams.</h1>
<p>sys.stdin = old_stdin
sys.stdout = old_stdout
sys.stderr = old_stderr</p>
<h1>An exception occured while running the code.</h1>
<p>if exc_info is not None:</p>
<h1>Display the output and the exception</h1>
<p>self.out_diff(self.output, new_output)
self.out_exception(exc_info)
exc_name = exc_info[0].<strong>name</strong></p>
<h1>The exception was unexpected: discard the output.</h1>
<p>if self.input.expect is None or self.input.expect != exc_name:
return self.out("*** an unexpected exception occured")
else:</p>
<h1>We didn't get the expected exception: discard the output.</h1>
<p>if self.input.expect is not None:
return self.out("*** an expected exception did not occur")
return new_output
</pre>
def load(self):</p>
<h1>Get the script source code.</h1>
<p>return self.input.code</p>
<p>class PythonCodeIncludeTestCase(PythonCodeTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-232'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-232">#</a>
        </div>
        <p>name = "python-include"
hint = """load and execute Python code"""
help = """
This test case allows you to execute arbitrary Python code
loaded from a file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-233'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-233">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-234'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-234">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-235'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-235">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-236'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-236">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-237'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-237">#</a>
        </div>
        <p>Get the script code from the given file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-238'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-238">#</a>
        </div>
        <p>Executes a SQL query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-239'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-239">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('connect', DBVal(),
hint="""the connection URI"""),
Field('sql', StrVal(),
hint="""the statements to execute"""),
Field('autocommit', BoolVal(), False,
hint="""use the auto-commit mode"""),
Field('ignore', BoolVal(), False,
hint="""ignore any errors"""),
] + SkipTestCase.Input.fields
</pre>
def out_header(self):</p>
<h1>Print:</h1>
<h1>---------------- ... -</h1>
<h1>{first line of input.sql}</h1>
<h1>({input.location})</h1>
<p>self.out_sep()
first_line = self.input.sql.split('n', 1)[0]
self.out(first_line, indent=2)
if self.input.location is not None:
self.out("(%s)" % self.input.location, indent=2)</p>
<p>def verify(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return</p>
<h1>Display the header.</h1>
<p>self.out_header()</p>
<h1>Load the SQL input data.</h1>
<p>sql = self.load()</p>
<h1>Generate an HTSQL application.  We need an application instance</h1>
<h1>to split the SQL data and to connect to the database, but we</h1>
<h1>never use it for executing HTSQL queries.</h1>
<p>from htsql.application import Application
from htsql.connect import Connect, DBError
from htsql.split_sql import SplitSQL
try:
app = Application(self.input.connect)
except Exception, exc:
self.out_exception(sys.exc_info())
return self.failed("*** an exception occured while"
<pre>" initializing an HTSQL application")
</pre></p>
<h1>Activate the application so that we could use the splitter</h1>
<h1>and the connection adapters.</h1>
<p>with app:</p>
<h1>Realize a splitter and split the input data to individual</h1>
<h1>SQL statements.</h1>
<p>split_sql = SplitSQL()
try:
statements = list(split_sql(sql))
except ValueError, exc:
return self.failed("*** invalid SQL: %s" % exc)</p>
<h1>Realize the connector and connect to the database.</h1>
<p>connect = Connect()
try:
connection = connect(with_autocommit=self.input.autocommit)
cursor = connection.cursor()
except DBError, exc:
return self.failed("*** failed to connect to the database:"
<pre>" %s" % exc)
</pre></p>
<h1>Execute the given SQL statements.</h1>
<p>for statement in statements:
try:</p>
<h1>Execute the statement in the current connection.</h1>
<p>cursor.execute(statement)
except DBError, exc:</p>
<h1>Display the statement that caused a problem.</h1>
<p>for line in statement.splitlines():
self.out(line, indent=4)</p>
<h1>Normally, we end the test case when an error occurs,</h1>
<h1>but if <code>ignore</code> is set, we just break the loop.</h1>
<p>if not self.input.ignore:
return self.failed("*** failed to execute SQL:"
<pre>" %s" % exc)
break
</pre></p>
<h1>No error occurred while executing the SQL statements.</h1>
<p>else:</p>
<h1>Commit the transaction unless <code>autocommit</code> mode is set.</h1>
<h1>Again, respect the <code>ignore</code> flag.</h1>
<p>if not self.input.autocommit:
try:
connection.commit()
except DBError, exc:
if not self.input.ignore:
return self.failed("*** failed to commit"
<pre>" a transaction: %s" % exc)
</pre></p>
<h1>Close the connection.  Note that we insist that connection</h1>
<h1>is opened and closed successfully regardless of the value</h1>
<h1>of the <code>ignore</code> flag.</h1>
<p>try:
connection.close()
except DBError, exc:
return self.failed("*** failed to close the connection:"
" %s" % exc)</p>
<h1>If we reached that far, we passed the test.</h1>
<p>return self.passed()</p>
<p>def load(self):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-240'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-240">#</a>
        </div>
        <h1>Override when subclassing.</h1>
<p>return self.input.sql</p>
<p>class SQLIncludeTestCase(SQLTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-241'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-241">#</a>
        </div>
        <p>name = "sql-include"
hint = """load and execute SQL statements"""
help = """
This test case loads SQL statements from a file and execute them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-242'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-242">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-243'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-243">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-244'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-244">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-245'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-245">#</a>
        </div>
        <h2>Print:</h2>
<p>SQL-INCLUDE {input.sql_include}
  ({input.location})</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-246'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-246">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-247'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-247">#</a>
        </div>
        <p>Load SQL from the given file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-248'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-248">#</a>
        </div>
        <p>Writes some data to a file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-249'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-249">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-250'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-250">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-251'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-251">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-252'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-252">#</a>
        </div>
        <p>Check if the test is skipped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-253'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-253">#</a>
        </div>
        <p>Display the header.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-254'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-254">#</a>
        </div>
        <p>Write the data to the file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-255'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-255">#</a>
        </div>
        <p>Reads the file content.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-256'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-256">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-257'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-257">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-258'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-258">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-259'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-259">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-260'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-260">#</a>
        </div>
        <p>Check if the actual output differs from the expected output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-261'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-261">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-262'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-262">#</a>
        </div>
        <p>Convert the output record to a list of lines.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-263'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-263">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-264'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-264">#</a>
        </div>
        <p>Execute the test.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-265'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-265">#</a>
        </div>
        <p>Check if the file exists.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-266'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-266">#</a>
        </div>
        <p>Read the data and create the output record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-267'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-267">#</a>
        </div>
        <p>Removes the specified files.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-268'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-268">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('remove', SeqVal(StrVal()),
hint="""a list of files to remove"""),
] + SkipTestCase.Input.fields
</pre>
def verify(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return</p>
<h1>Display the header.</h1>
<p>self.out_header()</p>
<h1>Remove the given files.</h1>
<p>for path in self.input.remove:
if os.path.exists(path):
os.unlink(path)</p>
<p>class MakeDirTestCase(SkipTestCase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-269'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-269">#</a>
        </div>
        <p>name = "make-dir"
hint = """create a directory"""
help = """
Create a directory.  If necessary, all intermediate directories are also
created.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-270'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-270">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-271'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-271">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-272'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-272">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-273'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-273">#</a>
        </div>
        <p>Check if the test is skipped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-274'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-274">#</a>
        </div>
        <p>Display the header.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-275'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-275">#</a>
        </div>
        <p>Create the directory if it does not already exist.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-276'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-276">#</a>
        </div>
        <p>Removes a directory.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-277'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-277">#</a>
        </div>
        <p>class Input(TestData):
<pre>fields = [
Field('rmdir', StrVal(),
hint="""the directory name"""),
] + SkipTestCase.Input.fields
</pre>
def verify(self):</p>
<h1>Check if the test is skipped.</h1>
<p>if self.skipped():
return</p>
<h1>Display the header.</h1>
<p>self.out_header()</p>
<h1>Remove the directory with all its content (DANGEROUS!).</h1>
<p>if os.path.exists(self.input.rmdir):
shutil.rmtree(self.input.rmdir)</p>
<p>class TestState(object):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-278'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-278">#</a>
        </div>
        <p>def <strong>init</strong>(self, app=None, forks=None, toggles=None,
<pre>with_all_suites=False, passed=0, failed=0, updated=0,
is_exiting=False):
self.app = app
self.forks = forks or {}
self.toggles = toggles or set()
self.with_all_suites = with_all_suites
self.passed = passed
self.failed = failed
self.updated = updated
self.is_exiting = is_exiting
</pre>
def push(self, other):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-279'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-279">#</a>
        </div>
        <p>other.app = self.app
other.forks = self.forks.copy()
other.toggles = self.toggles.copy()
other.with_all_suites = self.with_all_suites
other.passed = self.passed
other.failed = self.failed
other.updated = self.updated
other.is_exiting = self.is_exiting</p>
<p>def pull(self, other):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-280'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-280">#</a>
        </div>
        <p>self.passed = other.passed
self.failed = other.failed
self.updated = other.updated
self.is_exiting = other.is_exiting</p>
<h1>The base classes for the YAML loaders and dumpers.  When available,</h1>
<h1>use the fast, LibYAML-based variants, if not, use the slow pure-Python</h1>
<h1>versions.</h1>
<p>BaseYAMLLoader = yaml.SafeLoader
if hasattr(yaml, 'CSafeLoader'):
BaseYAMLLoader = yaml.CSafeLoader
BaseYAMLDumper = yaml.SafeDumper
if hasattr(yaml, 'CSafeDumper'):
BaseYAMLDumper = yaml.CSafeDumper</p>
<p>class RegressYAMLLoader(BaseYAMLLoader):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-281'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-281">#</a>
        </div>
        <h1>A pattern to match substitution variables in <code>!environ</code> nodes.</h1>
<p>environ_pattern = r"""$ { (?P<name> [a-zA-Z_][0-9a-zA-Z_.-]*) }"""
environ_regexp = re.compile(environ_pattern, re.X)</p>
<h1>A pattern for valid values of substitution variables.</h1>
<p>environ_value_pattern = r"""^ [0-9A-Za-z~@#^&amp;<em>_;:,./?=+-]</em> $"""
environ_value_regexp = re.compile(environ_value_pattern, re.X)</p>
<p>def <strong>init</strong>(self, routine, with_input, with_output, stream):
<pre>super(RegressYAMLLoader, self).<strong>init</strong>(stream)
self.routine = routine</p>
<h1>The list of permitted record classes.</h1>
<p>self.records = []</p>
<h1>A mapping of record_class -&gt; case_class.</h1>
<p>self.case_by_record = {}</p>
<h1>A mapping of record_class -&gt; the set of all attributes.</h1>
<p>self.all_keys_by_record = {}</p>
<h1>A mapping of record_class -&gt; the set of mandatory attributes.</h1>
<p>self.mandatory_keys_by_record = {}</p>
<h1>Generate a list of permitted record classes.</h1>
<p>self.init_records(with_input, with_output)
</pre>
def init_records(self, with_input, with_output):</p>
<h1>Gather the record classes from the available test cases.</h1>
<p>for case_class in self.routine.cases:
<pre>if with_input and case_class.Input is not None:
self.records.append(case_class.Input)
self.case_by_record[case_class.Input] = case_class
if with_output and case_class.Output is not None:
self.records.append(case_class.Output)
self.case_by_record[case_class.Output] = case_class
</pre></p>
<h1>For each record class, prepare the set of all attributes and</h1>
<h1>the set of mandatory attributes.</h1>
<p>for record_class in self.records:
all_keys = set()
for field in record_class.fields:
if field.is_any:
<pre>all_keys = None
break
all_keys.add(field.attribute.replace('<em>', '-'))
self.all_keys_by_record[record_class] = all_keys
mandatory_keys = set()
for field in record_class.fields:
if field.is_any or not field.is_mandatory:
continue
mandatory_keys.add(field.attribute.replace('</em>', '-'))
if not mandatory_keys:
mandatory_keys = None
self.mandatory_keys_by_record[record_class] = mandatory_keys
</pre>
def load(self):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-282'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-282">#</a>
        </div>
        <h1>That ensures the stream contains one document, parses it and</h1>
<h1>returns the corresponding object.</h1>
<p>return self.get_single_data()</p>
<p>def construct_document(self, node):</p>
<h1>We override this to ensure that any produced document is</h1>
<h1>a test record of expected type.</h1>
<p>data = super(RegressYAMLLoader, self).construct_document(node)
if type(data) not in self.records:
<pre>raise yaml.constructor.ConstructorError(None, None,
"unexpected document type",
node.start_mark)
return data
</pre>
def construct_yaml_str(self, node):</p>
<h1>Always convert a <code>!!str</code> scalar node to a byte string.</h1>
<h1>By default, PyYAML converts an `!!str`` node containing non-ASCII</h1>
<h1>characters to a Unicode string.</h1>
<p>value = self.construct_scalar(node)
value = value.encode('utf-8')
return value</p>
<p>def construct_yaml_map(self, node):</p>
<h1>Detect if a node represent test data and convert it to a test record.</h1>
<h1>We assume that the node represents a test record if it contains</h1>
<h1>all mandatory keys of the record class.  Otherwise, we assume it</h1>
<h1>is a regular dictionary.</h1>
<h1 />
<h1>It would be much better to perform this detection on the tag</h1>
<h1>resolution phase.  However this phase does not give us access</h1>
<h1>to the mapping keys, so we have no choice but do it during the</h1>
<h1>construction phase.</h1>
<h1>Check if we got a mapping node.</h1>
<p>if not isinstance(node, yaml.MappingNode):
raise yaml.constructor.ConstructorError(None, None,
"expected a mapping node, but found %s" % node.id,
node.start_mark)</p>
<h1>Objects corresponding to the key nodes.</h1>
<p>keys = []</p>
<h1>Objects corresponding to the value nodes.</h1>
<p>values = []</p>
<h1>The mapping of key object -&gt; value object.</h1>
<p>value_by_key = {}</p>
<h1>The mapping of key object -&gt; the mark of the key node.</h1>
<p>key_mark_by_key = {}</p>
<h1>The mapping of key object -&gt; the mark of the value node.</h1>
<p>value_mark_by_key = {}</p>
<h1>Convert the key and the value nodes.</h1>
<p>for key_node, value_node in node.value:
key = self.construct_object(key_node, deep=True)
try:
hash(key)
except TypeError, exc:
raise yaml.constructor.ConstructorError(
<pre>"while constructing a mapping",
node.start_mark,
"found unacceptable key (%s)" % exc,
key_node.start_mark)
keys.append(key)
value = self.construct_object(value_node, deep=True)
values.append(value)
value_by_key[key] = value
key_mark_by_key[key] = key_node.start_mark
value_mark_by_key[key] = value_node.start_mark
</pre></p>
<h1>Find a record class such that the node contains all</h1>
<h1>the mandatory record fields.</h1>
<p>detected_record_class = None
key_set = set(keys)
for record_class in self.records:
mandatory_keys = self.mandatory_keys_by_record[record_class]
if mandatory_keys is None:
continue
if key_set.issuperset(mandatory_keys):
detected_record_class = record_class
break</p>
<h1>If we can't find a suitable record class, it must be a regular</h1>
<h1>dictionary.</h1>
<p>if detected_record_class is None:
return dict(zip(keys, values))</p>
<h1>Check that the node does not contain any keys other than</h1>
<h1>the record fields.</h1>
<p>all_keys = self.all_keys_by_record[detected_record_class]
if all_keys is not None:
for key in keys:
if key not in all_keys:
raise yaml.constructor.ConstructorError(None, None,
<pre>"unexpected key %r; expected one of %s"
% (key, ", ".join(sorted(all_keys))),
key_mark_by_key[key])
</pre></p>
<h1>Generate the record attributes: validate and normalize</h1>
<h1>the field values.</h1>
<p>attributes = {}
for field in detected_record_class.fields:
if field.is_any:
continue
key = field.attribute.replace('_', '-')
if key in value_by_key:
value = value_by_key[key]
try:
value = field.val(value)
except ValueError, exc:
raise yaml.constructor.ConstructorError(None, None,
"invalid field %r (%s)" % (key, exc),
value_mark_by_key[key])
else:
value = field.default
attributes[field.attribute] = value</p>
<h1>Record where the node was found.</h1>
<p>location = ""%s", line %s" 
% (node.start_mark.name, node.start_mark.line+1)</p>
<h1>Instantiate and return the test record.</h1>
<p>case_class = self.case_by_record[detected_record_class]
try:
record = detected_record_class(self.routine, case_class,
<pre>attributes, location)
except ValueError, exc:
raise yaml.constructor.ConstructorError(None, None,
"invalid test data (%s)" % exc,
node.start_mark)
return record
</pre>
def construct_environ(self, node):</p>
<h1>Substitute environment variables in <code>!environ</code> scalars.</h1>
<p>def replace(match):</p>
<h1>Substitute environment variables with values.</h1>
<p>name = match.group('name')
value = os.environ.get(name, '')
if not self.environ_value_regexp.match(value):
raise yaml.constructor.ConstructorError(None, None,
"invalid value of environment variable %s: %r"
% (name, value), node.start_mark)
return value</p>
<h1>Get the scalar value and replace all ${...} occurences with</h1>
<h1>values of respective environment variables.</h1>
<p>value = self.construct_scalar(node)
value = value.encode('utf-8')
value = self.environ_regexp.sub(replace, value)</p>
<h1>Blank values are returned as <code>None</code>.</h1>
<p>if not value:
return None
return value</p>
<h1>Register custom constructors for <code>!!str``,</code>!!map<code>and</code>!environ``.</h1>
<p>RegressYAMLLoader.add_constructor(
u'tag:yaml.org,2002:str',
RegressYAMLLoader.construct_yaml_str)
RegressYAMLLoader.add_constructor(
u'tag:yaml.org,2002:map',
RegressYAMLLoader.construct_yaml_map)
RegressYAMLLoader.add_constructor(
u'!environ',
RegressYAMLLoader.construct_environ)</p>
<h1>Register a resolver for <code>!environ</code>.</h1>
<p>RegressYAMLLoader.add_implicit_resolver(
u'!environ', RegressYAMLLoader.environ_regexp, [u'$'])</p>
<p>class RegressYAMLDumper(BaseYAMLDumper):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-283'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-283">#</a>
        </div>
        <p>def <strong>init</strong>(self, routine, with_input, with_output, stream, **keywords):
<pre># FIXME: we don't really need extra <code>with_*</code> parameters, this</p>
<h1>constructor is always called with with_input=False, with_output=True.</h1>
<p>super(RegressYAMLDumper, self).<strong>init</strong>(stream, **keywords)
self.routine = routine</p>
<h1>The set of permitted record classes.</h1>
<p>self.records = set()</p>
<h1>Gather the permitted record classes.</h1>
<p>self.init_records(with_input, with_output)</p>
<h1>Check if the PyYAML version is suitable for dumping.</h1>
<p>self.check_version()
</pre>
def init_records(self, with_input, with_output):</p>
<h1>Gather permitted record classes.</h1>
<p>for case_class in self.routine.cases:
<pre>if with_input and case_class.Input is not None:
self.records.add(case_class.Input)
if with_output and case_class.Output is not None:
self.records.add(case_class.Output)
</pre>
def check_version(self):</p>
<h1>We require PyYAML &gt;= 3.07 built with LibYAML &gt;= 0.1.2 to dump</h1>
<h1>YAML data.  Other versions may produce slightly different output.</h1>
<h1>Since the YAML files may be kept in a VCS repository, we don't</h1>
<h1>want minor formatting changes generate unnecessarily large diffs.</h1>
<p>try:
pyyaml_version = yaml.<strong>version</strong>
except AttributeError:
pyyaml_version = '3.05'
try:
import _yaml
libyaml_version = _yaml.get_version_string()
except ImportError:
libyaml_version = None
if pyyaml_version &lt; '3.07':
raise ScriptError("PyYAML &gt;= 3.07 is required"
<pre>" to dump test output")
if libyaml_version is None:
raise ScriptError("PyYAML built with LibYAML bindings"
" is required to dump test output")
if libyaml_version &lt; '0.1.2':
raise ScriptError("LibYAML &gt;= 0.1.2 is required"
" to dump test output")
</pre>
def dump(self, data):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-284'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-284">#</a>
        </div>
        <p>self.open()
self.represent(data)
self.close()</p>
<p>def represent_str(self, data):</p>
<h1>Serialize a string.  We override the default string serializer</h1>
<h1>to use the literal block style for multi-line strings.</h1>
<p>tag = None
style = None
if data.endswith('n'):
<pre>style = '|'
try:
data = data.decode('utf-8')
tag = u'tag:yaml.org,2002:str'
except UnicodeDecodeError:
data = data.encode('base64')
tag = u'tag:yaml.org,2002:binary'
style = '|'
return self.represent_scalar(tag, data, style=style)
</pre>
def represent_record(self, data):</p>
<h1>Complain when given a record of unexpected type.</h1>
<p>if type(data) not in self.records:
return super(RegressYAMLDumper, self).represent_undefined(data)</p>
<h1>Extract the fields skipping those with the default value.</h1>
<p>mapping = []
for field in data.fields:
if field.is_any:
<pre>continue
name = field.attribute.replace('_', '-')
value = getattr(data, field.attribute)
if value == field.default:
continue
mapping.append((name, value))</p>
<h1>Generate a mapping node.</h1>
<p>return self.represent_mapping(u'tag:yaml.org,2002:map', mapping,
flow_style=False)
</pre></p>
<h1>Register custom representers for <code>str</code> and <code>TestData</code>.</h1>
<p>RegressYAMLDumper.add_representer(
str, RegressYAMLDumper.represent_str)
RegressYAMLDumper.add_multi_representer(
TestData, RegressYAMLDumper.represent_record)</p>
<p>class RegressRoutine(Routine):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-285'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-285">#</a>
        </div>
        <p>name = 'regress'
aliases = ['test']
arguments = [
<pre>Argument('suites', SeqVal(WordVal()), None, is_list=True),
]
options = [
InputOption,
TrainOption,
PurgeOption,
ForceOption,
QuietOption,
]
hint = """run regression tests"""
help = """
This routine runs a series of test cases.
</pre>
A test case takes input data and produces output data.  The test
succeeds if it runs without errors and its output data coincides with
the expected output.</p>
<p>Input and output test data are stored in the YAML format.  Run
'%(executable)s help regress <case>' to get the description of the
format for a specific test type.</p>
<p>Test cases are organized into suites.  A test suite is a special type of
a test case that contains other test cases.</p>
<p>By default, the routine executes all tests in the given YAML file.  To
run only specific test suites, list their identifiers in the command
line.</p>
<p>Unless option <code>--force</code> is used, the testing process will halt on the
first test failure.</p>
<p>The routine reads the input data from the standard input stream.  Use
option <code>--input FILE</code> to read the input data from a file instead.</p>
<p>The routine supports training mode, in which it allows you to add
expected output for new tests and updated expected output for existing
tests.  Use option <code>--train</code> to run the routine in the training mode.</p>
<p>When a test case is removed, the routine does not remove obsolete
expected output records automatically.  Use option <code>--purge</code> to remove
stale output records.</p>
<p>By default, the routine prints the header of every executed tests.  Use
option <code>--quiet</code> to print only errors and final statistics.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-286'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-286">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-287'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-287">#</a>
        </div>
        <p>This text is written to YAML files generated by the routine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-288'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-288">#</a>
        </div>
        <p>This file contains expected test output data for regression tests.
It was generated automatically by the <code>regress</code> routine.</p>
<h1>List of supported types of test cases.</h1>
<p>cases = [
<pre>AppTestCase,
DefineTestCase,
IncludeTestCase,
SuiteTestCase,
QueryTestCase,
CtlTestCase,
StartCtlTestCase,
EndCtlTestCase,
PythonCodeTestCase,
PythonCodeIncludeTestCase,
SQLTestCase,
SQLIncludeTestCase,
WriteToFileTestCase,
ReadFromFileTestCase,
RemoveFilesTestCase,
MakeDirTestCase,
RemoveDirTestCase,
]
</pre></p>
<h1>Represents the mutable state of the testing process.</h1>
<p>state_class = TestState</p>
<p>@classmethod
def get_help(cls, **substitutes):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-289'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-289">#</a>
        </div>
        <h1>Produce routine description of the form:</h1>
<h1>{help}</h1>
<h1 />
<h1>Test cases: (run ... for more help)</h1>
<h1>{case.name} : {case.hint}</h1>
<h1>...</h1>
<p>lines = []
help = super(RegressRoutine, cls).get_help(**substitutes)
if help is not None:
<pre>lines.append(help)
if cls.cases:
if lines:
lines.append("")
lines.append("Test cases:"
" (run '%(executable)s help regress <case>'"
" for more help)" % substitutes)
for case_class in cls.cases:
case_name = case_class.name
case_hint = case_class.get_hint()
if case_hint is not None:
lines.append("  %-24s : %s" % (case_name, case_hint))
else:
lines.append("  %s" % case_name)
return "n".join(lines)
</pre>
@classmethod
def get_feature(cls, name):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-290'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-290">#</a>
        </div>
        <p>for case_class in cls.cases:
<pre>if case_class.name == name:
return case_class
raise ScriptError("unknown test case %r" % name)
</pre>
def run(self):</p>
<h1>Get the test input data.</h1>
<p>input = self.load_input(self.input)</p>
<h1>Initialize the testing state.</h1>
<p>state = self.state_class()</p>
<h1>Create a test case.</h1>
<p>case = input.case_class(self, state, input, None)</p>
<h1>Check if all test suites specified by the user exist.</h1>
<p>if self.suites:
available_suites = case.get_suites()
for suite in self.suites:
if suite not in available_suites:
<pre>raise ScriptError("unknown suite %r" % suite)
</pre></p>
<h1>Start the testing in the selected mode.</h1>
<p>if self.train:
case.train()
else:
case.verify()</p>
<h1>Display the statistics.</h1>
<p>self.ctl.out("="*72)
if state.passed:
self.ctl.out("TESTS PASSED: %s" % state.passed)
if state.failed:
self.ctl.out("TESTS FAILED: %s" % state.failed)
if state.updated:
self.ctl.out("TESTS UPDATED: %s" % state.updated)
self.ctl.out()</p>
<h1>Produce a fatal error if at least one test failed.</h1>
<p>if state.failed:
if state.failed == 1:
message = "a test failed"
else:
message = "%s tests failed" % state.failed
raise ScriptError(message)</p>
<p>def load_input(self, path):</p>
<h1>Load test input data from a file.  If <code>path</code> is <code>None</code>,</h1>
<h1>load from the standard input.</h1>
<p>assert isinstance(path, maybe(str))
if path is not None:
stream = open(path, 'rb')
else:
stream = self.ctl.stdin
loader = RegressYAMLLoader(self, True, False, stream)
try:
input = loader.load()
except yaml.YAMLError, exc:
raise ScriptError("failed to load test input data: %s" % exc)
return input</p>
<p>def load_output(self, path):</p>
<h1>Load test output data from a file.</h1>
<p>assert isinstance(path, str)
stream = open(path, 'rb')
loader = RegressYAMLLoader(self, False, True, stream)
try:
input = loader.load()
except yaml.YAMLError, exc:
raise ScriptError("failed to load test output data: %s" % exc)
return input</p>
<p>def save_output(self, path, output):</p>
<h1>Serialize and write test output data to a file.</h1>
<p>assert isinstance(path, str)
assert isinstance(output, TestData)
stream = open(path, 'wb')
if self.output_help is not None:
self.ctl.out(trim_doc(self.output_help), file=stream)
self.ctl.out(file=stream)
dumper = RegressYAMLDumper(self, False, True, stream)
try:
dumper.dump(output)
except yaml.YAMLError, exc:
raise ScriptError("failed to write test output data: %s" % exc)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
