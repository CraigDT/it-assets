<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>connect.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>connect.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">htsql.context</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">htsql.connect</span> <span class="kn">import</span> <span class="n">Connect</span>
<span class="kn">from</span> <span class="nn">htsql.adapter</span> <span class="kn">import</span> <span class="n">weigh</span>
<span class="kn">from</span> <span class="nn">htsql.tr.lookup</span> <span class="kn">import</span> <span class="n">itemize</span><span class="p">,</span> <span class="n">enumerate_table</span>
<span class="kn">from</span> <span class="nn">htsql.tr.binding</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AttachedTableRecipe</span><span class="p">,</span> <span class="n">ColumnRecipe</span><span class="p">,</span>
                              <span class="n">FreeTableRecipe</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">htsql.entity</span> <span class="kn">import</span> <span class="n">DirectJoin</span><span class="p">,</span> <span class="n">ReverseJoin</span>
<span class="kn">import</span> <span class="nn">sqlite3</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p>)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_meta_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        CREATE TABLE &quot;table&quot; (</span>
<span class="s">            name TEXT NOT NULL,</span>
<span class="s">            PRIMARY KEY (name)</span>
<span class="s">        );</span>
<span class="s">        CREATE TABLE &quot;field&quot; (</span>
<span class="s">            table_name TEXT NOT NULL,</span>
<span class="s">            name TEXT NOT NULL,</span>
<span class="s">            &quot;kind&quot; TEXT NOT NULL,</span>
<span class="s">            &quot;sort&quot; INTEGER,</span>
<span class="s">            PRIMARY KEY (table_name, name),</span>
<span class="s">            FOREIGN KEY (table_name)</span>
<span class="s">              REFERENCES &quot;table&quot;(name),</span>
<span class="s">            CHECK (&quot;kind&quot; IN (&#39;column&#39;, &#39;link&#39;))</span>
<span class="s">        );</span>
<span class="s">        CREATE TABLE &quot;column&quot; (</span>
<span class="s">            table_name TEXT NOT NULL,</span>
<span class="s">            name       TEXT NOT NULL,</span>
<span class="s">            domain_type TEXT NOT NULL,</span>
<span class="s">            is_mandatory BOOLEAN NOT NULL,</span>
<span class="s">            PRIMARY KEY (table_name, name),</span>
<span class="s">            FOREIGN KEY (table_name, name)</span>
<span class="s">               REFERENCES &quot;field&quot;(table_name, name),</span>
<span class="s">            FOREIGN KEY (table_name)</span>
<span class="s">               REFERENCES &quot;table&quot;(name)</span>
<span class="s">        );</span>
<span class="s">        CREATE TABLE &quot;link&quot; (</span>
<span class="s">            table_name TEXT NOT NULL,</span>
<span class="s">            name TEXT NOT NULL,</span>
<span class="s">            is_singular BOOLEAN NOT NULL,</span>
<span class="s">            target_table_name TEXT NOT NULL,</span>
<span class="s">            reverse_link_name TEXT,</span>
<span class="s">            PRIMARY KEY (table_name, name),</span>
<span class="s">            FOREIGN KEY (table_name, name)</span>
<span class="s">               REFERENCES &quot;field&quot;(table_name, name),</span>
<span class="s">            FOREIGN KEY (table_name)</span>
<span class="s">               REFERENCES &quot;table&quot;(name),</span>
<span class="s">            FOREIGN KEY (target_table_name)</span>
<span class="s">               REFERENCES &quot;table&quot;(name),</span>
<span class="s">            FOREIGN KEY (target_table_name, reverse_link_name)</span>
<span class="s">               REFERENCES &quot;link&quot;(table_name, name)</span>
<span class="s">        );</span>
<span class="s">#DIVIDER</span>
<span class="s">        table_handles[recipe.table] = table_name</span>

<span class="s">    link_by_fk = {}</span>
<span class="s">    reverse_links = []</span>

<span class="s">    for (table_name, recipe) in tables.items():</span>
<span class="s">        if not isinstance(recipe, FreeTableRecipe):</span>

<span class="s">#DIVIDER</span>
<span class="s">            continue</span>
<span class="s">        fields = itemize(recipe.table)</span>
<span class="s">        public = enumerate_table(recipe.table)</span>


<span class="s">#DIVIDER</span>
<span class="s">        def make_field(name, kind):</span>
<span class="s">            sort = None</span>
<span class="s">            if name in public:</span>
<span class="s">                sort = public.index(name)</span>
<span class="s">            cursor.execute(&quot;&quot;&quot;</span>
              <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">field</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">sort</span><span class="p">)</span>
              <span class="n">VALUES</span> <span class="p">(</span><span class="err">?</span><span class="p">,</span><span class="err">?</span><span class="p">,</span><span class="err">?</span><span class="p">,</span><span class="err">?</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>def populate_meta_schema(connection):
cursor = connection.cursor()
tables = itemize()
table_handles = {}</p>
<p>for (table_name, recipe) in tables.items():
<pre>if not isinstance(recipe, FreeTableRecipe):</p>
<h1>only handle unambiguous top-level table links</h1>
<p>continue
cursor.execute("""
INSERT INTO "table" (name)
VALUES (?)
, [table_name])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>only handle unambiguous top-level table links</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">def</span> <span class="nf">make_link</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">is_singular</span><span class="p">,</span> <span class="n">target_table_name</span><span class="p">):</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">              INSERT INTO &quot;link&quot; (table_name, name,</span>
<span class="s">                                  is_singular, target_table_name)</span>
<span class="s">              VALUES (?,?,?,?)</span>
<span class="s">#DIVIDER</span>


<span class="s">#DIVIDER</span>
<span class="s">class MetaSlaveConnect(Connect):</span>

<span class="s">    weigh(2.0) # ensure connections here are not pooled</span>


<span class="s">#DIVIDER</span>
<span class="s">    def open_connection(self, with_autocommit=False):</span>
<span class="s">        app = context.app</span>
<span class="s">        connection = app.tweak.meta.slave.cached_connection</span>
<span class="s">        if connection is None:</span>
<span class="s">            connection = sqlite3.connect(&#39;:memory:&#39;, check_same_thread=False)</span>
<span class="s">            slave_app = app</span>
<span class="s">            master_app = app.tweak.meta.slave.master()</span>
<span class="s">            context.switch(slave_app, master_app)</span>
<span class="s">            try:</span>
<span class="s">                create_meta_schema(connection)</span>
<span class="s">                populate_meta_schema(connection)</span>
<span class="s">            finally:</span>
<span class="s">                context.switch(master_app, slave_app)</span>
<span class="s">            connection.commit()</span>
<span class="s">            app.tweak.meta.slave.cached_connection = connection</span>
<span class="s">        return connection</span>

</pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>, [table_name, name, kind, sort])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p></pre>
def make_column(name, domain_type, is_mandatory):
<pre>cursor.execute("""
INSERT INTO "column" (table_name, name,
domain_type, is_mandatory)
VALUES (?,?,?,?)
, [table_name, name, domain_type, is_mandatory])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>, [table_name, name, is_singular, target_table_name])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p></pre>
for (name, recipe) in fields.items():
<pre>if isinstance(recipe, ColumnRecipe):
make_field(name, 'column')
make_column(name, recipe.column.domain.family,
not recipe.column.is_nullable)
elif isinstance(recipe, AttachedTableRecipe):
target_table_name = table_handles.get(recipe.target_table)
if target_table_name:
make_field(name, 'link')
make_link(name, recipe.is_singular, target_table_name)
if recipe.is_direct:
link_by_fk[recipe.joins[0].foreign_key] = 
(table_name, name)
elif recipe.is_reverse:
reverse_links.append((table_name, name,
recipe.joins[0].foreign_key))
else:</p>
<h1>this is a complex link, and we don't bother</h1>
<h1>tracking reverse links for them</h1>
<p>pass
else:</p>
<h1>at this point, we don't handle anything other</h1>
<h1>than Columns or Links (attached tables)</h1>
<p>pass
</pre>
for (table_name, name, foreign_key) in reverse_links:
if foreign_key in link_by_fk:
(target_table_name, reverse_link_name) = link_by_fk[foreign_key]
cursor.execute("""
UPDATE "link" SET reverse_link_name = ?
WHERE table_name = ? AND name = ?
, [reverse_link_name, table_name, name])</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
