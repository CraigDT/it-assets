<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>flow.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>flow.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql.tr.flow</code></h1>
<p>This module declares flow and code nodes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="p">(</span><span class="n">maybe</span><span class="p">,</span> <span class="n">listof</span><span class="p">,</span> <span class="n">tupleof</span><span class="p">,</span> <span class="n">Clonable</span><span class="p">,</span> <span class="n">Comparable</span><span class="p">,</span> <span class="n">Printable</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..entity</span> <span class="kn">import</span> <span class="n">TableEntity</span><span class="p">,</span> <span class="n">ColumnEntity</span><span class="p">,</span> <span class="n">Join</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">BooleanDomain</span>
<span class="kn">from</span> <span class="nn">.syntax</span> <span class="kn">import</span> <span class="n">IdentifierSyntax</span>
<span class="kn">from</span> <span class="nn">.binding</span> <span class="kn">import</span> <span class="n">Binding</span><span class="p">,</span> <span class="n">QueryBinding</span><span class="p">,</span> <span class="n">SegmentBinding</span>
<span class="kn">from</span> <span class="nn">.signature</span> <span class="kn">import</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">Bag</span><span class="p">,</span> <span class="n">Formula</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Represents an expression node.</p>
<p>This is an abstract class; most of its subclasses belong to one of the
two categories: <em>flow</em> and <em>code</em> nodes (see :class:<code>Flow</code> and
:class:<code>Code</code>).</p>
<p>A flow graph is an intermediate phase of the HTSQL translator.  It is
translated from the binding graph by the <em>encoding</em> process.  The flow
graph is used to <em>compile</em> the term tree and then <em>assemble</em> the frame
structure.</p>
<p>A flow graph reflects the flow structure of the HTSQL query: each
expression node represents either a data flow or an expression over
a data flow.</p>
<p>Expression nodes support equality by value: that is, two expression
nodes are equal if they are of the same type and all their (essential)
attributes are equal.  Some attributes (e.g. <code>binding</code>) are not
considered essential and do not participate in comparison.  By-value
semantics is respected when expression nodes are used as dictionary
keys.</p>
<p>The constructor arguments:</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.Binding</code>)
<pre>The binding node that gave rise to the expression; should be used
only for presentation or error reporting.
</pre>
<code>equality_vector</code> (an immutable tuple or <code>None</code>)
Encapsulates all essential attributes of a node.  Two expression
nodes are considered equal if they are of the same type and their
equality vectors are equal.  If <code>None</code>, the node is compared by
identity.</p>
<p>Note that the <code>binding</code> attribute is not essential and should not
be a part of the equality vector.</p>
<p>Other attributes:</p>
<p><code>syntax</code> (:class:<code>htsql.tr.syntax.Syntax</code>)
The syntax node that gave rise to the expression; for debugging
purposes only.</p>
<p><code>mark</code> (:class:<code>htsql.mark.Mark</code>)
The location of the node in the original query; for error reporting.</p>
<p><code>hash</code> (an integer)
The node hash; if two nodes are considered equal, their hashes
must be equal too.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Expression</span><span class="p">(</span><span class="n">Comparable</span><span class="p">,</span> <span class="n">Clonable</span><span class="p">,</span> <span class="n">Printable</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">Binding</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equality_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span> <span class="o">=</span> <span class="n">binding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">syntax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mark</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">syntax</span><span class="o">.</span><span class="n">mark</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>Display the syntex node that gave rise to the expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syntax</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>Represents the whole HTSQL query.</p>
<p><code>segment</code> (:class:<code>SegmentExpr</code> or <code>None</code>)
<pre>The query segment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">QueryExpr</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="n">SegmentExpr</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">QueryBinding</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QueryExpr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p></pre>Represents a segment of an HTSQL query.</p>
<p><code>flow</code> (:class:<code>Flow</code>)
<pre>The output flow of the segment.
</pre>
<code>elements</code> (a list of :class:<code>Code</code>)
The output columns of the segment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">SegmentExpr</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">SegmentBinding</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SegmentExpr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">elements</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p>Represents the target class of a flow.</p>
<p>The flow family specifies the type of values produced by
a flow.  There are three distinct flow families:</p>
<ul>
<li><em>scalar</em>, which indicates that the flow produces
scalar values;</li>
<li><em>table</em>, which indicates that the flow produces
records from a database table;</li>
<li><em>quotient</em>, which indicates that the flow produces
records from a derived <em>quotient</em> class.</li>
</ul>
<p>Class attributes:</p>
<p><code>is_scalar</code> (Boolean)
<pre>Set for a scalar family.
</pre>
<code>is_table</code> (Boolean)
Set for a table family.</p>
<p><code>is_quotient</code> (Boolean)
Set for a quotient family.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Family</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_scalar</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_table</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_quotient</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p>Represents a scalar flow family.</p>
<p>A scalar flow produces values of a primitive type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ScalarFamily</span><span class="p">(</span><span class="n">Family</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_scalar</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p>Represents a table flow family.</p>
<p>A table flow produces records from a database table.</p>
<p><code>table</code> (:class:<code>htsql.entity.TableEntity</code>)
<pre>The table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">TableFamily</span><span class="p">(</span><span class="n">Family</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_table</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">TableEntity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p></pre>Represents a quotient flow family.</p>
<p>A quotient flow produces records from a derived quotient class.</p>
<p>The quotient class contains records formed from the kernel expressions
as they run over the <code>seed</code> flow.</p>
<p><code>seed</code> (:class:<code>Flow</code>)
<pre>The dividend flow.
</pre>
<code>ground</code> (:class:<code>Flow</code>)
The ground flow of the dividend.</p>
<p><code>kernels</code> (list of :class:<code>Code</code>)
The kernel expressions of the quotient.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">QuotientFamily</span><span class="p">(</span><span class="n">Family</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_quotient</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">ground</span><span class="p">,</span> <span class="n">kernels</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ground</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ground</span><span class="o">.</span><span class="n">is_axis</span> <span class="ow">and</span> <span class="n">seed</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">ground</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernels</span> <span class="o">=</span> <span class="n">kernels</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p>Represents a flow node.</p>
<p>A data flow is a sequence of homogeneous values.  A flow is generated
by a series of flow operations applied sequentially to the root flow.</p>
<p>Each flow operation takes an input flow as an argument and produces
an output flow as a result.  The operation transforms each element
from the input row into zero, one, or more elements of the output
flow; the generating element is called <em>the origin</em> of the generated
elements.  Thus, with every element of a flow, we could associate
a sequence of origin elements, one per each elementary flow operation
that together produce the flow.</p>
<p>Each instance of :class:<code>Flow</code> represents a single flow operation
applied to some input flow.  The <code>base</code> attribute of the instance
represents the input flow while the type of the instance and the
other attributes reflect the properies of the operation.  The root
flow is denoted by an instance of:class:<code>RootFlow</code>, different
subclasses of :class:<code>Flow</code> correspond to different types of
flow operations.</p>
<p>The type of values produced by a flow is indicated by the <code>family</code>
attribute.  We distinguish three flow families: <em>scalar</em>, <em>table</em>
and <em>quotient</em>.  A scalar flow produces values of an elementary data
type; a table flow produces records of some table; a quotient flow
produces elements of a derived quotient class.</p>
<p>Among others, we consider the following flow operations:</p>
<p><em>The root flow</em> <code>I</code>
<pre>The initial flow that contains one empty record.
</pre>
<em>A direct product</em> <code>A * T</code>
Given a scalar flow <code>A</code> and a table <code>T</code>, the direct product
<code>A * T</code> generates all records of <code>T</code> for each element of <code>A</code>.</p>
<p><em>A fiber product</em> <code>A . T</code>
Given an input flow <code>A</code> that produces records of some table <code>S</code>
and a table <code>T</code> linked to <code>S</code>, for each element of <code>A</code>,
the fiber product <code>A . T</code> generates all associated records
from <code>T</code>.</p>
<p><em>Filtering</em> <code>A ? p</code>
Given a flow <code>A</code> and a predicate <code>p</code> defined on <code>A</code>,
the filtered flow <code>A ? p</code> consists of all elements of <code>A</code>
satisfying condition <code>p</code>.</p>
<p><em>Ordering</em> <code>A [e,...]</code>
Given a flow <code>A</code> and a list of expressions <code>e,...</code>, the
ordered flow <code>A [e,...]</code> consists of elements of <code>A</code> reordered
by the values of <code>e,...</code>.</p>
<p><em>Quotient</em> <code>A ^ k</code>
Given a flow <code>A</code> and a kernel expression <code>k</code> defined on <code>A</code>,
a quotient <code>A ^ k</code> produces all unique values of the kernel
as it runs over <code>A</code>.</p>
<p>Flow operations for which the output flow does not consist of
elements of the input flow are called <em>axial</em>.  If we take an
arbitrary flow <code>A</code>, disassemble it into individual operations,
and then reapply only axial operations, we get the new flow <code>A'</code>,
which we call <em>the inflation</em> of <code>A</code>.  Note that elements of <code>A</code>
form a subset of elements of <code>A'</code>.</p>
<p>Now we can establish how different flows are related to each other.
Formally, for each pair of flows <code>A</code> and <code>B</code>, we define a relation
<code>&lt;-&gt;</code> ("converges to") on elements from <code>A</code> and <code>B</code>, that is,
a subset of the Cartesian product <code>A x B</code>, by the following rules:</p>
<p>(1) For any flow <code>A</code>, <code>&lt;-&gt;</code> is the identity relation on <code>A</code>,
that is, each element converges only to itself.</p>
<p>For a flow <code>A</code> and its inflation <code>A'</code>, each element from <code>A</code>
converges to an equal element from <code>A'</code>.</p>
<p>(2) Suppose <code>A</code> and <code>B</code> are flows such that <code>A</code> is produced
from <code>B</code> as a result of some axial flow operation.  Then
each element from <code>A</code> converges to its origin element
from <code>B</code>.</p>
<p>By transitivity, we could extend <code>&lt;-&gt;</code> on <code>A</code> and any of its
<em>ancestor flows</em>, that is, the parent flow of <code>A</code>, the
parent of the parent of <code>A</code> and so on.</p>
<p>In particular, this defines <code>&lt;-&gt;</code> on an arbitrary flow <code>A</code>
and the root flow <code>I</code> since <code>I</code> is an ancestor of any flow.
By the above definition, any element of <code>A</code> converges to
the (only) record of <code>I</code>.</p>
<p>(3) Finally, we are ready to define <code>&lt;-&gt;</code> on an arbitrary pair
of flows <code>A</code> and <code>B</code>.  First, suppose that <code>A</code> and <code>B</code>
share the same inflated flow: <code>A' = B'</code>.  Then we could
define <code>&lt;-&gt;</code> on <code>A</code> and <code>B</code> transitively via <code>A'</code>: <code>a</code> from <code>A</code>
converges to <code>b</code> from <code>B</code> if there exists <code>a'</code> from <code>A'</code> such
that <code>a &lt;-&gt; a'</code> and <code>a' &lt;-&gt; b</code>.</p>
<p>In the general case, find the closest ancestors <code>C</code> of <code>A</code>
and <code>D</code> of <code>B</code> such that <code>C</code> and <code>D</code> have the same
inflated flow: <code>C' = D'</code>.  Rules <code>(1)</code> and <code>(2)</code> establish
<code>&lt;-&gt;</code> for the pairs <code>A</code> and <code>C</code>, <code>C</code> and <code>C' = D'</code>,
<code>C' = D'</code> and <code>D</code>, and <code>D</code> and <code>B</code>.  We define <code>&lt;-&gt;</code>
on <code>A</code> and <code>B</code> transitively: <code>a</code> from <code>A</code> converges to
<code>b</code> from <code>B</code> if there exist elements <code>c</code> from <code>C</code>,
<code>c'</code> from <code>C' = D'</code>, <code>d</code> from <code>D</code> such that
<code>a &lt;-&gt; c &lt;-&gt; c' &lt;-&gt; d &lt;-&gt; b</code>.</p>
<p>Note that it is important that we take among the common inflated
ancestors the closest one.  Any two flows have a common inflated
ancestor: the root flow.  If the root flow is, indeed, the closest
common inflated ancestor of <code>A</code> and <code>B</code>, then each element of <code>A</code>
converges to every element of <code>B</code>.</p>
<p>Now we are ready to introduce several important relations between
flows:</p>
<p><code>A</code> <em>spans</em> <code>B</code>
A flow <code>A</code> spans a flow <code>B</code> if for every element <code>a</code> from <code>A</code>:</p>
<pre>`card { b` from `B | a <-> b } <= 1`.
</pre>

<p>Informally, it means that the statement::</p>
<p>SELECT * FROM A</p>
<p>and the statement::</p>
<p>SELECT * FROM A LEFT OUTER JOIN B ON (A &lt;-&gt; B)</p>
<p>produce the same number of rows.</p>
<p><code>A</code> <em>dominates</em> <code>B</code>
A flow <code>A</code> dominates a flow <code>B</code> if <code>A</code> spans <code>B</code> and
for every element <code>b</code> from <code>B</code>:</p>
<p><code>card { a</code> from <code>A | a &lt;-&gt; b } &gt;= 1</code>.</p>
<p>Informally, it implies that the statement::</p>
<p>SELECT * FROM B INNER JOIN A ON (A &lt;-&gt; B)</p>
<p>and the statement::</p>
<p>SELECT * FROM B LEFT OUTER JOIN A ON (A &lt;-&gt; B)</p>
<p>produce the same number of rows.</p>
<p><code>A</code> <em>conforms</em> <code>B</code>
A flow <code>A</code> conforms a flow <code>B</code> if <code>A</code> dominates <code>B</code>
and <code>B</code> dominates <code>A</code>.  Alternatively, we could say
<code>A</code> conforms <code>B</code> if the <code>&lt;-&gt;</code> relation establishes
a bijection between <code>A</code> and <code>B</code>.</p>
<p>Informally, it means that the statement::</p>
<p>SELECT * FROM A</p>
<p>and the statement::</p>
<p>SELECT * FROM B</p>
<p>produce the same number of rows.</p>
<p>Note that <code>A</code> conforming <code>B</code> is not the same as <code>A</code> being equal
to <code>B</code>; even if <code>A</code> conforms <code>B</code>,  elements of <code>A</code> and <code>B</code> may
be of different types, therefore as sets, they are different.</p>
<p>Now take an arbitrary flow <code>A</code> and its parent flow <code>B</code>.  We say:</p>
<p><code>A</code> <em>contracts</em> <code>B</code>
A flow <code>A</code> contracts its parent <code>B</code> if for any element from <code>B</code>
there is no more than one converging element from <code>A</code>.</p>
<p>Typically, it is non-axis flows that contract their bases,
although in some cases, an axis flow could do it too.</p>
<p><code>A</code> <em>expands</em> <code>B</code>
A flow <code>A</code> expands its parent <code>B</code> if for any element from <code>B</code>
there is at least one converging element from <code>A</code>.</p>
<p>Note that it is possible that a flow <code>A</code> both contracts and
expands its base <code>B</code>, and also that <code>A</code> neither contracts
nor expands <code>B</code>.  The former means that <code>A</code> conforms <code>B</code>.
The latter holds, in particular, for the direct table flow
<code>A * T</code>.  <code>A * T</code> violates the contraction condition when
<code>T</code> contains more than one record and violates the expansion
condition when <code>T</code> has no records.</p>
<p>A few words about how elements of a flow are ordered.  The default
(also called <em>weak</em>) ordering rules are:</p>
<ul>
<li>
<p>a table flow <code>T = I * T</code> is sorted by the lexicographic order
of the table primary key;</p>
</li>
<li>
<p>a non-axial flow keeps the order of its base;</p>
</li>
<li>
<p>an axial table flow <code>A * T</code> or <code>A . T</code> respects the order its
base <code>A</code>; records with the same origin are sorted by the table order.</p>
</li>
</ul>
<p>An alternative sort order could be specified explicitly (also called
<em>strong</em> ordering).  Whenever strong ordering is  specified, it
overrides the weak ordering.  Thus, elements of an ordered flow <code>A [e]</code>
are sorted first by expression <code>e</code>, and then elements which are not
differentiated by <code>e</code> are sorted using the weak ordering of <code>A</code>.
However, if <code>A</code> already has a strong ordering, it must be respected.
Therefore, the general rule for sorting <code>A [e]</code> is:</p>
<ul>
<li>
<p>first, sort the flow by the strong ordering of <code>A</code>;</p>
</li>
<li>
<p>then, by <code>e</code>;</p>
</li>
<li>
<p>finally, by the weak ordering of <code>A</code>.</p>
</li>
</ul>
<p>Class attributes:</p>
<p><code>is_axis</code> (Boolean)
Indicates whether the flow is axial, that is, the elements
of the flow do not necessarily coincide with their origins.</p>
<p><code>is_root</code> (Boolean)
Indicates that the flow is the root flow.</p>
<p>The constructor arguments:</p>
<p><code>base</code> (:class:<code>Flow</code> or <code>None</code>)
The parent input flow; <code>None</code> for the root flow.</p>
<p><code>family</code> (:class:<code>Family</code>)
Specifies the type of the elements produced by the flow.</p>
<p><code>is_contracting</code> (Boolean)
Indicates if the flow contracts its base flow.</p>
<p><code>is_expanding</code> (Boolean)
Indicates if the flow expands its base flow.</p>
<p>Other attributes:</p>
<p><code>is_inflated</code> (Boolean)
Indicates if the flow is an inflation, that is, this flow
operation and all its ancestors are axial.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Flow</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_root</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span>
                 <span class="n">is_contracting</span><span class="p">,</span> <span class="n">is_expanding</span><span class="p">,</span>
                 <span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="n">Flow</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">Family</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_contracting</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_expanding</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Flow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_contracting</span> <span class="o">=</span> <span class="n">is_contracting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_expanding</span> <span class="o">=</span> <span class="n">is_expanding</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p>Indicates that the flow itself and all its ancestors are axes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">is_inflated</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_root</span> <span class="ow">or</span>
                            <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">is_inflated</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_axis</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p>Produces a list of ancestor flows.</p>
<p>The method returns a list composed of the flow itself,
its base, the base of its base and so on.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">unfold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ancestor</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">ancestor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <p>Note: <code>ancestor.base</code> is None for the root flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">base</span>
        <span class="k">return</span> <span class="n">ancestors</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>Verifies if the flows represent the same operation.</p>
<p>Typically, it means that <code>self</code> and <code>other</code> have the same type
and equal attributes, but may have different bases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">resembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        <p>We rely upon an assumption that the equality vector of a flow node
is a tuple of all its essential attributes and the first element
of the tuple is the flow base.  So we skip the base flow and
compare the remaining attributes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equality_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">equality_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p>Produces the inflation of the flow.</p>
<p>If we represent a flow as a series of operations sequentially
applied to the scalar flow, the inflation of the flow is obtained
by ignoring any non-axial operations and applying axial operations
only.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">inflate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>Shortcut: check if the flow is already an inflation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_inflated</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p>This is going to become a new inflated flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Iterate over all ancestors starting from the scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">()):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <p>Skip non-axial operations, reapply axial operations to
a new base.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <p>This is the inflated flow now.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>Prunes shared non-axial operations.</p>
<p>Given flows <code>A</code> and <code>B</code>, this function produces a new flow
<code>A'</code> such that <code>A</code> is a subset of <code>A'</code> and the convergence
of <code>A</code> and <code>B</code> coincides with the convergence of <code>A'</code> and <code>B</code>.
This is done by pruning any non-axial operations of <code>A</code> that
also occur in <code>B</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p>Sanity check on the argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        <p>Shortcut: we cannot further prune an inflated flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_inflated</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p>Unfold the flows into individual operations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">my_ancestors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span>
        <span class="n">their_ancestors</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        <p>This is going to become the pruned flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Iterate until the ancestors are exhausted or diverged.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">my_ancestors</span> <span class="ow">and</span> <span class="n">their_ancestors</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        <p>Get the next operation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">my_ancestor</span> <span class="o">=</span> <span class="n">my_ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">their_ancestor</span> <span class="o">=</span> <span class="n">their_ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Compare the ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">resembles</span><span class="p">(</span><span class="n">their_ancestor</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p>So both ancestors represent the same operation.
If it is an axis operation, apply it; otherwise,
discard it.
FIXME: may break if the flow contains a non-matching
<code>limit/offset</code> operation?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">if</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span>
                    <span class="n">flow</span> <span class="o">=</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">flow</span><span class="p">)</span>
                <span class="n">my_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">their_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>The ancestors represent different operations and <code>B</code>'s
ancestor is not an axis.  Discard it, we will try the
next ancestor.
FIXME: we may miss an opportunity to compare <code>B</code>'s ancestor
with other <code>A</code>'s ancestors.  It is not a big deal though,
we do not need to generate an optimal result here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">their_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        <p>The ancestors represent different operations, <code>B</code>'s ancestor
is an axis, and <code>A</code>'s ancestor is not.  Here we apply the
<code>A</code>'s ancestor.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">flow</span> <span class="o">=</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">flow</span><span class="p">)</span>
                <span class="n">my_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>The ancestors are both axial and differ from each other.
At this point, the ancestors diverge and are not
comparable anymore.  Break from the loop.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">break</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>Reapply the unprocessed ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">my_ancestors</span><span class="p">:</span>
            <span class="n">my_ancestor</span> <span class="o">=</span> <span class="n">my_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p>We have a pruned flow here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p>Verifies if the flow spans another flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">spans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p>Sanity check on the argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        <p>Shortcut: any flow spans itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        <p>Extract axial ancestors from both flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">my_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ancestor</span> <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">]</span>
        <span class="n">their_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ancestor</span> <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        <p>Iterate until the axes are exhausted or diverged.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">my_axes</span> <span class="ow">and</span> <span class="n">their_axes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Check if the next pair of axes represent the same operation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">my_axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">resembles</span><span class="p">(</span><span class="n">their_axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        <p>If so, go compare the next pair of axes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">my_axes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">their_axes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        <p>Otherwise, the axes diverge.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">break</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        <p>At this point, all processed pairs of axes converge by identity.
If the other flow has no more axes left, it is spanned.  Otherwise,
it is spanned only if its remaining unprocessed axes represent
contracting operations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">their_axis</span> <span class="ow">in</span> <span class="n">their_axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">their_axis</span><span class="o">.</span><span class="n">is_contracting</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>Verifies if the flow conforms another flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">conforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        <p>Sanity check on the argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        <p>Shortcut: any flow conforms itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        <p>Unfold the flows into individual operations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">my_ancestors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span>
        <span class="n">their_ancestors</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        <p>Iterate until the ancestors are exhausted or diverged.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">my_ancestors</span> <span class="ow">and</span> <span class="n">their_ancestors</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        <p>Get the next pair of ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">my_ancestor</span> <span class="o">=</span> <span class="n">my_ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">their_ancestor</span> <span class="o">=</span> <span class="n">their_ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        <p>Compare the ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">resembles</span><span class="p">(</span><span class="n">their_ancestor</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        <p>If the ancestors represent the same operation, we could
proceed to the next pair of ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">my_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">their_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">my_ancestor</span><span class="o">.</span><span class="n">is_contracting</span> <span class="ow">and</span>
                  <span class="n">my_ancestor</span><span class="o">.</span><span class="n">is_expanding</span> <span class="ow">and</span>
                  <span class="ow">not</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Ok, the ancestors represent different operations, but
one of them is not an axis and does not change the
cardinality of its base.  We could skip this ancestor
and proceed further.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">my_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_contracting</span> <span class="ow">and</span>
                  <span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_expanding</span> <span class="ow">and</span>
                  <span class="ow">not</span> <span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        <p>Same with the other ancestor.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">their_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        <p>The ancestors start to diverge; break from the loop.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">break</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        <p>If all ancestors are processed, the flows conform each other.
Otherwise, they conform each other only if the remaining unprocessed
ancestors do not change the cardinality of their bases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">my_ancestors</span> <span class="o">+</span> <span class="n">their_ancestors</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ancestor</span><span class="o">.</span><span class="n">is_contracting</span> <span class="ow">and</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">is_expanding</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        <p>Verifies if the flow dominates another flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dominates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        <p>Sanity check on the argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        <p>Shortcut: any flow dominates itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        <p>Unfold the flows into individual operations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">my_ancestors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span>
        <span class="n">their_ancestors</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        <p>Iterate until the ancestors are exhausted or diverged.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">my_ancestors</span> <span class="ow">and</span> <span class="n">their_ancestors</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        <p>Get the next pair of ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">my_ancestor</span> <span class="o">=</span> <span class="n">my_ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">their_ancestor</span> <span class="o">=</span> <span class="n">their_ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        <p>Compare the ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">resembles</span><span class="p">(</span><span class="n">their_ancestor</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        <p>If the ancestors represent the same operation, we could
proceed to the next pair of ancestors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">my_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">their_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_contracting</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        <p>We got ancestors representing different operations; however
the dominated ancestor represents a non-axis operation that
does not increase the cardinality of its base.  Therefore
we could ignore this ancestor and proceed further.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">their_ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        <p>The ancestors start to diverge; break from the loop.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">break</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        <p>If all ancestors are processed, the flow dominates the other.
Otherwise, it is only possible if the remaining ancestors of
the flow do not decrease the base cardinality while the
remaining ancestors of the other flow do not increase the
base cardinality.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">my_ancestor</span> <span class="ow">in</span> <span class="n">my_ancestors</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">my_ancestor</span><span class="o">.</span><span class="n">is_expanding</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">their_ancestor</span> <span class="ow">in</span> <span class="n">their_ancestors</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">their_ancestor</span><span class="o">.</span><span class="n">is_contracting</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        <p>Verifies if the other flow is a ancestor of the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">concludes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        <p>Sanity check on the argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        <p>Iterate over all ancestors of the flow comparing them with
the given other flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">flow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flow</span> <span class="o">==</span> <span class="n">other</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>None of the ancestors matched, the flows must be unrelated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>Represents a root scalar flow.</p>
<p>A root flow <code>I</code> contains one record <code>()</code>.  Any other flow is generated
by applying a sequence of elementary flow operations to <code>I</code>.</p>
<p><code>base</code> (always <code>None</code>)
<pre>The root flow (and only the root flow) has no parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RootFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        <p>Scalar flow is an axial flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">is_root</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        <p>We keep <code>base</code> among constructor arguments despite it always being
equal to <code>None</code> to make
  flow = flow.clone(base=new_base)
work for all types of flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">base</span> <span class="ow">is</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <p>Note that we must satisfy the assumption that the first element
of the equality vector is the flow base (used by <code>Flow.resembles</code>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">RootFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">ScalarFamily</span><span class="p">(),</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        <p>Display a table expression in an algebraic form.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;I&quot;</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        <p></pre>Represents a link to the scalar class.</p>
<p>Traversing a link to the scalar class produces an empty record <code>()</code>
for each element of the input flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ScalarFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ScalarFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">ScalarFamily</span><span class="p">(),</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        <p>Display:
  (<base> * I)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> * I)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        <p>Represents a product of an input flow to a table.</p>
<p>A product operation generates a subset of a Cartesian product
between the base flow and records of a table.  This is an abstract
class, see concrete subclasses :class:<code>DirectTableFlow</code> and
:class:<code>FiberTableFlow</code>.</p>
<p><code>table</code> (:class:<code>htsql.entity.TableEntity</code>)
<pre>The table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">TableFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <p>All subclasses of <code>TableFlow</code> are axial flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        <p></pre>Represents a direct product between a scalar flow and a table.</p>
<p>A direct product <code>A * T</code> produces all records of the table <code>T</code>
for each element of the input flow <code>A</code>.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>table</code> (:class:<code>htsql.entity.TableEntity</code>)
The table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">DirectTableFlow</span><span class="p">(</span><span class="n">TableFlow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">is_scalar</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DirectTableFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">TableFamily</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        <p>Display:
  (<base> * <schema>.<table>)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> * </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">table</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        <p>Represents a fiber product between a table flow and a linked table.</p>
<p>Let <code>A</code> be a flow producing records of table <code>S</code>, <code>j</code> be a join
condition between tables <code>S</code> and <code>T</code>.  A fiber product <code>A .j T</code>
(or <code>A . T</code> when the join condition is implied) of the flow <code>A</code>
and the table <code>T</code> is a sequence of records of <code>T</code> that for each
record of <code>A</code> generates all records of <code>T</code> satisfying the join
condition <code>j</code>.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>join</code> (:class:<code>htsql.entity.Join</code>)
The join condition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">FiberTableFlow</span><span class="p">(</span><span class="n">TableFlow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">join</span><span class="p">,</span> <span class="n">Join</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        <p>Check that the join origin is the table of the base flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">is_table</span>
        <span class="k">assert</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="n">join</span><span class="o">.</span><span class="n">origin</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FiberTableFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">TableFamily</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">target</span><span class="p">),</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="n">join</span><span class="o">.</span><span class="n">is_contracting</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="n">join</span><span class="o">.</span><span class="n">is_expanding</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">join</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span> <span class="o">=</span> <span class="n">join</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        <p>Display:
  (<base> . <schema>.<table>)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> . </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">table</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        <p>Represents a quotient operation.</p>
<p>A quotient operation takes three arguments: an input flow <code>A</code>,
a seed flow <code>S</code>, which should be a descendant of the input flow,
and a kernel expression <code>k</code> on the seed flow.  For each element
of the input flow, the output flow <code>A . (S ^ k)</code> generates unique
values of <code>k</code> as it runs over convergent elements of <code>S</code>.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>seed</code> (:class:<code>Flow</code>)
The seed flow of the quotient; must be a descendant
of the base flow.</p>
<p><code>kernels</code> (a list of :class:<code>Code</code>)
Kernel expressions of the quotient.</p>
<p><code>companions</code> (a list of :class:<code>Code</code>)
An auxiliary hint to the compiler indicating that the term
representing the flow needs to export extra aggregate units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
<p>Other attributes:</p>
<p><code>ground</code> (:class:<code>Flow</code>)
The closest axial ancestor of <code>seed</code> that is spanned
by the <code>base</code> flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">QuotientFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span>
                 <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>Check that <code>seed</code> is a plural descendant of <code>base</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        <p>Find an ancestor of <code>seed</code> that is spanned by <code>base</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ground</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">ground</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
            <span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        <p>The quotient flow conforms its base flow only when
the kernel expression is constant.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_contracting</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">kernels</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        <p>FIXME: this is wrong, but the assembler relies on it
to collapse <code>GROUP BY</code> to the segment frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_expanding</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">is_root</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kernels</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QuotientFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">QuotientFamily</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">ground</span><span class="p">,</span> <span class="n">kernels</span><span class="p">),</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="n">is_contracting</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="n">is_expanding</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kernels</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernels</span> <span class="o">=</span> <span class="n">kernels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        <p>Display:
  (<base> . (<seed> ^ {<kernels>}))</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> . (</span><span class="si">%s</span><span class="s"> ^ {</span><span class="si">%s</span><span class="s">}))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                        <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        <p>Represents a complement to a quotient.</p>
<p>A complement takes a quotient as an input flow and generates
elements of the quotient seed.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>companions</code> (list of :class:<code>Code</code>)
An auxiliary hint to the compiler indicating that the term
representing the flow needs to export extra covering units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
<p>Other attributes:</p>
<p><code>seed</code> (:class:<code>Flow</code>)
The seed flow of the quotient.</p>
<p><code>ground</code> (:class:<code>Flow</code>)
The grond flow of the quotient.</p>
<p><code>kernels</code> (list of :class:<code>Code</code>)
Kernel expressions of the quotient.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ComplementFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">is_quotient</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComplementFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernels</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">kernels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        <p>Display:
  (<base> . ^)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> . ^)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        <p>Represents an moniker operation.</p>
<p>A moniker masks an arbitrary sequence of operations
as a single axial flow operation.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>seed</code> (:class:<code>Flow</code>)
The seed flow.</p>
<p><code>companions</code> (list of :class:<code>Code</code>)
An auxiliary hint to the compiler indicating that the term
representing the flow must export extra covering units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
<p>Other attributes:</p>
<p><code>ground</code> (:class:<code>Flow</code>)
The closest axial ancestor of <code>seed</code> spanned by <code>base</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">MonikerFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        <p>We don't need <code>seed</code> to be plural or even axial against <code>base</code>.
assert not base.spans(seed)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        <p>Determine an axial ancestor of <code>seed</code> spanned by <code>base</code>
(could be <code>seed</code> itself).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ground</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">ground</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span>
            <span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span><span class="o">.</span><span class="n">base</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">ground</span><span class="p">):</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">ground</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
                <span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span><span class="o">.</span><span class="n">base</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MonikerFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">seed</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="n">seed</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">base</span><span class="p">),</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        <p>Display:
  (<base> . (<seed>))</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> . (</span><span class="si">%s</span><span class="s">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>Represents a fork expression.</p>
<p>A fork expression associated each element of the input flow
with every element of the input flow sharing the same origin
and values of the kernel expression.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>seed</code> (:class:<code>Flow</code>)
The flow to fork (typically coincides with the base flow).</p>
<p><code>kernels</code> (list of :class:<code>Code</code>)
The kernel expressions.</p>
<p><code>companions</code> (list of :class:<code>Code</code>)
An auxiliary hint to the compiler indicating that the term
representing the flow must export extra covering units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
<p>Other attributes:</p>
<p><code>ground</code> (:class:<code>Flow</code>)
The closest axial ancestor of the seed flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ForkedFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="ow">and</span> <span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>FIXME: this condition could be violated after the rewrite step
(also, equal-by-value is not implemented for <code>Family</code>):
assert base.family == seed.family</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kernels</span>
                                          <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="n">ground</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">ground</span><span class="o">.</span><span class="n">is_axis</span><span class="p">:</span>
            <span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span><span class="o">.</span><span class="n">base</span>
        <span class="n">is_contracting</span> <span class="o">=</span> <span class="n">ground</span><span class="o">.</span><span class="n">is_contracting</span>
        <span class="n">is_expanding</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">kernels</span> <span class="ow">and</span> <span class="n">seed</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForkedFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="n">is_contracting</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="n">is_expanding</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kernels</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernels</span> <span class="o">=</span> <span class="n">kernels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        <p>Display:
  (<base> . fork({<kernels>}))</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> . fork({</span><span class="si">%s</span><span class="s">}))&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernels</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        <p>Represents a linking operation.</p>
<p>A linking operation generates, for every element of the input flow,
convergent elements from the seed flow with the same image value.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>seed</code> (:class:<code>Flow</code>)
The seed flow.</p>
<p><code>images</code> (list of pairs of :class:<code>Code</code>)
Pairs of expressions forming a fiber join condition.</p>
<p><code>companions</code> (list of :class:<code>Code</code>)
An auxiliary hint to the compiler indicating that the term
representing the flow must export extra covering units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
<p>Other attributes:</p>
<p><code>ground</code> (:class:<code>Flow</code>)
The closest axial ancestor of <code>seed</code> spanned by <code>base</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">LinkedFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_axis</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">tupleof</span><span class="p">(</span><span class="n">Code</span><span class="p">,</span> <span class="n">Code</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">images</span>
                                         <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">lop</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">images</span>
                                         <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">rop</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="n">ground</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">ground</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
            <span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span><span class="o">.</span><span class="n">base</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LinkedFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">seed</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">images</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground</span> <span class="o">=</span> <span class="n">ground</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        <p>Display:
  (<base> . ({<limages>} -&gt; <seed>{<rimages>}))</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> . ({</span><span class="si">%s</span><span class="s">} -&gt; </span><span class="si">%s</span><span class="s">{</span><span class="si">%s</span><span class="s">}))&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lop</span><span class="p">)</span> <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span> <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        <p>Represents a filtering operation.</p>
<p>A filtered flow <code>A ? f</code>, where <code>A</code> is the input flow and <code>f</code> is
a predicate expression on <code>A</code>, consists of rows of <code>A</code> satisfying
the condition <code>f</code>.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>filter</code> (:class:<code>Code</code>)
The predicate expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">FilteredFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">Code</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilteredFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">filter</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">filter</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>Display:
  (<base> ? <filter>)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> ? </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        <p>Represents an ordered flow.</p>
<p>An ordered flow <code>A [e,...;p:q]</code> is a flow with explicitly specified
strong ordering.  It also may extract a slice of the input flow.</p>
<p><code>base</code> (:class:<code>Flow</code>)
<pre>The base flow.
</pre>
<code>order</code> (a list of pairs <code>(code, direction)</code>)
Expressions to sort the flow by.</p>
<p>Here <code>code</code> is a :class:<code>Code</code> instance, <code>direction</code> is either
<code>+1</code> (indicates ascending order) or <code>-1</code> (indicates descending
order).</p>
<p><code>limit</code> (a non-negative integer or <code>None</code>)
If set, the flow extracts the first <code>limit</code> rows from the base
flow (with respect to the flow ordering).  The remaining rows
are discarded.</p>
<p><code>offset</code> (a non-negative integer or <code>None</code>)
If set, indicates that when extracting rows from the base flow,
the first <code>offset</code> rows should be skipped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">OrderedFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p>FIXME: Non-commutativity of the ordered flow may affect <code>prune</code>
and other functions.  Add class attribute <code>is_commutative</code>?
Or override <code>resembles</code> to return <code>True</code> only for equal nodes?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">tupleof</span><span class="p">(</span><span class="n">Code</span><span class="p">,</span> <span class="nb">int</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OrderedFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">base</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                    <span class="n">family</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">is_contracting</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">is_expanding</span><span class="o">=</span><span class="p">(</span><span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">),</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">order</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        <p>Display:
  <base> [<code>,...;<offset>:<limit>+<offset>]</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">indicators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">+</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>
            <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="s">&quot;:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
            <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
        <span class="n">indicators</span> <span class="o">=</span> <span class="s">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">indicators</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>Represents a code expression.</p>
<p>A code expression is a function on flows.  Specifically, it is a
functional (possibly of several variables) that maps a flow
(or a Cartesian product of several flows) to some scalar domain.
:class:<code>Code</code> is an abstract base class for all code expressions;
see its subclasses for concrete types of expressions.</p>
<p>Among all code expressions, we distinguish <em>unit expressions</em>:
elementary functions on flows.  There are several kinds of units:
among them are table columns and aggregate functions (see :class:<code>Unit</code>
for more detail).  A non-unit code could be expressed as
a composition of a scalar function and one or several units:</p>
<pre>`f = f(a,b,...) = F(u(a),v(b),...)`,
</pre>

<p>where</p>
<ul>
<li><code>f</code> is a code expression;</li>
<li><code>F</code> is a scalar function;</li>
<li><code>a</code>, <code>b</code>, ... are elements of flows <code>A</code>, <code>B</code>, ...;</li>
<li><code>u</code>, <code>v</code>, ... are unit expressions on <code>A</code>, <code>B</code>, ....</li>
</ul>
<p>Note: special forms like <code>COUNT</code> or <code>EXISTS</code> are also expressed
as code nodes.  Since they are not regular functions, special care
must be taken to properly wrap them with appropriate
:class:<code>ScalarUnit</code> and/or :class:<code>AggregateUnit</code> instances.</p>
<p><code>domain</code> (:class:<code>htsql.domain.Domain</code>)
The co-domain of the code expression.</p>
<p><code>units</code> (a list of :class:<code>Unit</code>)
The unit expressions of which the code is composed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Code</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-160'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-160">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">Domain</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Unit</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Code</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-161'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-161">#</a>
        </div>
        <p>Represents a literal value.</p>
<p><code>value</code> (valid type depends on the domain)
<pre>The value.
</pre>
<code>domain</code> (:class:<code>htsql.domain.Domain</code>)
The value type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">LiteralCode</span><span class="p">(</span><span class="n">Code</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-162'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-162">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-163'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-163">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LiteralCode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-164'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-164">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-165'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-165">#</a>
        </div>
        <p>The actual value is often more helpful than the expression
that generated it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-166'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-166">#</a>
        </div>
        <p>Represents a type conversion operator.</p>
<p><code>base</code> (:class:<code>Code</code>)
<pre>The expression to convert.
</pre>
<code>domain</code> (:class:<code>htsql.domain.Domain</code>)
The target domain.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CastCode</span><span class="p">(</span><span class="n">Code</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-167'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-167">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-168'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-168">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CastCode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">domain</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-169'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-169">#</a>
        </div>
        <p>Represents a formula code.</p>
<p>A formula code represents a function or an operator call as a code node.</p>
<p><code>signature</code> (:class:<code>htsql.tr.signature.Signature</code>)
<pre>The signature of the formula.
</pre>
<code>domain</code> (:class:<code>Domain</code>)
The co-domain of the formula.</p>
<p><code>arguments</code> (a dictionary)
The arguments of the formula.</p>
<p>Note that all the arguments become attributes of the node object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">FormulaCode</span><span class="p">(</span><span class="n">Formula</span><span class="p">,</span> <span class="n">Code</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-170'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-170">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-171'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-171">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">Signature</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-172'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-172">#</a>
        </div>
        <p>Check that the arguments match the formula signature.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="n">Bag</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">arguments</span><span class="o">.</span><span class="n">admits</span><span class="p">(</span><span class="n">Code</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-173'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-173">#</a>
        </div>
        <p>Extract unit nodes from the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">cells</span><span class="p">():</span>
            <span class="n">units</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">equality_vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">arguments</span><span class="o">.</span><span class="n">freeze</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-174'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-174">#</a>
        </div>
        <p>The first two arguments are processed by the <code>Formula</code>
constructor, the rest of them go to the <code>Binding</code> constructor.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">FormulaCode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">signature</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="n">equality_vector</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-175'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-175">#</a>
        </div>
        <p>Represents a unit expression.</p>
<p>A unit is an elementary function on a flow.  There are several kinds
of units; see subclasses :class:<code>ColumnUnit</code>, :class:<code>ScalarUnit</code>,
:class:<code>AggregateUnit</code>, and :class:<code>CorrelatedUnit</code> for more detail.</p>
<p>Units are divided into two categories: <em>primitive</em> and <em>compound</em>.</p>
<p>A primitive unit is an intrinsic function of its flow; no additional
calculations are required to generate a primitive unit.  Currently,
the only example of a primitive unit is :class:<code>ColumnUnit</code>.</p>
<p>A compound unit requires calculating some non-intrinsic function
on the target flow.  Among compound units there are :class:<code>ScalarUnit</code>
and :class:<code>AggregateUnit</code>, which correspond respectively to
scalar and aggregate functions on a flow.</p>
<p>Note that it is easy to <em>lift</em> a unit code from one flow to another.
Specifically, suppose a unit <code>u</code> is defined on a flow <code>A</code> and <code>B</code>
is another flow such that <code>B</code> spans <code>A</code>.  Then for each row <code>b</code>
from <code>B</code> there is no more than one row <code>a</code> from <code>A</code> such that <code>a &lt;-&gt; b</code>.
Therefore we could define <code>u</code> on <code>B</code> as follows:</p>
<ul>
<li><code>u(b) = u(a)</code> if there exists <code>a</code> from <code>A</code> such that <code>a &lt;-&gt; b</code>;</li>
<li><code>u(b) =</code> <code>NULL</code> if there is no rows in <code>A</code> convergent to <code>b</code>.</li>
</ul>
<p>When a flow <code>B</code> spans the flow <code>A</code> of a unit <code>u</code>, we say that
<code>u</code> is <em>singular</em> on <code>B</code>.  By the previous argument, <code>u</code> could be
lifted to <code>B</code>.  Thus any unit is well-defined not only on the
flow where it is originally defined, but also on any flow where
it is singular.</p>
<p>Attributes:</p>
<p><code>flow</code> (:class:<code>Flow</code>)
<pre>The flow on which the unit is defined.
</pre>
<code>domain</code> (:class:<code>htsql.domain.Domain</code>)
The unit co-domain.</p>
<p>Class attributes:</p>
<p><code>is_primitive</code> (Boolean)
If set, indicates that the unit is primitive.</p>
<p><code>is_compound</code> (Boolean)
If set, indicates that the unit is compound.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Unit</span><span class="p">(</span><span class="n">Code</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-176'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-176">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_primitive</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_compound</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-177'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-177">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="n">equality_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-178'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-178">#</a>
        </div>
        <p>Verifies if the unit is singular (well-defined) on the given flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">singular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-179'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-179">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-180'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-180">#</a>
        </div>
        <p>Represents a primitive unit.</p>
<p>A primitive unit is an intrinsic function on a flow.</p>
<p>This is an abstract class; for the (only) concrete subclass, see
:class:<code>ColumnUnit</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">PrimitiveUnit</span><span class="p">(</span><span class="n">Unit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-181'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-181">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_primitive</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-182'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-182">#</a>
        </div>
        <p>Represents a compound unit.</p>
<p>A compound unit is some non-intrinsic function on a flow.</p>
<p>This is an abstract class; for concrete subclasses, see
:class:<code>ScalarUnit</code>, :class:<code>AggregateUnit</code>, etc.</p>
<p><code>code</code> (:class:<code>Code</code>)
<pre>The expression to evaluate on the unit flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompoundUnit</span><span class="p">(</span><span class="n">Unit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-183'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-183">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">is_compound</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-184'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-184">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">equality_vector</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">Code</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CompoundUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="n">equality_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-185'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-185">#</a>
        </div>
        <p></pre>Represents a column unit.</p>
<p>A column unit is a function on a flow that returns a column of the
prominent table of the flow.</p>
<p><code>column</code> (:class:<code>htsql.entity.ColumnEntity</code>)
<pre>The column produced by the unit.
</pre>
<code>flow</code> (:class:<code>Flow</code>)
The unit flow.  The flow must be of a table family and the flow
table must coincide with the column table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ColumnUnit</span><span class="p">(</span><span class="n">PrimitiveUnit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-186'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-186">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-187'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-187">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">ColumnEntity</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">is_table</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">schema_name</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="o">==</span> <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">schema_name</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">table_name</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ColumnUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">column</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-188'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-188">#</a>
        </div>
        <p>Represents a scalar unit.</p>
<p>A scalar unit is an expression evaluated in the specified flow.</p>
<p>Recall that any expression has the following form:</p>
<pre>`F(u(a),v(b),...)`,
</pre>

<p>where</p>
<ul>
<li><code>F</code> is a scalar function;</li>
<li><code>a</code>, <code>b</code>, ... are elements of flows <code>A</code>, <code>B</code>, ...;</li>
<li><code>u</code>, <code>v</code>, ... are unit expressions on <code>A</code>, <code>B</code>, ....</li>
</ul>
<p>We require that the units of the expression are singular on the given
flow.  If so, the expression units <code>u</code>, <code>v</code>, ... could be lifted to
the given slace (see :class:<code>Unit</code>).  The scalar unit is defined as</p>
<p><code>F(u(x),v(x),...)</code>,</p>
<p>where <code>x</code> is an element of the flow where the scalar unit is defined.</p>
<p><code>code</code> (:class:<code>Code</code>)
The expression to evaluate.</p>
<p><code>flow</code> (:class:<code>Flow</code>)
The flow on which the unit is defined.</p>
<p><code>companions</code> (list of :class:<code>Code</code>)
An auxiliary hint to the compiler indicating that the term
exporting the unit must also export extra scalar units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ScalarUnit</span><span class="p">(</span><span class="n">CompoundUnit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-189'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-189">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-190'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-190">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ScalarUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-191'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-191">#</a>
        </div>
        <p>Represents an aggregate unit.</p>
<p>Aggregate units express functions on sets.  Specifically, let <code>A</code> and <code>B</code>
be flows such that <code>B</code> spans <code>A</code>, but  <code>A</code> does not span <code>B</code>, and
let <code>g</code> be a function that takes subsets of <code>B</code> as an argument.  Then
we could define an aggregate unit <code>u</code> on <code>A</code> as follows:</p>
<pre>`u(a) = g({b | a <-> b})`
</pre>

<p>Here, for each row <code>a</code> from <code>A</code>, we take the subset of convergent
rows from <code>B</code> and apply <code>g</code> to it; the result is the value of <code>u(a)</code>.</p>
<p>The flow <code>A</code> is the unit flow, the flow <code>B</code> is called <em>the plural
flow</em> of an aggregate unit, and <code>g</code> is called <em>the composite expression</em>
of an aggregate unit.</p>
<p><code>code</code> (:class:<code>Code</code>)
The composite expression of the aggregate unit.</p>
<p><code>plural_flow</code> (:class:<code>Flow</code>)
The plural flow of the aggregate unit, that is, the flow
which subsets form the argument of the composite expression.</p>
<p><code>flow</code> (:class:<code>Flow</code>)
The flow on which the unit is defined.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AggregateUnitBase</span><span class="p">(</span><span class="n">CompoundUnit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-192'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-192">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-193'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-193">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">plural_flow</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">Code</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plural_flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-194'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-194">#</a>
        </div>
        <p>FIXME: consider lifting the requirement that the plural
flow spans the unit flow.  Is it really necessary?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">plural_flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">plural_flow</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AggregateUnitBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">plural_flow</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plural_flow</span> <span class="o">=</span> <span class="n">plural_flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-195'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-195">#</a>
        </div>
        <p>Represents a regular aggregate unit.</p>
<p>A regular aggregate unit is expressed in SQL using an aggregate
expression with <code>GROUP BY</code> clause.</p>
<p><code>companions</code> (list of :class:<code>Code</code>)
<pre>An auxiliary hint to the compiler indicating that the term
exporting the unit must also export extra aggregate units.
The value of this attribute has no effect on the semantics of
the flow graph and node comparison.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AggregateUnit</span><span class="p">(</span><span class="n">AggregateUnitBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-196'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-196">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-197'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-197">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">plural_flow</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">companions</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Code</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AggregateUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">plural_flow</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companions</span> <span class="o">=</span> <span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-198'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-198">#</a>
        </div>
        <p></pre>Represents a correlated aggregate unit.</p>
<p>A correlated aggregate unit is expressed in SQL using a correlated
subquery.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CorrelatedUnit</span><span class="p">(</span><span class="n">AggregateUnitBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-199'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-199">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-200'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-200">#</a>
        </div>
        <p>Represents a value generated by a quotient flow.</p>
<p>A value generated by a quotient is either a part of a kernel
expression or a unit from a ground flow.</p>
<p><code>code</code> (:class:<code>Code</code>)
<pre>An expression (calculated against the seed flow of the quotient).
</pre>
<code>flow</code> (:class:<code>Flow</code>)
The flow of the quotient family on which the unit is defined.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">KernelUnit</span><span class="p">(</span><span class="n">CompoundUnit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-201'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-201">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-202'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-202">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">flow</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">is_quotient</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KernelUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-203'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-203">#</a>
        </div>
        <p>Represents a value generated by a covering flow.</p>
<p>A covering flow represents another flow expression as
a single axial flow operation.</p>
<p><code>code</code> (:class:<code>Code</code>)
<pre>An expression (calculated against the seed flow of
the covering flow).
</pre>
<code>flow</code> (:class:<code>Flow</code>)
The flow on which the unit is defined.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CoveringUnit</span><span class="p">(</span><span class="n">CompoundUnit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-204'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-204">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-205'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-205">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="p">(</span><span class="n">ComplementFlow</span><span class="p">,</span>
                                 <span class="n">MonikerFlow</span><span class="p">,</span>
                                 <span class="n">ForkedFlow</span><span class="p">,</span>
                                 <span class="n">LinkedFlow</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoveringUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                    <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span>
                    <span class="n">equality_vector</span><span class="o">=</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
