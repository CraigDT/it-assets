<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>encode.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>encode.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql.tr.encode</code></h1>
<p>This module implements the encoding process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">..adapter</span> <span class="kn">import</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">adapts</span><span class="p">,</span> <span class="n">adapts_many</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Domain</span><span class="p">,</span> <span class="n">UntypedDomain</span><span class="p">,</span> <span class="n">TupleDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">,</span>
                      <span class="n">NumberDomain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">,</span> <span class="n">FloatDomain</span><span class="p">,</span>
                      <span class="n">StringDomain</span><span class="p">,</span> <span class="n">EnumDomain</span><span class="p">,</span> <span class="n">DateDomain</span><span class="p">,</span> <span class="n">TimeDomain</span><span class="p">,</span>
                      <span class="n">DateTimeDomain</span><span class="p">,</span> <span class="n">OpaqueDomain</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">EncodeError</span>
<span class="kn">from</span> <span class="nn">.coerce</span> <span class="kn">import</span> <span class="nb">coerce</span>
<span class="kn">from</span> <span class="nn">.binding</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Binding</span><span class="p">,</span> <span class="n">QueryBinding</span><span class="p">,</span> <span class="n">SegmentBinding</span><span class="p">,</span> <span class="n">WrappingBinding</span><span class="p">,</span>
                      <span class="n">HomeBinding</span><span class="p">,</span> <span class="n">RootBinding</span><span class="p">,</span> <span class="n">FreeTableBinding</span><span class="p">,</span>
                      <span class="n">AttachedTableBinding</span><span class="p">,</span> <span class="n">ColumnBinding</span><span class="p">,</span>
                      <span class="n">QuotientBinding</span><span class="p">,</span> <span class="n">KernelBinding</span><span class="p">,</span> <span class="n">ComplementBinding</span><span class="p">,</span>
                      <span class="n">CoverBinding</span><span class="p">,</span> <span class="n">ForkBinding</span><span class="p">,</span> <span class="n">LinkBinding</span><span class="p">,</span> <span class="n">SieveBinding</span><span class="p">,</span>
                      <span class="n">SortBinding</span><span class="p">,</span> <span class="n">CastBinding</span><span class="p">,</span> <span class="n">RescopingBinding</span><span class="p">,</span>
                      <span class="n">LiteralBinding</span><span class="p">,</span> <span class="n">FormulaBinding</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.lookup</span> <span class="kn">import</span> <span class="n">direct</span>
<span class="kn">from</span> <span class="nn">.flow</span> <span class="kn">import</span> <span class="p">(</span><span class="n">RootFlow</span><span class="p">,</span> <span class="n">ScalarFlow</span><span class="p">,</span> <span class="n">DirectTableFlow</span><span class="p">,</span> <span class="n">FiberTableFlow</span><span class="p">,</span>
                   <span class="n">QuotientFlow</span><span class="p">,</span> <span class="n">ComplementFlow</span><span class="p">,</span> <span class="n">MonikerFlow</span><span class="p">,</span> <span class="n">ForkedFlow</span><span class="p">,</span>
                   <span class="n">LinkedFlow</span><span class="p">,</span> <span class="n">FilteredFlow</span><span class="p">,</span> <span class="n">OrderedFlow</span><span class="p">,</span>
                   <span class="n">QueryExpr</span><span class="p">,</span> <span class="n">SegmentExpr</span><span class="p">,</span> <span class="n">LiteralCode</span><span class="p">,</span> <span class="n">FormulaCode</span><span class="p">,</span>
                   <span class="n">CastCode</span><span class="p">,</span> <span class="n">ColumnUnit</span><span class="p">,</span> <span class="n">ScalarUnit</span><span class="p">,</span> <span class="n">KernelUnit</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.signature</span> <span class="kn">import</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">IsNullSig</span><span class="p">,</span> <span class="n">NullIfSig</span>
<span class="kn">import</span> <span class="nn">decimal</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Encapsulates the (mutable) state of the encoding process.</p>
<p>Currently encoding is a stateless process, but we will likely add
extra state in the future.  The state is also used to store the
cache of binding to flow and binding to code translations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodingState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>Indicates whether results of <code>encode</code> or <code>relate</code> are cached.
Caching means that two calls of <code>encode</code> (or <code>relate</code>) on the
same <code>Binding</code> instance produce the same object.</p>
<p>By default, caching is turned on; however the translator must
never rely on that.  That is, the result generated by the
translator must not depend on whether caching is enabled or
disabled.  This parameter gives us an easy way to check this
assumption.  Different results usually mean a bug in comparison
by value for code objects.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">with_cache</span> <span class="o">=</span> <span class="bp">True</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>A mapping of cached results of <code>encode()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_code</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>A mapping of cached results of <code>relate()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_flow</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>Clears the encoding state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_code</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>Encodes the given binding node to a code expression node.</p>
<p>Returns a :class:<code>htsql.tr.flow.Code</code> node (in some cases,
a :class:<code>htsql.tr.flow.Expression</code> node).</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.Binding</code>)
<pre>The binding node to encode.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>When caching is enabled, we check if <code>binding</code> was
already encoded.  If not, we encode it and save the
result.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">binding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_code</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_code</span><span class="p">[</span><span class="n">binding</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_code</span><span class="p">[</span><span class="n">binding</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p>Caching is disabled; return a new instance every time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p></pre>Encodes the given binding node to a flow expression node.</p>
<p>Returns a :class:<code>htsql.tr.flow.Flow</code> node.</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.Binding</code>)
<pre>The binding node to encode.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">relate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p>When caching is enabled, we check if <code>binding</code> was
already encoded.  If not, we encode it and save the
result.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">binding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_flow</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">relate</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_flow</span><span class="p">[</span><span class="n">binding</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding_to_flow</span><span class="p">[</span><span class="n">binding</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p>Caching is disabled; return a new instance every time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">relate</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p></pre>Applies an encoding adapter to a binding node.</p>
<p>This is a base class for the two encoding adapters: :class:<code>Encode</code>
and :class:<code>Relate</code>; it encapsulates methods and attributes shared
between these adapters.</p>
<p>The encoding process translates binding nodes to data flows or
expressions over data flows.</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.Binding</code>)
<pre>The binding node to encode.
</pre>
<code>state</code> (:class:<code>EncodingState</code>)
The current state of the encoding process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeBase</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">Binding</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EncodingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span> <span class="o">=</span> <span class="n">binding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p>Translates a binding node to a code expression node.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>The :class:<code>Encode</code> adapter has the following signature::</p>
<pre>Encode: (Binding, EncodingState) -> Expression
</pre>

<p>The adapter is polymorphic on the <code>Binding</code> argument.</p>
<p>This adapter provides non-trivial implementation for binding
nodes representing HTSQL functions and operators.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Encode</span><span class="p">(</span><span class="n">EncodeBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <p>The default implementation generates an error.
FIXME: a better error message?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;expected a valid code expression&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p>Translates a binding node to a data flow node.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>The :class:<code>Relate</code> adapter has the following signature::</p>
<pre>Relate: (Binding, EncodingState) -> Flow
</pre>

<p>The adapter is polymorphic on the <code>Binding</code> argument.</p>
<p>The adapter provides non-trivial implementations for scoping
and chaining bindings.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relate</span><span class="p">(</span><span class="n">EncodeBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p>The default implementation generates an error.
FIXME: a better error message?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;expected a valid flow expression&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeQuery</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">QueryBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <p>Encode the segment node if it is provided.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">segment</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>Construct the expression node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">QueryExpr</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeSegment</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">SegmentBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>List of output columns.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p>Encode output columns of the segment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Encode the node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <p>Determine the output flow.  If a flow binding is provided,
use it to generate a flow node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <p>Otherwise, infer the output flow from output columns.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>List of all unit expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                <span class="n">units</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">units</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p>No units means a root scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">RootFlow</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        <p>Otherwise, find a dominating unit flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p>List of dominating flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">flows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">flows</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">flows</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow</span> <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">flows</span>
                                  <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">flow</span><span class="p">)]</span>
                    <span class="n">flows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        <p>More than one dominating flow means the output flow
cannot be inferred from the columns unambiguously.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;invalid segment operand&quot;</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Otherwise, <code>flows</code> contains a single maximal flow node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">else</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">flow</span><span class="p">]</span> <span class="o">=</span> <span class="n">flows</span>
        <span class="k">return</span> <span class="n">SegmentExpr</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateRoot</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">RootBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p>The root binding gives rise to a root flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">RootFlow</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateHome</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">HomeBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>A home binding gives rise to a scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">ScalarFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateFreeTable</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">FreeTableBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        <p>Produce a link from a scalar to a table class.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">DirectTableFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateAttachedTable</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">AttachedTableBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        <p>Produce a link between table classes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FiberTableFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateSieve</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">SieveBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        <p>Encode the predicate expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        <p>Produce a filtering flow operation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FilteredFlow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateSort</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">SortBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        <p>List of pairs <code>(code, direction)</code> containing the expressions
to sort by and respective direction indicators.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        <p>Iterate over ordering binding nodes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">order</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Encode the binding node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        <p>Extract the direction modifier; assume <code>+</code> if none.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">direction</span> <span class="o">=</span> <span class="n">direct</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        <p>The slice indicators.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">limit</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">offset</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        <p>Produce an ordering flow operation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">OrderedFlow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateQuotient</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">QuotientBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        <p>Generate the seed flow of the quotient.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        <p>Verify that the seed is a plural descendant of the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;a plural operand is required&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;invalid plural operand&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        <p>Encode the kernel expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">kernels</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        <p>Note: we need to check that the kernel is not scalar, but we can't
do it here because some units may be removed by the unmasking
process; so the check is delegated to unmasking.
Produce a quotient flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">QuotientFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateComplement</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ComplementBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        <p>Produce a complement flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">ComplementFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateMoniker</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">CoverBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>Generate the seed flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>Produce a masking flow operation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">MonikerFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateFork</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ForkBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        <p>Generate the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        <p>The seed coincides with the parent flow -- but could be changed
after the rewrite step.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed</span> <span class="o">=</span> <span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <p>Generate the fork kernel.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">kernels</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        <p>Verify that the kernel is singular against the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;a singular operand is required&quot;</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ForkedFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">kernels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateLink</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">LinkBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        <p>Generate the parent and the seed flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        <p>Encode linking expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">images</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">lbinding</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">rbinding</span><span class="p">))</span>
                  <span class="k">for</span> <span class="n">lbinding</span><span class="p">,</span> <span class="n">rbinding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">images</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        <p>Verify that linking pairs are singular against the parent and
the seed flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">lcode</span><span class="p">,</span> <span class="n">rcode</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">lcode</span><span class="o">.</span><span class="n">units</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;a singular operand is required&quot;</span><span class="p">,</span> <span class="n">lcode</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">rcode</span><span class="o">.</span><span class="n">units</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;a singular operand is required&quot;</span><span class="p">,</span> <span class="n">rcode</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">LinkedFlow</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeColumn</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ColumnBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        <p>Find the flow of the column.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <p>Generate a column unit node on the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">ColumnUnit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateColumn</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ColumnBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        <p>If the column binding has an associated table binding node,
delegate the adapter to it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">link</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        <p>Otherwise, let the parent produce an error message.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelateColumn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeKernel</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">KernelBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        <p>Get the quotient flow of the kernel.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        <p>Extract the respective kernel expression from the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">kernels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">index</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        <p>Generate a unit expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">KernelUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeLiteral</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">LiteralBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        <p>Switch the class from <code>Binding</code> to <code>Code</code> keeping all attributes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">LiteralCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeCast</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">CastBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>Delegate it to the <code>Convert</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">convert</span> <span class="o">=</span> <span class="n">Convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">convert</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        <p>Encodes a cast binding to a code node.</p>
<p>This is an auxiliary adapter used to encode
:class:<code>htsql.tr.binding.CastBinding</code> nodes.  The adapter is polymorphic
by the origin and the target domains.</p>
<p>The purpose of the adapter is multifold.  The :class:<code>Convert</code> adapter:</p>
<ul>
<li>verifies that the conversion from the source to the target
domain is admissible;</li>
<li>eliminates redundant conversions;</li>
<li>handles conversion from the special types:
:class:<code>htsql.domain.UntypedDomain</code> and :class:<code>htsql.domain.TupleDomain</code>;</li>
<li>when possible, expresses the cast in terms of other operations; otherwise,
generates a new :class:<code>htsql.tr.flow.CastCode</code> node.</li>
</ul>
<p><code>binding</code> (:class:<code>htsql.tr.binding.CastBinding</code>)
<pre>The binding node to encode.
</pre>
Note that the adapter is dispatched on the pair
<code>(binding.base.domain, binding.domain)</code>.</p>
<p><code>state</code> (:class:<code>EncodingState</code>)
The current state of the encoding process.</p>
<p>Aliases:</p>
<p><code>base</code> (:class:<code>htsql.tr.binding.Binding</code>)
An alias for <code>binding.base</code>; the operand of the cast expression.</p>
<p><code>domain</code> (:class:<code>htsql.domain.Domain</code>)
An alias for <code>binding.domain</code>; the target domain.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Convert</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Domain</span><span class="p">,</span> <span class="n">Domain</span><span class="p">)</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        <p>We override the standard extract of the dispatch key, which
returns the type of the first argument(s).  For <code>Convert</code>,
the dispatch key is the pair of the origin and the target domains.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">CastBinding</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">domain</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">binding</span><span class="o">.</span><span class="n">domain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">CastBinding</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EncodingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span> <span class="o">=</span> <span class="n">binding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        <p>A final check to eliminate conversion when the origin and
the target domains are the same.  It is likely no-op since
this case should be already handled.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        <p>The default implementation complains that the conversion is
not admissible.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;inadmissible conversion&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertUntyped</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        <p>Validate and convert untyped literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">UntypedDomain</span><span class="p">,</span> <span class="n">Domain</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        <p>The base binding is of untyped domain, however it does not have
to be an instance of <code>LiteralBinding</code> since the actual literal node
could be wrapped by decorators.  However after we encode the node,
the decorators are gone and the result must be a <code>LiteralCode</code>
The domain should remain the same too.
FIXME: the literal could possibly be wrapped into <code>ScalarUnit</code>
if the literal binding was rescoped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">LiteralCode</span><span class="p">,</span> <span class="n">ScalarUnit</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">UntypedDomain</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        <p>Unwrap scalar units from the literal code.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">wrappers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ScalarUnit</span><span class="p">):</span>
            <span class="n">wrappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">code</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">LiteralCode</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        <p>If the operand is a scalar unit,
Convert the serialized literal value to a Python object; raises
a <code>ValueError</code> if the literal is not in a valid format.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        <p>Generate a new literal node with the converted value and
the target domain.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="n">LiteralCode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        <p>If necessary, wrap the literal back into scalar units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="n">wrappers</span><span class="p">:</span>
            <span class="n">wrapper</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToItself</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>Eliminate redundant conversions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">BooleanDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">IntegerDomain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">FloatDomain</span><span class="p">,</span> <span class="n">FloatDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DecimalDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateDomain</span><span class="p">,</span> <span class="n">DateDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">TimeDomain</span><span class="p">,</span> <span class="n">TimeDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateTimeDomain</span><span class="p">,</span> <span class="n">DateTimeDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        <p>FIXME: do we need <code>EnumDomain</code> here?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>Encode and return the operand of the cast; drop the cast node itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertTupleToBoolean</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        <p>Converts a tuple expression to a conditional expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">TupleDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        <p>When the binding domain is tuple, we assume that the binding
represents some flow.  In this case, Boolean cast produces
an expression which is <code>FALSE</code> when the flow is empty and
<code>TRUE</code> otherwise.  The actual expression is:
  <code>!is_null(unit)</code>,
where <code>unit</code> is some non-nullable function on the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        <p>Translate the operand to a flow node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        <p>A <code>TRUE</code> literal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">true_literal</span> <span class="o">=</span> <span class="n">LiteralCode</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        <p>A <code>TRUE</code> constant as a function on the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit</span> <span class="o">=</span> <span class="n">ScalarUnit</span><span class="p">(</span><span class="n">true_literal</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        <p>Return <code>!is_null(unit)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertStringToBoolean</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        <p>Convert a string expression to a conditional expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>A <code>NULL</code> value and an empty string are converted to <code>FALSE</code>,
any other string value is converted to <code>TRUE</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        <p>Encode the operand of the cast.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        <p>An empty string.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">empty_literal</span> <span class="o">=</span> <span class="n">LiteralCode</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p>Construct: <code>null_if(base,'')</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">NullIfSig</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span>
                           <span class="n">lop</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">empty_literal</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        <p>Construct: <code>!is_null(null_if(base,''))</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span>
                           <span class="n">op</span><span class="o">=</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        <p>Return <code>!is_null(null_if(base,''))</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">code</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToBoolean</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>Convert an expression of any type to a conditional expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">NumberDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">EnumDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">TimeDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateTimeDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">OpaqueDomain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        <p>Note: we include the opaque domain here to ensure that any
data type could be converted to Boolean.  However this may
lead to unintuitive results.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-160'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-160">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-161'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-161">#</a>
        </div>
        <p>A <code>NULL</code> value is converted to <code>FALSE</code>; any other value is
converted to <code>TRUE</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-162'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-162">#</a>
        </div>
        <p>Construct and return <code>!is_null(base)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span>
                           <span class="n">op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-163'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-163">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToString</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-164'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-164">#</a>
        </div>
        <p>Convert an expression to a string.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">BooleanDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">NumberDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">EnumDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">TimeDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateTimeDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">OpaqueDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-165'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-165">#</a>
        </div>
        <p>Note: we assume we could convert any opaque data type to string;
it is risky but convenient.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-166'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-166">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-167'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-167">#</a>
        </div>
        <p>We generate a cast code node leaving it to the serializer
to specialize on the origin data type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-168'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-168">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToInteger</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-169'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-169">#</a>
        </div>
        <p>Convert an expression to an integer value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">DecimalDomain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">FloatDomain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-170'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-170">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-171'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-171">#</a>
        </div>
        <p>We leave conversion from literal values to the database
engine even though we could handle it here because the
conversion may be engine-specific.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-172'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-172">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToDecimal</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-173'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-173">#</a>
        </div>
        <p>Convert an expression to a decimal value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">IntegerDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">FloatDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-174'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-174">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-175'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-175">#</a>
        </div>
        <p>Encode the operand of the cast.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-176'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-176">#</a>
        </div>
        <p>Handle conversion from an integer literal manually.
We do not handle conversion from other literal types
because it may be engine-specific.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">LiteralCode</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">code</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">code</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-177'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-177">#</a>
        </div>
        <p>For the regular case, generate an appropriate cast node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-178'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-178">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToFloat</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-179'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-179">#</a>
        </div>
        <p>Convert an expression to a float value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">IntegerDomain</span><span class="p">,</span> <span class="n">FloatDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DecimalDomain</span><span class="p">,</span> <span class="n">FloatDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">FloatDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-180'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-180">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-181'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-181">#</a>
        </div>
        <p>Encode the operand of the cast.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-182'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-182">#</a>
        </div>
        <p>Handle conversion from an integer and decimal literals manually.
We do not handle conversion from other literal types because it
may be engine-specific.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">LiteralCode</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="p">(</span><span class="n">IntegerDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">code</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">code</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-183'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-183">#</a>
        </div>
        <p>For the regular case, generate an appropriate cast node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-184'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-184">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToDate</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-185'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-185">#</a>
        </div>
        <p>Convert an expression to a date value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">DateDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateTimeDomain</span><span class="p">,</span> <span class="n">DateDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-186'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-186">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-187'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-187">#</a>
        </div>
        <p>We leave conversion from literal values to the database
engine even though we could handle it here because the
conversion may be engine-specific.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-188'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-188">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToTime</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-189'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-189">#</a>
        </div>
        <p>Convert an expression to a time value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">TimeDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateTimeDomain</span><span class="p">,</span> <span class="n">TimeDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-190'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-190">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-191'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-191">#</a>
        </div>
        <p>Leave conversion to the database engine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-192'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-192">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvertToDateTime</span><span class="p">(</span><span class="n">Convert</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-193'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-193">#</a>
        </div>
        <p>Convert an expression to a datetime value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">((</span><span class="n">StringDomain</span><span class="p">,</span> <span class="n">DateTimeDomain</span><span class="p">),</span>
                <span class="p">(</span><span class="n">DateDomain</span><span class="p">,</span> <span class="n">DateTimeDomain</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-194'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-194">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-195'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-195">#</a>
        </div>
        <p>Leave conversion to the database engine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">CastCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-196'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-196">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeRescoping</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">RescopingBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-197'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-197">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-198'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-198">#</a>
        </div>
        <p>Wrap the base expression into a scalar unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ScalarUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-199'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-199">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeFormula</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">FormulaBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-200'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-200">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-201'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-201">#</a>
        </div>
        <p>Delegate the translation to the <code>EncodeBySignature</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">encode</span> <span class="o">=</span> <span class="n">EncodeBySignature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encode</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-202'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-202">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateFormula</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">FormulaBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-203'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-203">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-204'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-204">#</a>
        </div>
        <p>Delegate the translation to the <code>RelateBySignature</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">relate</span> <span class="o">=</span> <span class="n">RelateBySignature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-205'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-205">#</a>
        </div>
        <p>Translates a formula node.</p>
<p>This is a base class for the two encoding adapters:
:class:<code>EncodeBySignature</code> and :class:<code>RelateBySignature</code>;
it encapsulates methods and attributes shared between these adapters.</p>
<p>The adapter accepts a binding formula node and is polymorphic
on the formula signature.</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.FormulaBinding</code>)
<pre>The formula node to encode.
</pre>
<code>state</code> (:class:<code>EncodingState</code>)
The current state of the encoding process.</p>
<p>Aliases:</p>
<p><code>signature</code> (:class:<code>htsql.tr.signature.Signature</code>)
The signature of the formula.</p>
<p><code>domain</code> (:class:<code>htsql.tr.domain.Domain</code>)
The co-domain of the formula.</p>
<p><code>arguments</code> (:class:<code>htsql.tr.signature.Bag</code>)
The arguments of the formula.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeBySignatureBase</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-206'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-206">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Signature</span><span class="p">)</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-207'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-207">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-208'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-208">#</a>
        </div>
        <p>We need to override <code>dispatch</code> since the adapter is polymorphic
not on the type of the node itself, but on the type of the
node signature.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">FormulaBinding</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">binding</span><span class="o">.</span><span class="n">signature</span><span class="p">),)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-209'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-209">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">FormulaBinding</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EncodingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binding</span> <span class="o">=</span> <span class="n">binding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-210'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-210">#</a>
        </div>
        <p>Extract commonly used attributes of the node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">arguments</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-211'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-211">#</a>
        </div>
        <p>Translates a formula binding to a code node.</p>
<p>This is an auxiliary adapter used to encode
class:<code>htsql.tr.binding.FormulaBinding</code> nodes.  The adapter is
polymorphic on the formula signature.</p>
<p>Unless overridden, the adapter encodes the arguments of the formula
and generates a new formula code with the same signature.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeBySignature</span><span class="p">(</span><span class="n">EncodeBySignatureBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-212'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-212">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-213'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-213">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-214'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-214">#</a>
        </div>
        <p>Encode the arguments of the formula.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-215'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-215">#</a>
        </div>
        <p>Produce a formula code with the same signature.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">arguments</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-216'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-216">#</a>
        </div>
        <p>Translates a formula binding to a flow node.</p>
<p>This is an auxiliary adapter used to relate
class:<code>htsql.tr.binding.FormulaBinding</code> nodes.  The adapter is
polymorphic on the formula signature.</p>
<p>Unless overridden, the adapter generates an error.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateBySignature</span><span class="p">(</span><span class="n">EncodeBySignatureBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-217'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-217">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-218'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-218">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-219'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-219">#</a>
        </div>
        <p>Override in subclasses for formulas that generate flow nodes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="n">EncodeError</span><span class="p">(</span><span class="s">&quot;expected a valid flow expression&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-220'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-220">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EncodeWrapping</span><span class="p">(</span><span class="n">Encode</span><span class="p">):</span>

    <span class="n">adapts_many</span><span class="p">(</span><span class="n">WrappingBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-221'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-221">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-222'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-222">#</a>
        </div>
        <p>Delegate the adapter to the wrapped binding.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-223'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-223">#</a>
        </div>
        <p>Translates a wrapper binding to a flow node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelateWrapping</span><span class="p">(</span><span class="n">Relate</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-224'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-224">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">(</span><span class="n">WrappingBinding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-225'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-225">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-226'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-226">#</a>
        </div>
        <p>Delegate the adapter to the wrapped binding.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">relate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binding</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-227'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-227">#</a>
        </div>
        <p>Encodes the given binding to an expression node.</p>
<p>Returns a :class:<code>htsql.tr.flow.Expression</code> instance (in most cases,
a :class:<code>htsql.tr.flow.Code</code> instance).</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.Binding</code>)
<pre>The binding node to encode.
</pre>
<code>state</code> (:class:<code>EncodingState</code> or <code>None</code>)
The encoding state to use.  If not set, a new encoding state
is instantiated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-228'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-228">#</a>
        </div>
        <p>Create a new encoding state if necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">EncodingState</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-229'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-229">#</a>
        </div>
        <p>Realize and apply the <code>Encode</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">encode</span> <span class="o">=</span> <span class="n">Encode</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encode</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-230'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-230">#</a>
        </div>
        <p>Encodes the given binding to a data flow node.</p>
<p>Returns a :class:<code>htsql.tr.flow.Flow</code> instance.</p>
<p><code>binding</code> (:class:<code>htsql.tr.binding.Binding</code>)
<pre>The binding node to encode.
</pre>
<code>state</code> (:class:<code>EncodingState</code> or <code>None</code>)
The encoding state to use.  If not set, a new encoding state
is instantiated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">relate</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-231'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-231">#</a>
        </div>
        <p>Create a new encoding state if necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">EncodingState</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-232'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-232">#</a>
        </div>
        <p>Realize and apply the <code>Relate</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">relate</span> <span class="o">=</span> <span class="n">Relate</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">relate</span><span class="p">()</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
