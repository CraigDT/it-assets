<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>compile.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>compile.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql.tr.compile</code></h1>
<p>This module implements the compiling process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">maybe</span><span class="p">,</span> <span class="n">listof</span>
<span class="kn">from</span> <span class="nn">..adapter</span> <span class="kn">import</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">adapts</span><span class="p">,</span> <span class="n">adapts_many</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="n">BooleanDomain</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">CompileError</span>
<span class="kn">from</span> <span class="nn">.coerce</span> <span class="kn">import</span> <span class="nb">coerce</span>
<span class="kn">from</span> <span class="nn">.signature</span> <span class="kn">import</span> <span class="n">IsNullSig</span><span class="p">,</span> <span class="n">AndSig</span>
<span class="kn">from</span> <span class="nn">.flow</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Expression</span><span class="p">,</span> <span class="n">QueryExpr</span><span class="p">,</span> <span class="n">SegmentExpr</span><span class="p">,</span> <span class="n">Code</span><span class="p">,</span> <span class="n">LiteralCode</span><span class="p">,</span>
                   <span class="n">FormulaCode</span><span class="p">,</span> <span class="n">Flow</span><span class="p">,</span> <span class="n">RootFlow</span><span class="p">,</span> <span class="n">ScalarFlow</span><span class="p">,</span>
                   <span class="n">TableFlow</span><span class="p">,</span> <span class="n">DirectTableFlow</span><span class="p">,</span> <span class="n">FiberTableFlow</span><span class="p">,</span>
                   <span class="n">QuotientFlow</span><span class="p">,</span> <span class="n">ComplementFlow</span><span class="p">,</span> <span class="n">MonikerFlow</span><span class="p">,</span>
                   <span class="n">ForkedFlow</span><span class="p">,</span> <span class="n">LinkedFlow</span><span class="p">,</span> <span class="n">FilteredFlow</span><span class="p">,</span> <span class="n">OrderedFlow</span><span class="p">,</span>
                   <span class="n">Unit</span><span class="p">,</span> <span class="n">ScalarUnit</span><span class="p">,</span> <span class="n">ColumnUnit</span><span class="p">,</span> <span class="n">AggregateUnit</span><span class="p">,</span> <span class="n">CorrelatedUnit</span><span class="p">,</span>
                   <span class="n">KernelUnit</span><span class="p">,</span> <span class="n">CoveringUnit</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.term</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Term</span><span class="p">,</span> <span class="n">ScalarTerm</span><span class="p">,</span> <span class="n">TableTerm</span><span class="p">,</span> <span class="n">FilterTerm</span><span class="p">,</span> <span class="n">JoinTerm</span><span class="p">,</span>
                   <span class="n">EmbeddingTerm</span><span class="p">,</span> <span class="n">CorrelationTerm</span><span class="p">,</span> <span class="n">ProjectionTerm</span><span class="p">,</span> <span class="n">OrderTerm</span><span class="p">,</span>
                   <span class="n">WrapperTerm</span><span class="p">,</span> <span class="n">PermanentTerm</span><span class="p">,</span> <span class="n">SegmentTerm</span><span class="p">,</span> <span class="n">QueryTerm</span><span class="p">,</span> <span class="n">Joint</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.stitch</span> <span class="kn">import</span> <span class="n">arrange</span><span class="p">,</span> <span class="n">spread</span><span class="p">,</span> <span class="n">sew</span><span class="p">,</span> <span class="n">tie</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Encapsulates the state of the compiling process.</p>
<p>State attributes:</p>
<p><code>root</code> (:class:<code>htsql.tr.flow.RootFlow</code>)
<pre>The root flow.
</pre>
<code>baseline</code> (:class:<code>htsql.tr.flow.Flow</code>)
When compiling a new term, indicates the leftmost axis that must
exported by the term.  Note that the baseline flow is always
inflated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompilingState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>The next term tag to be produced by <code>tag</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">next_tag</span> <span class="o">=</span> <span class="mi">1</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>The root scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>The stack of previous baseline flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_stack</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>The current baseline flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Generates and returns a new unique term tag.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_tag</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>Initializes the root, baseline and mask flows.</p>
<p>This function must be called before state attributes <code>root</code>,
<code>baseline</code> and <code>mask</code> could be used.</p>
<p><code>flow</code> (:class:<code>htsql.tr.flow.RootFlow</code>)
<pre>A root scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">RootFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p>Check that the state flows are not yet initialized.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p></pre>Clears the state flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p>Check that the state flows are initialized and the flow stacks
are exhausted.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_stack</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p>Sets a new baseline flow.</p>
<p>This function masks the current baseline flow.  To restore
the previous baseline flow, use :meth:<code>pop_baseline</code>.</p>
<p><code>baseline</code> (:class:<code>htsql.tr.flow.Flow</code>)
<pre>The new baseline flow.  Note that the baseline flow
must be inflated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">push_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">baseline</span><span class="o">.</span><span class="n">is_inflated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p></pre>Restores the previous baseline flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pop_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p>Compiles a new term node for the given expression.</p>
<p><code>expression</code> (:class:<code>htsql.tr.flow.Expression</code>)
<pre>An expression node.
</pre>
<code>baseline</code> (:class:<code>htsql.tr.flow.Flow</code> or <code>None</code>)
The baseline flow.  Specifies an axis flow that the compiled
term must export.  If not set, the current baseline flow of
the state is used.</p>
<p>When <code>expression</code> is a flow, the generated term must
export the flow itself as well as all inflated prefixes
up to the <code>baseline</code> flow.  It may (but it is not required)
export other axes as well.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p>FIXME: potentially, we could implement a cache of <code>expression</code>
-&gt; <code>term</code> to avoid generating the same term node more than once.
There are several complications though.  First, the term depends
not only on the expression, but also on the current baseline
and mask flows.  Second, each compiled term must have a unique
tag, therefore we'd have to replace the tags and route tables
of the cached term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <p>Augments a term to make it capable of producing the given expressions.</p>
<p>This method takes a term node and a list of expressions.  It returns
a term that could produce the same expressions as the given term, and,
in addition, all the given expressions.</p>
<p>Note that, technically, a term only exports unit expressions;
we claim that a term could export an expression if it exports
all the units of the expression.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.Term</code>)
<pre>A term node.
</pre>
<code>expressions</code> (a list of :class:<code>htsql.tr.flow.Expression</code>)
A list of expressions to inject into the given term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">expressions</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p>Iterate over the expressions to inject.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p>A quick check to avoid a costly adapter call.  This
only works if the expression is a unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
                <span class="k">continue</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p>Inject the expression into the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">inject</span> <span class="o">=</span> <span class="n">Inject</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">inject</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p>Return the augmented term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileBase</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">Expression</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <p>Utility functions used by implementations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>Compiles a term corresponding to the given flow.</p>
<p>The compiled term is called <em>a shoot term</em> (relatively to
the given <em>trunk term</em>).</p>
<p><code>flow</code> (:class:<code>htsql.tr.flow.Flow</code>)
<pre>A flow node, for which the we compile a term.
</pre>
<code>trunk</code> (:class:<code>htsql.tr.flow.Flow</code> or :class:<code>htsql.tr.term.Term</code>)
Expresses a promise that the compiled term will be
(eventually) joined to a term corresponding to the
<code>trunk</code> flow.  If <code>trunk</code> is a :class:<code>htsql.tr.term.Term</code>
instance, use the term flow.</p>
<p><code>codes</code> (a list of :class:<code>htsql.tr.flow.Expression</code> or <code>None</code>)
If provided, a list of expressions to be injected
into the compiled term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">trunk</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trunk</span><span class="p">,</span> <span class="p">(</span><span class="n">Flow</span><span class="p">,</span> <span class="n">Term</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span> <span class="n">maybe</span><span class="p">(</span><span class="n">listof</span><span class="p">(</span><span class="n">Expression</span><span class="p">)))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>If a term node is passed in place of a trunk flow, use
the flow of the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trunk</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
            <span class="n">trunk</span> <span class="o">=</span> <span class="n">trunk</span><span class="o">.</span><span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p>This condition is enforced by unmasking process -- all
non-axial operations in the trunk flow are pruned from
the given flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">flow</span> <span class="o">==</span> <span class="n">flow</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="n">trunk</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Determine the longest ancestor of the flow that contains
no non-axial operations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">baseline</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">baseline</span><span class="o">.</span><span class="n">is_inflated</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <p>Handle the case when the given flow is not spanned by the
trunk flow -- it happens when we construct a plural term
for an aggregate unit.  In this case, before joining it
to the trunk term, the shoot term will be projected to some
singular prefix of the given flow.  To enable such projection,
at least the base of the shoot baseline must be spanned by
the trunk flow (then, we can project on the columns of
a foreign key that attaches the baseline to its base).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">trunk</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">baseline</span><span class="p">):</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">trunk</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">baseline</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <p>Compile the term for the given flow up to the baseline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>If provided, inject the given expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">codes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p>Return the compiled shoot term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        <p>Returns joints attaching the shoot flow to the trunk flow.</p>
<p>The given flow nodes specify the shape of two term nodes:
the trunk term and the shoot term.  The function returns
a list of :class:<code>htsql.tr.term.Joint</code> objects that could
be used to attach the shoot term to the trunk term without
changing the cardinality of the latter.</p>
<p><code>flow</code> (:class:<code>htsql.tr.flow.Flow</code>)
<pre>The flow of the trunk term.
</pre>
<code>baseline</code> (:class:<code>htsql.tr.flow.Flow</code>)
The baseline of the trunk term.</p>
<p><code>shoot</code> (:class:<code>htsql.tr.flow.Flow</code>)
The flow of the shoot term.</p>
<p><code>shoot_baseline</code> (:class:<code>htsql.tr.flow.Flow</code>)
The baseline of the shoot term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">glue_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">shoot</span><span class="p">,</span> <span class="n">shoot_baseline</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">baseline</span><span class="o">.</span><span class="n">is_inflated</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        <p>The <code>flow</code> may represent not the trunk flow itself,
but one of its ancestors which may lie below <code>baseline</code>.
assert flow.concludes(baseline)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shoot</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shoot_baseline</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">shoot_baseline</span><span class="o">.</span><span class="n">is_inflated</span>
        <span class="k">assert</span> <span class="n">shoot</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">shoot_baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Verify that it is possible to join the terms without
changing the cardinality of the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="p">(</span><span class="n">shoot_baseline</span><span class="o">.</span><span class="n">is_root</span> <span class="ow">or</span> <span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">shoot_baseline</span><span class="o">.</span><span class="n">base</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        <p>There are two ways the joints are generated:</p>
<ul>
<li>when the shoot baseline is an axis of the trunk flow,
  in this case we join the terms using parallel joints on
  the common axes;</li>
<li>otherwise, join the terms using a serial joint between
  the shoot baseline and its base.</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Joints to attach the shoot to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p>The backbone of the trunk term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">backbone</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">inflate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>The backbone of the shoot term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">shoot_backbone</span> <span class="o">=</span> <span class="n">shoot</span><span class="o">.</span><span class="n">inflate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        <p>Check if the shoot baseline is an axis of the trunk flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">backbone</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">shoot_baseline</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>In this case, we join the terms by all axes of the trunk
flow that are exported by the shoot term.
Find the first inflated axis of the trunk exported
by the shoot.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">axis</span> <span class="o">=</span> <span class="n">backbone</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">shoot_backbone</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">axis</span><span class="p">):</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>Now the axes between <code>axis</code> and <code>shoot_baseline</code> are common
axes of the trunk flow and the shoot term.  For each of them,
generate a parallel joint.  Note that we do not verify
(and, in general, it is not required) that these axes
are exported by the trunk term.  Apply <code>inject_joints()</code> on
the trunk term before using the joints to join the terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">axis</span> <span class="o">!=</span> <span class="n">shoot_baseline</span><span class="o">.</span><span class="n">base</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p>Skip non-expanding axes (but always include the baseline).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">if</span> <span class="ow">not</span> <span class="n">axis</span><span class="o">.</span><span class="n">is_contracting</span> <span class="ow">or</span> <span class="n">axis</span> <span class="o">==</span> <span class="n">shoot_baseline</span><span class="p">:</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p>We prefer (for no particular reason) the joints to go
from shortest to longest axes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">axes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">joints</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sew</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p>When the shoot does not touch the trunk flow, we attach it
using a serial joint between the shoot baseline and its base.
Note that we do not verify (and it is not required) that
the trunk term exports the base flow.  Apply <code>inject_joints()</code>
on the trunk term to inject any necessary flows before
joining the terms using the joints.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">joints</span> <span class="o">=</span> <span class="n">tie</span><span class="p">(</span><span class="n">shoot_baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        <p>We can try to optimize the joints when the base of the
shoot baseline is an ancestor of the trunk flow, but not
exported by the trunk term.  It this case, we prefer to
avoid adding an extra axis to the trunk term from below.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        <p>The axis that joins the shoot term to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">origin</span> <span class="o">=</span> <span class="n">shoot_baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        <p>Check if the axis is a part of the trunk backbone, but
lies below the the trunk baseline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">baseline</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="ow">and</span> <span class="n">baseline</span> <span class="o">!=</span> <span class="n">origin</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Find the direct descendant of <code>origin</code> along the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">axis</span> <span class="o">=</span> <span class="n">baseline</span>
                <span class="k">while</span> <span class="n">axis</span><span class="o">.</span><span class="n">base</span> <span class="o">!=</span> <span class="n">origin</span><span class="p">:</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        <p>Ties from the shoot term to the origin flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">shoot_joints</span> <span class="o">=</span> <span class="n">joints</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        <p>Ties from the trunk term to the origin flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">trunk_joints</span> <span class="o">=</span> <span class="n">tie</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        <p>Check if both set of ties share the same origin
expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trunk_joints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shoot_joints</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">all</span><span class="p">(</span><span class="n">trunk_joint</span><span class="o">.</span><span class="n">lop</span> <span class="o">==</span> <span class="n">shoot_joint</span><span class="o">.</span><span class="n">lop</span>
                            <span class="k">for</span> <span class="n">trunk_joint</span><span class="p">,</span> <span class="n">shoot_joint</span>
                            <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trunk_joints</span><span class="p">,</span> <span class="n">shoot_joints</span><span class="p">))):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>Generate a new set of ties by merging the shoot
and trunk joints.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                    <span class="n">joints</span> <span class="o">=</span> <span class="p">[</span><span class="n">Joint</span><span class="p">(</span><span class="n">trunk_joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="n">shoot_joint</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">trunk_joint</span><span class="p">,</span> <span class="n">shoot_joint</span>
                              <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trunk_joints</span><span class="p">,</span> <span class="n">shoot_joints</span><span class="p">)]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        <p>Return the generated joints.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">joints</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        <p>Returns joints to attach the shoot term to the trunk term.</p>
<p><code>trunk_term</code> (:class:<code>htsql.tr.term.Term</code>)
<pre>The left (trunk) operand of the join.
</pre>
<code>shoot_term</code> (:class:<code>htsql.tr.term.Term</code>)
The right (shoot) operand of the join.</p>
<p>Note that the trunk term may not export all the units necessary
to generate join conditions.  Apply :meth:<code>inject_joints</code> on the
trunk before using the joints to join the trunk and the shoot.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">glue_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trunk_term</span><span class="p">,</span> <span class="n">shoot_term</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shoot_term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        <p>Delegate to an auxiliary method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_flows</span><span class="p">(</span><span class="n">trunk_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">trunk_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                               <span class="n">shoot_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">shoot_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        <p>Augments the term to ensure it can export all units required
to generate join conditions.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.Term</code>)
<pre>The term to update.
</pre>
It is assumed that <code>term</code> was the argument <code>trunk_term</code> of
:meth:<code>glue_terms</code> when the joints were generated.</p>
<p><code>joints</code> (a list of :class:<code>htsql.tr.term.Joint</code>)
The joints to inject.</p>
<p>It is assumed the ties were generated by :meth:<code>glue_terms</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">inject_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">joints</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joints</span><span class="p">,</span> <span class="n">listof</span><span class="p">(</span><span class="n">Joint</span><span class="p">))</span>

        <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">lop</span> <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">joints</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        <p>Attaches a shoot term to a trunk term.</p>
<p>The produced join term uses the flow and the routing
table of the trunk term, but also includes the given
extra routes.</p>
<p><code>trunk_term</code> (:class:<code>htsql.tr.term.Term</code>)
<pre>The left (trunk) operand of the join.
</pre>
<code>shoot_term</code> (:class:<code>htsql.tr.term.Term</code>)
The right (shoot) operand of the term.</p>
<p>The shoot term must be singular relatively to the trunk term.</p>
<p><code>extra_routes</code> (a mapping from a unit/flow to a term tag)
Any extra routes provided by the join.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">join_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trunk_term</span><span class="p">,</span> <span class="n">shoot_term</span><span class="p">,</span> <span class="n">extra_routes</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Sanity check on the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shoot_term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">trunk_term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">shoot_term</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_routes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        <p>Join conditions that glue the terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_terms</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">shoot_term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        <p>Make sure the trunk term could export the joints (this
may change the baseline of the trunk term).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">joints</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        <p>Determine if we could use an inner join to attach the shoot
to the trunk.  We could do it if the inner join does not
decrease cardinality of the trunk.  It is so if the shoot flow
dominates a closest ancestor of the trunk flow that is spanned
by the shoot flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_left</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">trunk_term</span><span class="o">.</span><span class="n">flow</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">shoot_term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">flow</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">base</span>
        <span class="n">is_left</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">shoot_term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">flow</span><span class="p">))</span>
        <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        <p>Use the routing table of the trunk term, but also add
the given extra routes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="n">trunk_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        <p>Generate and return a join term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">trunk_term</span><span class="p">,</span> <span class="n">shoot_term</span><span class="p">,</span>
                        <span class="n">joints</span><span class="p">,</span> <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span>
                        <span class="n">trunk_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">trunk_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        <p>Translates an expression node to a term node.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>The :class:<code>Compile</code> adapter is implemented for two classes
of expressions:</p>
<ul>
<li>
<p>top-level expressions such as the whole query and the query segment,
for which it builds respective top-level term nodes;</p>
</li>
<li>
<p>flows, for which the adapter builds a corresponding relational
algebraic expression.</p>
</li>
</ul>
<p>After a term is built, it is typically augmented using the
:class:<code>Inject</code> adapter to have it export any exprected units.</p>
<p>The :class:<code>Compile</code> adapter has the following signature::</p>
<pre>Compile: (Expression, CompilingState) -> Term
</pre>

<p>The adapter is polymorphic on the <code>Expression</code> argument.</p>
<p><code>expression</code> (:class:<code>htsql.tr.flow.Expression</code>)
An expression node.</p>
<p><code>state</code> (:class:<code>CompilingState</code>)
The current state of the compiling process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Compile</span><span class="p">(</span><span class="n">CompileBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CompilingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        <p>This should never be reachable; if we are here, it indicates
either a bug or an incomplete implementation.  Since normally it
cannot be triggered by a user, we don't bother with generating
a user-level HTSQL exception.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the compile adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        <p>Augments a term to make it capable of producing the given expression.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>This adapter takes a term node and an expression (usually, a unit)
and returns a new term (an augmentation of the given term) that is
able to produce the given expression.</p>
<p>The :class:<code>Inject</code> adapter has the following signature::</p>
<pre>Inject: (Expression, Term, CompilingState) -> Term
</pre>

<p>The adapter is polymorphic on the <code>Expression</code> argument.</p>
<p><code>expression</code> (:class:<code>htsql.tr.flow.Expression</code>)
An expression node to inject.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.Term</code>)
A term node to inject into.</p>
<p><code>state</code> (:class:<code>CompilingState</code>)
The current state of the compiling process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Inject</span><span class="p">(</span><span class="n">CompileBase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">Expression</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Term</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CompilingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">term</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        <p>Same as with <code>Compile</code>, unless it's a bug or an incomplete
implementation, it should never be reachable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the inject adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileQuery</span><span class="p">(</span><span class="n">Compile</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">QueryExpr</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>Initialize the all state flows with a root scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_root</span><span class="p">(</span><span class="n">RootFlow</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">binding</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>Compile the segment term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">segment</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        <p>Shut down the state flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        <p>Construct a query term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">QueryTerm</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileSegment</span><span class="p">(</span><span class="n">Compile</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">SegmentExpr</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <p>Get the ordering of the segment flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">order</span> <span class="o">=</span> <span class="n">arrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        <p>List of expressions we need the term to export.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">codes</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">elements</span> <span class="o">+</span>
                 <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        <p>Construct a term corresponding to the segment flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">kid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        <p>Inject the expressions into the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">kid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">kid</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        <p>The compiler does not guarantee that the produced term respects
the flow ordering, so it is our responsitibity to wrap the term
with an order node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">kid</span> <span class="o">=</span> <span class="n">OrderTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">kid</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                            <span class="n">kid</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">kid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">kid</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        <p>Construct a segment term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">SegmentTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">kid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span>
                           <span class="n">kid</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">kid</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        <p>Compile a term corresponding to a flow node.</p>
<p>This is an abstract class; see subclasses for implementations.</p>
<p>The general algorithm for compiling a term node for the given flow
looks as follows:</p>
<ul>
<li>compile a term for the base flow;</li>
<li>inject any necessary expressions;</li>
<li>build a new term node that represents the flow operation.</li>
</ul>
<p>When compiling a term for a flow node, the current <code>baseline</code> flow
denotes the leftmost axis that the term should be able to export.
The compiler may (but does not have to) omit any axes nested under
the <code>baseline</code> axis.</p>
<p>The generated term is not required to respect the ordering of the flow.</p>
<p>Constructor arguments:</p>
<p><code>flow</code> (:class:<code>htsql.tr.flow.Flow</code>)
<pre>A flow node.
</pre>
<code>state</code> (:class:<code>CompilingState</code>)
The current state of the compiling process.</p>
<p>Other attributes:</p>
<p><code>backbone</code> (:class:<code>htsql.tr.flow.Flow</code>)
The inflation of the given flow.</p>
<p><code>baseline</code> (:class:<code>htsql.tr.flow.Flow</code>)
An alias to <code>state.baseline</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileFlow</span><span class="p">(</span><span class="n">Compile</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        <p>The inflation of the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">backbone</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">inflate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <p>Check that the baseline flow is an axis of the given flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">flow</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">backbone</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        <p>Extract commonly used state properties.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">baseline</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectFlow</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">Flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        <p>It is a bug if we get the <code>flow</code> plural for the <code>term</code> here.
It is a responsibility of <code>InjectUnit</code> to guard against unexpected
plural expressions and to issue an appropriate HTSQL error.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InjectFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">term</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        <p>Note that this function works for all flow classes universally.
We start with checking for and handling several special cases;
if none of them apply, we grow a shoot term for the given flow
and attach it to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        <p>Check if the flow is already exported.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        <p>Not reachable since we only call <code>InjectFlow</code> from
<code>InjectColumn</code> and <code>InjectKernel</code>, and those already
verified that the flow is not exported.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        <p>Check that the flow does not contain any non-axial operations
of the term flow -- that's enforced by unmasking process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        <p>A special case when the given flow is an ancestor of the term
flow.  The fact that the flow is not exported by the term means
that the term tree is optimized by cutting all axes below some
baseline.  Now we need to grow these axes back.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        <p>Verify that the flow is not in the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        <p>Here we compile a term corresponding to the flow and
attach it to the axis directly above it using a serial joint.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        <p>Compile a term for the missing axes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">lkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                                       <span class="n">baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">rkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        <p>Join the terms using a serial joint.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">joints</span> <span class="o">=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span>
            <span class="n">lkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">lkid</span><span class="p">,</span> <span class="n">joints</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>Since we are expanding the term baseline, the join is always
inner.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">is_left</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        <p>Re-use the old routing table, but add the new axis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
            <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        <p>Compile and return a join term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">lkid</span><span class="p">,</span> <span class="n">rkid</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span>
                            <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span>
                            <span class="n">rkid</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">lkid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        <p>None of the special cases apply, so we use a general method:
- grow a shoot term for the given flow;
- attach the shoot to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        <p>Compile a shoot term for the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        <p>The routes to add.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">extra_routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="n">extra_routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        <p>Join the shoot to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">flow_term</span><span class="p">,</span> <span class="n">extra_routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileScalar</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        <p>The root flow is a special case of the scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">(</span><span class="n">ScalarFlow</span><span class="p">,</span> <span class="n">RootFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        <p>If we are at the baseline (always the case for the root flow),
generate a scalar term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ScalarTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="p">{})</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        <p>Otherwise, compile a term for the parent flow and reuse
it for the scalar flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">term</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileTable</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        <p>Used for both direct and fiber table flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">TableFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        <p>We start with identifying and handling special cases, where
we able to generate a more optimal, less compex term tree than
in the regular case.  If none of the special cases are applicable,
we use the generic algorithm.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        <p>The first special case: we are at the baseline flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        <p>Generate a single table term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>The routing table includes all the columns of the table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="k">return</span> <span class="n">TableTerm</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        <p>Otherwise, we need a term corresponding to the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        <p>The second special case, when the term of the parent flow could also
serve as a term for the flow itself.  It is possible if the
following two conditions are met:
- the term exports the inflation of the given flow (<code>backbone</code>),
- the given flow conforms (has the same cardinality as) its base.
This case usually corresponds to an HTSQL expression of the form:
  (A?p(B)).B,
where <code>B</code> is a singular, non-nullable link from <code>A</code> and <code>p(B)</code> is
a predicate expression on <code>B</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">conforms</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">unit</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">))):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>We need to add the given flow to the routing table and
replace the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">routes</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">term</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        <p>Now the general case.  We take two terms:
- the term compiled for the parent flow
- and a table term corresponding to the flow table,
and join them using the tie between the flow and its parent.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        <p>This is the term for the flow base, we already generated it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lkid</span> <span class="o">=</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        <p>This is a table term corresponding to the flow table.
Instead of generating it directly, we call <code>compile</code>
on the same flow, but with a different baseline, so that it
will hit the first special case and produce a table term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">rkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        <p>The connections between the flow to its base.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">is_left</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        <p>We use the routing table of the base term with extra routes
corresponding to the given flow and its inflation which we
export from the table term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="n">lkid</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        <p>Generate a join term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">lkid</span><span class="p">,</span> <span class="n">rkid</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span>
                        <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">lkid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileQuotient</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">QuotientFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        <p>Normally, a quotient flow is represented by a seed term with
the baseline at the ground term.  If we can generate a term
with this shape, it is wrapped by a filter term to eliminate
<code>NULL</code> from the kernel and then by a projection term to
generate a proper quotient term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        <p>However it may happen that the seed term has the baseline
shorter than the ground.  In this case, the term has irregular
parallel and serial ties and therefore cannot represent
the quotient axis.  To hide the irregular structure, we are
forced to generate a trunk term from the parent flow and
manually project and attach the seed term to the trunk term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        <p>In addition, we may be asked to export some aggregates
over the complement flow.  We generate aggregate expressions
by pretending that the seed term actually represents
the complement flow and injecting the expressions into it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>Start with generating a term for the seed flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        <p>The ground flow is expected to be the baseline of the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        <p>However, the ground may not be inflated, so we need to find
an inflated ancestor.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="ow">not</span> <span class="n">baseline</span><span class="o">.</span><span class="n">is_inflated</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p>The seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        <p>Inject the kernel and filter out <code>NULL</code> kernel values.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        <p>Make sure the kernel expressions are exportable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">seed_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">seed_term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        <p>Generate filters:
  !is_null(kernel)&amp;...</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span>
                <span class="nb">filter</span> <span class="o">=</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="p">[</span><span class="nb">filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">filter</span> <span class="o">=</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">AndSig</span><span class="p">(),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>The final seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">seed_term</span> <span class="o">=</span> <span class="n">FilterTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span>
                                   <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                   <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        <p>Wrap the term to have a target for composite units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                                <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-160'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-160">#</a>
        </div>
        <p>Indicates that the seed term has the regular shape.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_regular</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-161'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-161">#</a>
        </div>
        <p>Inject aggregates suggested by the rewriter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-162'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-162">#</a>
        </div>
        <p>List of injected aggregate expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">aggregates</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-163'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-163">#</a>
        </div>
        <p>Clear out companions to avoid infinite recursion.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">quotient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">companions</span><span class="o">=</span><span class="p">[])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-164'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-164">#</a>
        </div>
        <p>The plural space for the aggregates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">complement</span> <span class="o">=</span> <span class="n">ComplementFlow</span><span class="p">(</span><span class="n">quotient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-165'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-165">#</a>
        </div>
        <p>We can only inject aggregates if the seed term has the regular shape.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span> <span class="ow">and</span> <span class="n">is_regular</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-166'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-166">#</a>
        </div>
        <p>We are going to disguise the seed term as a complement.
The routing table for the complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">complement</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">complement</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">inflate</span><span class="p">()):</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">complement</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-167'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-167">#</a>
        </div>
        <p>Disguise the seed term as a complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">complement_term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                                          <span class="n">complement</span><span class="p">,</span> <span class="n">complement</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-168'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-168">#</a>
        </div>
        <p>Inject aggregate expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">complement_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">complement_term</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-169'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-169">#</a>
        </div>
        <p>Abort if the shape of the term changed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">complement_term</span><span class="o">.</span><span class="n">baseline</span> <span class="o">==</span> <span class="n">complement</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-170'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-170">#</a>
        </div>
        <p>Remember what we just injected.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">aggregates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-171'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-171">#</a>
        </div>
        <p>Convert the complement term back to the seed term.
The routing table of the seed term will now have
extra aggregate expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                        <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">complement_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
                <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-172'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-172">#</a>
        </div>
        <p>Back to the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">seed_term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">complement_term</span><span class="p">,</span>
                                        <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                        <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-173'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-173">#</a>
        </div>
        <p>Prepare for generating the quotient term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-174'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-174">#</a>
        </div>
        <p>The term for the parent flow (may remain <code>None</code> if the baseline
is at the quotient).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-175'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-175">#</a>
        </div>
        <p>The basis of the projection.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-176'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-176">#</a>
        </div>
        <p>The units exported by the projection (against the inflated flow).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-177'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-177">#</a>
        </div>
        <p>The join conditions attaching the quotient term to the parent term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-178'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-178">#</a>
        </div>
        <p>Generate the trunk term and the join conditions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-179'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-179">#</a>
        </div>
        <p>Handle the regular case first.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">is_regular</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-180'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-180">#</a>
        </div>
        <p>Check if the term for the parent flow is necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-181'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-181">#</a>
        </div>
        <p>Generate the parent flow and the ties.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
                <span class="n">joints</span> <span class="o">=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-182'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-182">#</a>
        </div>
        <p>The irregular case, the seed baseline is below the ground.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-183'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-183">#</a>
        </div>
        <p>The trunk term is a must, even if the baseline is at
the current flow.  In that case, we need to lower the baseline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span>
            <span class="k">if</span> <span class="n">baseline</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-184'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-184">#</a>
        </div>
        <p>Generate the trunk term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-185'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-185">#</a>
        </div>
        <p>Join conditions between the trunk and the seed terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">seed_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_terms</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">seed_term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-186'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-186">#</a>
        </div>
        <p>Convert the join conditions to joints between the trunk
and the projection terms.  Also prepopulate the basis
and the list of units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">seed_joints</span><span class="p">:</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">KernelUnit</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
                <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
                <span class="n">joints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">rop</span><span class="o">=</span><span class="n">unit</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-187'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-187">#</a>
        </div>
        <p>Generate the the projection basis and a list of exported units.
Note that in the irregular case, those are already prepopulated
from the join conditions.
The units attaching the seed ground to the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span><span class="p">):</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">KernelUnit</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">rop</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-188'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-188">#</a>
        </div>
        <p>The kernel expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">KernelUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-189'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-189">#</a>
        </div>
        <p>Injected complement aggregates (regular case only).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">AggregateUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">complement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span>
                                 <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-190'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-190">#</a>
        </div>
        <p>FIXME: incomplete; not reachable because we raise an error
on a scalar kernel.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-191'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-191">#</a>
        </div>
        <p>When the kernel is scalar, to ensure proper conversion to SQL,
force <code>GROUP BY</code> to contain a reference from a subframe.  For
that, we create a permanent wrapper around the seed flow and
create a scalar unit pointing to that wrapper.  The unit
is added to the projection basis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">):</span>
            <span class="n">basis_code</span> <span class="o">=</span> <span class="n">LiteralCode</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">basis_unit</span> <span class="o">=</span> <span class="n">ScalarUnit</span><span class="p">(</span><span class="n">basis_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                                    <span class="n">basis_code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basis_unit</span><span class="p">)</span>
            <span class="n">routes</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">basis_unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">seed_term</span> <span class="o">=</span> <span class="n">PermanentTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                                      <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                      <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-192'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-192">#</a>
        </div>
        <p>Generate the projection term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-193'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-193">#</a>
        </div>
        <p>Convert the list of units to a routing table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-194'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-194">#</a>
        </div>
        <p>Generate a term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="n">ProjectionTerm</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">seed_term</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-195'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-195">#</a>
        </div>
        <p>If there is no parent term, we are done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">trunk_term</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-196'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-196">#</a>
        </div>
        <p>Otherwise, join the terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">joints</span><span class="p">)</span>
        <span class="n">rkid</span> <span class="o">=</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-197'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-197">#</a>
        </div>
        <p>The joined routing table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-198'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-198">#</a>
        </div>
        <p>Reparent exported units from the backbone to the original flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rkid</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-199'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-199">#</a>
        </div>
        <p>Generate and return a join node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_left</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">lkid</span><span class="p">,</span> <span class="n">rkid</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span>
                        <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">lkid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-200'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-200">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileComplement</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ComplementFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-201'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-201">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-202'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-202">#</a>
        </div>
        <p>A complement term, just like a quotient term is represented
by a seed term with a baseline at the seed ground.  As opposed
to the quotient term, we don't have to filter out <code>NULL</code> kernel
values as this filter is enforced by the quotient anyway.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-203'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-203">#</a>
        </div>
        <p>Since the quotient and the complement terms share the same
shape, we could reuse the complement term to export the respective
quotient flow.  In this case, we need to apply kernel filters.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-204'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-204">#</a>
        </div>
        <p>As in the quotient case, the seed term may have an irregular
shape, that is, the term baseline lies below the seed ground.
In this case, we manually attach the seed term to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-205'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-205">#</a>
        </div>
        <p>The flow node may contain extra code objects -- <code>companions</code>,
which indicate that the generated term should export covering
units wrapping the companions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-206'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-206">#</a>
        </div>
        <p>Generate the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-207'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-207">#</a>
        </div>
        <p>The baseline of the seed term is expected to be the seed ground flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-208'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-208">#</a>
        </div>
        <p>However it may be not inflated, in which case we find the closest
inflated axis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="ow">not</span> <span class="n">baseline</span><span class="o">.</span><span class="n">is_inflated</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-209'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-209">#</a>
        </div>
        <p>Create the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-210'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-210">#</a>
        </div>
        <p>Make sure the seed term can export the quotient kernel and the
extra companion expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">seed_term</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-211'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-211">#</a>
        </div>
        <p>Indicates whether the seed term has a regular shape.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_regular</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-212'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-212">#</a>
        </div>
        <p>Indicates that the generated term can export the quotient flow:
- we cannot omit generating the parent term because the baseline
  is below the current flow or the seed term is irregular.
- there are no filters or other non-axial operations between
  the complement and its quotient;
- the quotient flow does not have to export any aggregates.
Note that the seed term may have an irregular shape.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">has_quotient</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_regular</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">QuotientFlow</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">companions</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-213'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-213">#</a>
        </div>
        <p>If the term exports the quotient flow, we need to enforce the
condition: <code>!is_null(kernel)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">has_quotient</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-214'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-214">#</a>
        </div>
        <p>Generate a filter around the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span>
                <span class="nb">filter</span> <span class="o">=</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="p">[</span><span class="nb">filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">filter</span> <span class="o">=</span> <span class="n">FormulaCode</span><span class="p">(</span><span class="n">AndSig</span><span class="p">(),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">binding</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
            <span class="n">seed_term</span> <span class="o">=</span> <span class="n">FilterTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span>
                                   <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                   <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-215'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-215">#</a>
        </div>
        <p>Wrap the term to have a target for covering units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                                <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-216'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-216">#</a>
        </div>
        <p>Prepare for generating the complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-217'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-217">#</a>
        </div>
        <p>The term for the parent (or grandparent if <code>has_quotient</code>) flow.
May remain unset if the baseline at the current or the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-218'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-218">#</a>
        </div>
        <p>Flow units exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">covering_units</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-219'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-219">#</a>
        </div>
        <p>Units from the parent quotient flow exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">quotient_units</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-220'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-220">#</a>
        </div>
        <p>Join conditions attaching the term to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-221'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-221">#</a>
        </div>
        <p>Generate the trunk term if needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-222'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-222">#</a>
        </div>
        <p>The trunk flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-223'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-223">#</a>
        </div>
        <p>Use the grandparent flow if the quotient is already included
in the complement flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">has_quotient</span><span class="p">:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-224'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-224">#</a>
        </div>
        <p>Determine the baseline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-225'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-225">#</a>
        </div>
        <p>If the baseline is above the trunk flow, we can avoid generating
the trunk term, but only if the seed term has the regular shape.
Otherwise, lower the baseline till it reaches the trunk flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_regular</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">axis</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">baseline</span><span class="p">):</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-226'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-226">#</a>
        </div>
        <p>Generate the trunk term if needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">concludes</span><span class="p">(</span><span class="n">baseline</span><span class="p">):</span>
            <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-227'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-227">#</a>
        </div>
        <p>Generate the links to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">trunk_term</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-228'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-228">#</a>
        </div>
        <p>Add custom joints for the irregular case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_regular</span><span class="p">:</span>
                <span class="n">seed_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_terms</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">seed_term</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">seed_joints</span><span class="p">:</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span>
                                        <span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
                    <span class="n">joints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">rop</span><span class="o">=</span><span class="n">unit</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-229'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-229">#</a>
        </div>
        <p>Make sure the joint is exported by the complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                    <span class="n">covering_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-230'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-230">#</a>
        </div>
        <p>Add regular joints: the serial joints from the complement
flow (or the parent flow if it is included).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">has_quotient</span><span class="p">:</span>
                <span class="n">joints</span> <span class="o">+=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">joints</span> <span class="o">+=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-231'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-231">#</a>
        </div>
        <p>Populate units exported by the complement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-232'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-232">#</a>
        </div>
        <p>Add units from the parent quotient flow if needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">has_quotient</span><span class="p">:</span>
            <span class="n">quotient_backbone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">inflate</span><span class="p">()</span>
            <span class="n">quotient_units</span> <span class="o">=</span> <span class="n">spread</span><span class="p">(</span><span class="n">quotient_backbone</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-233'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-233">#</a>
        </div>
        <p>Wrap everything produced by the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">covering_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-234'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-234">#</a>
        </div>
        <p>Ensure we export serial ties.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span><span class="p">):</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">rop</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">covering_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-235'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-235">#</a>
        </div>
        <p>Export the kernel and any requested companion units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">covering_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-236'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-236">#</a>
        </div>
        <p>Generate the routing table and the complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-237'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-237">#</a>
        </div>
        <p>Export units from the quotient flow, if any.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">quotient_units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-238'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-238">#</a>
        </div>
        <p>Export complement units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">covering_units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-239'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-239">#</a>
        </div>
        <p>Export native units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-240'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-240">#</a>
        </div>
        <p>The baseline for the complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span>
        <span class="k">if</span> <span class="n">has_quotient</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-241'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-241">#</a>
        </div>
        <p>The complement term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-242'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-242">#</a>
        </div>
        <p>If there is no parental term, we are done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">trunk_term</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-243'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-243">#</a>
        </div>
        <p>Attach the complement term to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">joints</span><span class="p">)</span>
        <span class="n">rkid</span> <span class="o">=</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-244'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-244">#</a>
        </div>
        <p>Merge the routing table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-245'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-245">#</a>
        </div>
        <p>Now reparent the exported units to the given flow
(rather than the backbone).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">quotient_units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">covering_units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
        <span class="n">is_left</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-246'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-246">#</a>
        </div>
        <p>Generate and return the join term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">lkid</span><span class="p">,</span> <span class="n">rkid</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span>
                        <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">lkid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-247'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-247">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileCovering</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-248'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-248">#</a>
        </div>
        <p>The implementation is shared by these three covering flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">(</span><span class="n">MonikerFlow</span><span class="p">,</span> <span class="n">ForkedFlow</span><span class="p">,</span> <span class="n">LinkedFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-249'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-249">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-250'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-250">#</a>
        </div>
        <p>Moniker, forked and linked flows are represented as a seed term
with the baseline at the seed ground.  The compilation processes
for these types of flows are almost identical.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-251'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-251">#</a>
        </div>
        <p>If the seed term has an irregular shape, we must generate a term
for the parent flow and add custom joints between the seed
and the parent terms.  If the seed term is regular and the
baseline is at the current flow, we avoid generating a parent term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-252'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-252">#</a>
        </div>
        <p>The flow node may contain extra code objects -- <code>companions</code>,
which indicate that the generated term should export covering
units wrapping the companions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-253'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-253">#</a>
        </div>
        <p>Generate the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-254'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-254">#</a>
        </div>
        <p>The baseline of the seed term is expected to be the seed ground flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-255'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-255">#</a>
        </div>
        <p>However it may be not inflated, in which case we find the closest
inflated axis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span> <span class="ow">not</span> <span class="n">baseline</span><span class="o">.</span><span class="n">is_inflated</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-256'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-256">#</a>
        </div>
        <p>Create the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-257'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-257">#</a>
        </div>
        <p>The seed term may need to export some extra expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">codes</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-258'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-258">#</a>
        </div>
        <p>For the forked flow, it must export the kernel expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">ForkedFlow</span><span class="p">):</span>
            <span class="n">codes</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">kernels</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-259'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-259">#</a>
        </div>
        <p>For the linked flow, it must export the linking expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">LinkedFlow</span><span class="p">):</span>
            <span class="n">codes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rop</span> <span class="k">for</span> <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">images</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-260'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-260">#</a>
        </div>
        <p>Any companion expressions must also be included.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">codes</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span>
        <span class="n">seed_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">seed_term</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-261'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-261">#</a>
        </div>
        <p>Indicates whether the seed term has a regular shape.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_regular</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-262'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-262">#</a>
        </div>
        <p>Wrap the term to have a target for covering units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">seed_term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                                <span class="n">seed_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-263'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-263">#</a>
        </div>
        <p>Generate the trunk term and join conditions (if needed).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-264'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-264">#</a>
        </div>
        <p>The term for the parent flow.  May remain <code>None</code> if we already
reached the baseline.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-265'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-265">#</a>
        </div>
        <p>Join conditions attaching the term to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-266'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-266">#</a>
        </div>
        <p>The regular case: make the parent term only if the
baseline is below the given flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">is_regular</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">:</span>
                <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-267'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-267">#</a>
        </div>
        <p>We need the joints to produce covering units, so generate
them even when we do not use them for joining.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">joints</span> <span class="o">=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-268'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-268">#</a>
        </div>
        <p>The irregular case: we must create the parent term
even if the baseline is above the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-269'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-269">#</a>
        </div>
        <p>Lower the baseline if needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span>
            <span class="k">if</span> <span class="n">baseline</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">:</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-270'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-270">#</a>
        </div>
        <p>Compile a term for the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">trunk_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-271'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-271">#</a>
        </div>
        <p>Generate custom joints.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">shoot_term</span> <span class="o">=</span> <span class="n">seed_term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-272'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-272">#</a>
        </div>
        <p>For the forked flow, this is tricky as we can't join the trunk
to the seed term as usual -- we must leave the seed axis
free of joints.  Note that the seed baseline lies below
<code>ground.base</code> since the seed term is irregular.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">ForkedFlow</span><span class="p">):</span>
                <span class="n">seed_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_flows</span><span class="p">(</span><span class="n">trunk_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span>
                                              <span class="n">trunk_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">ground</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                                              <span class="n">seed_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-273'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-273">#</a>
        </div>
        <p>Otherwise, just attach the shoot term to the trunk term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span>
                <span class="n">seed_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_terms</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">shoot_term</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">seed_joints</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span>
                                    <span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
                <span class="n">joints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">rop</span><span class="o">=</span><span class="n">unit</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-274'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-274">#</a>
        </div>
        <p>Append regular joints.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">joints</span> <span class="o">+=</span> <span class="n">tie</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-275'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-275">#</a>
        </div>
        <p>Populate units exported by the covering term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-276'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-276">#</a>
        </div>
        <p>Wrap everything produced by the seed term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-277'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-277">#</a>
        </div>
        <p>Ensure we can satisfy the joints.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">joints</span><span class="p">:</span>
            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-278'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-278">#</a>
        </div>
        <p>Export any requested companion units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">CoveringUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-279'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-279">#</a>
        </div>
        <p>Generate the routing table and the covering term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-280'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-280">#</a>
        </div>
        <p>Export covering units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-281'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-281">#</a>
        </div>
        <p>Export native units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-282'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-282">#</a>
        </div>
        <p>The covering term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">seed_term</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-283'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-283">#</a>
        </div>
        <p>If there is no parental term, we are done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">trunk_term</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-284'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-284">#</a>
        </div>
        <p>Attach the covering term to the trunk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lkid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">trunk_term</span><span class="p">,</span> <span class="n">joints</span><span class="p">)</span>
        <span class="n">rkid</span> <span class="o">=</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-285'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-285">#</a>
        </div>
        <p>Merge the routing table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">routes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rkid</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-286'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-286">#</a>
        </div>
        <p>Reparent the exported units from the flow backbone to the flow itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">seed</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seed_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
        <span class="n">is_left</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-287'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-287">#</a>
        </div>
        <p>Join the terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">lkid</span><span class="p">,</span> <span class="n">rkid</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span>
                        <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">lkid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-288'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-288">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileFiltered</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">FilteredFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-289'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-289">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-290'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-290">#</a>
        </div>
        <p>The term corresponding to the parent flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-291'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-291">#</a>
        </div>
        <p>Make sure the base term is able to produce the filter expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">kid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">filter</span><span class="p">])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-292'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-292">#</a>
        </div>
        <p>Inherit the routing table from the base term, but add native
units of the given flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="n">kid</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-293'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-293">#</a>
        </div>
        <p>Generate a filter term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FilterTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">kid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">kid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-294'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-294">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompileOrdered</span><span class="p">(</span><span class="n">CompileFlow</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">OrderedFlow</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-295'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-295">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-296'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-296">#</a>
        </div>
        <p>An ordered flow has two functions:
- adding explicit row ordering;
- extracting a slice from the row set.
Note the first function could be ignored since the compiled terms
are not required to respect the ordering of the underlying flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-297'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-297">#</a>
        </div>
        <p>When the order flow does not apply limit/offset, we could simply
reuse the base term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">is_expanding</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-298'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-298">#</a>
        </div>
        <p>Generate a term for the flow base.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-299'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-299">#</a>
        </div>
        <p>Update its routing table to include the given flow and
return the node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">routes</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">term</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-300'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-300">#</a>
        </div>
        <p>Applying limit/offset requires special care.  Since slicing
relies on precise row numbering, the base term must produce
exactly the rows of the base.  Therefore we cannot use any
baseline or unmask non-axial operations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-301'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-301">#</a>
        </div>
        <p>Extract the flow ordering and make sure the base term is able
to produce the order expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">order</span> <span class="o">=</span> <span class="n">arrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
        <span class="n">kid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                                  <span class="n">baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="n">kid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">kid</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-302'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-302">#</a>
        </div>
        <p>Add the given flow to the routing table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="n">kid</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">spread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">)]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-303'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-303">#</a>
        </div>
        <p>Generate an order term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">OrderTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">kid</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">kid</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-304'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-304">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectCode</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">Code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-305'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-305">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-306'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-306">#</a>
        </div>
        <p>Inject all the units that compose the expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">units</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-307'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-307">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectUnit</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-308'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-308">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">Unit</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InjectUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-309'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-309">#</a>
        </div>
        <p>Extract the unit attributes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-310'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-310">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-311'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-311">#</a>
        </div>
        <p>Normally, this should never be reachable.  We raise an error here
to prevent an infinite recursion via <code>InjectCode</code> in cases when
<code>Inject</code> is not implemented for some unit type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the inject adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-312'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-312">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectColumn</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ColumnUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-313'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-313">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-314'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-314">#</a>
        </div>
        <p>To avoid an extra <code>inject()</code> call, check if the unit flow
is already exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-315'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-315">#</a>
        </div>
        <p>Not reachable since already checked in <code>state.inject()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-316'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-316">#</a>
        </div>
        <p>Verify that the unit is singular on the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s">&quot;expected a singular expression&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-317'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-317">#</a>
        </div>
        <p>Inject the unit flow into the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">flow</span><span class="p">])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-318'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-318">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectScalar</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ScalarUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-319'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-319">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-320'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-320">#</a>
        </div>
        <p>Injects a batch of scalar units sharing the same flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-321'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-321">#</a>
        </div>
        <p>To inject a scalar unit into a term, we need to do the following:
- compile a term for the unit flow;
- inject the unit into the unit term;
- attach the unit term to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-322'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-322">#</a>
        </div>
        <p>If we compile a unit term for each unit individually, we may
end up with a lot of identical unit terms in the term tree.
To optimize the structure of the term tree, the rewriter
collects all scalar units sharing the same flow and groups
them together so that the compiler could reuse the same term
for the whole group.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-323'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-323">#</a>
        </div>
        <p>Check if the unit is already exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-324'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-324">#</a>
        </div>
        <p>Not reachable since already checked in <code>state.inject()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-325'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-325">#</a>
        </div>
        <p>List of units to inject.  This includes the given unit itself
and the units suggested be injected together with it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">companions</span><span class="p">:</span>
            <span class="n">companion_unit</span> <span class="o">=</span> <span class="n">ScalarUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-326'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-326">#</a>
        </div>
        <p>This test rarely fails since injecting any of the companions
injects the whole group.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">companion_unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
                <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">companion_unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-327'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-327">#</a>
        </div>
        <p>Verify that the unit is singular relative to the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s">&quot;expected a singular expression&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-328'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-328">#</a>
        </div>
        <p>Extract the unit expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-329'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-329">#</a>
        </div>
        <p>Handle the special case when the unit flow is equal to the
term flow or dominates it.  In this case, we could inject
the units directly to the main term and avoid creating
a separate unit term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-330'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-330">#</a>
        </div>
        <p>This is no longer reachable since unmasking removes
scalar units that dominate their mask flow.
Make sure the term could export all the units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-331'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-331">#</a>
        </div>
        <p>Add all the units to the routing table.  Note that we point
the units to the wrapper because the given term could be
terminal (i.e., a table) and SQL syntax does not permit
exporting arbitrary expressions from tables.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">()</span>
            <span class="n">routes</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-332'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-332">#</a>
        </div>
        <p>Wrap the term with the updated routing table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-333'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-333">#</a>
        </div>
        <p>The general case: compile a term for the unit flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-334'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-334">#</a>
        </div>
        <p>SQL syntax does not permit us evaluating arbitrary
expressions in terminal terms, so we wrap such terms with
a no-op wrapper.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">is_nullary</span><span class="p">:</span>
            <span class="n">unit_term</span> <span class="o">=</span> <span class="n">WrapperTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">unit_term</span><span class="p">,</span>
                                    <span class="n">unit_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                                    <span class="n">unit_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-335'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-335">#</a>
        </div>
        <p>And join it to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">extra_routes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">unit</span><span class="p">,</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">unit_term</span><span class="p">,</span> <span class="n">extra_routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-336'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-336">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectAggregate</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">AggregateUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-337'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-337">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InjectAggregate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-338'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-338">#</a>
        </div>
        <p>Extract attributes of the unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">plural_flow</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">plural_flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-339'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-339">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-340'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-340">#</a>
        </div>
        <p>Injects a batch of aggregate units sharing the same plural
and unit flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-341'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-341">#</a>
        </div>
        <p>To inject an aggregate unit into a term, we do the following:
- compile a term for the unit flow;
- compile a term for the plural flow relative to the unit term;
- inject the unit expression into the plural term;
- project plural term into the unit flow;
- attach the projected term to the unit term;
- attach the unit term to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-342'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-342">#</a>
        </div>
        <p>When the unit flow coincides with the main term flow, we could
avoid compiling a separate unit term, and instead attach the
projected term directly to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-343'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-343">#</a>
        </div>
        <p>Check if the unit is already exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-344'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-344">#</a>
        </div>
        <p>Not reachable since already checked in <code>state.inject()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-345'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-345">#</a>
        </div>
        <p>When we inject many aggregates to the main term individually,
we may end up with a lot of identical subtrees in the final
term tree.  Therefore, the rewritter collects aggregates
sharing the same plural and unit flows and groups them together
so that the compiler could reuse the same term subtree for
the whole group.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-346'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-346">#</a>
        </div>
        <p>Get the list of units to inject.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">companions</span><span class="p">:</span>
            <span class="n">companion_unit</span> <span class="o">=</span> <span class="n">AggregateUnit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plural_flow</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-347'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-347">#</a>
        </div>
        <p>This test rarely fails since injecting any of the companions
injects the whole group.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">companion_unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
                <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">companion_unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-348'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-348">#</a>
        </div>
        <p>Verify that the units are singular relative to the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s">&quot;expected a singular expression&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-349'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-349">#</a>
        </div>
        <p>Extract the aggregate expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-350'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-350">#</a>
        </div>
        <p>Check if the unit can be attached directly to the trunk term.
It is possible only if the unit flow coincides with or dominates
the trunk flow or one of its ancestors.  In this case, we could
avoid compiling a separate unit term and instead attach the
projected term directly to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_native</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-351'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-351">#</a>
        </div>
        <p>The attachment point.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit_flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-352'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-352">#</a>
        </div>
        <p>Iterate over all ancestors of the term flow till (if) we find
the attachment point.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">while</span>  <span class="n">unit_flow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">unit_flow</span><span class="p">):</span>
                <span class="n">is_native</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
            <span class="n">unit_flow</span> <span class="o">=</span> <span class="n">unit_flow</span><span class="o">.</span><span class="n">base</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-353'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-353">#</a>
        </div>
        <p>The trunk term can serve as the unit term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">is_native</span><span class="p">:</span>
            <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-354'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-354">#</a>
        </div>
        <p>Note that the attachment point may be below the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">unit_baseline</span> <span class="o">=</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">baseline</span>
        <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-355'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-355">#</a>
        </div>
        <p>Compile a separate term for the unit flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span>
            <span class="n">unit_flow</span> <span class="o">=</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">flow</span>
            <span class="n">unit_baseline</span> <span class="o">=</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">baseline</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-356'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-356">#</a>
        </div>
        <p>Compile a term for the plural flow against the unit flow,
and inject all the aggregate expressions into it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">plural_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plural_flow</span><span class="p">,</span>
                                         <span class="n">unit_flow</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-357'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-357">#</a>
        </div>
        <p>Generate joints to attach the projected term to the unit term.
Note that we attaching not to the term itself, but to
the attaching point we determined before.  The attachment
point may lie below the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_flows</span><span class="p">(</span><span class="n">unit_flow</span><span class="p">,</span> <span class="n">unit_baseline</span><span class="p">,</span>
                                      <span class="n">plural_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">plural_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-358'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-358">#</a>
        </div>
        <p>Make sure the unit term could export the join conditions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">unit_term</span><span class="p">,</span> <span class="n">unit_joints</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-359'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-359">#</a>
        </div>
        <p>Now we are going to project the plural term onto the unit
flow.  As the projection basis, we are using the joints
generated by <code>glue_terms()</code>.  The flow corresponding to
the projection term is a quotient with the kernel formed
from the projection basis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">basis</span> <span class="o">=</span> <span class="p">[</span><span class="n">runit</span> <span class="k">for</span> <span class="n">lunit</span><span class="p">,</span> <span class="n">runit</span> <span class="ow">in</span> <span class="n">unit_joints</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-360'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-360">#</a>
        </div>
        <p>Determine the flow of the projected term (not necessarily
accurate, but we don't care).
FIXME: should the kernel of the quotient be <code>basis</code>?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">projected_flow</span> <span class="o">=</span> <span class="n">QuotientFlow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">inflate</span><span class="p">(),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">plural_flow</span><span class="p">,</span> <span class="p">[],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-361'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-361">#</a>
        </div>
        <p>The routing table of the projected term and join conditions
connecting the projected term to the unit term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">()</span>
        <span class="n">joints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">unit_joints</span><span class="p">:</span>
            <span class="n">rop</span> <span class="o">=</span> <span class="n">KernelUnit</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="n">projected_flow</span><span class="p">,</span> <span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="o">.</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">rop</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="n">joints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-362'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-362">#</a>
        </div>
        <p>The term that computes aggregate expressions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">projected_term</span> <span class="o">=</span> <span class="n">ProjectionTerm</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">plural_term</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span>
                                        <span class="n">projected_flow</span><span class="p">,</span> <span class="n">projected_flow</span><span class="p">,</span>
                                        <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-363'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-363">#</a>
        </div>
        <p>Attach the projected term to the unit term, add extra entries
to the routing table for each of the unit in the collection.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_left</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">projected_flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="n">unit_term</span><span class="o">.</span><span class="n">flow</span><span class="p">))</span>
        <span class="n">is_right</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-364'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-364">#</a>
        </div>
        <p>Use the routing table of the trunk term, but also add
the given extra routes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
            <span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">projected_term</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-365'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-365">#</a>
        </div>
        <p>Generate and return a join term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit_term</span> <span class="o">=</span> <span class="n">JoinTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">unit_term</span><span class="p">,</span> <span class="n">projected_term</span><span class="p">,</span>
                             <span class="n">joints</span><span class="p">,</span> <span class="n">is_left</span><span class="p">,</span> <span class="n">is_right</span><span class="p">,</span>
                             <span class="n">unit_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-366'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-366">#</a>
        </div>
        <p>For native units, we are done since we use the main term as
the unit term.  Note: currently this condition always holds.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">is_native</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unit_term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-367'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-367">#</a>
        </div>
        <p>Otherwise, attach the unit term to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">extra_routes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">unit</span><span class="p">,</span> <span class="n">projected_term</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">unit_term</span><span class="p">,</span> <span class="n">extra_routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-368'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-368">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectCorrelated</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">CorrelatedUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-369'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-369">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-370'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-370">#</a>
        </div>
        <p>In the term tree, correlated subqueries are represented using
a pair of correlation and embedding term nodes.  A correlation
term connects its operand to an external <em>link</em> term.  An embedding
term implants the correlation term into the term tree.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-371'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-371">#</a>
        </div>
        <p>Check if the unit is already exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-372'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-372">#</a>
        </div>
        <p>Not reachable since already checked in <code>state.inject()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-373'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-373">#</a>
        </div>
        <p>Verify that the unit is singular on the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-374'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-374">#</a>
        </div>
        <p>This is not reachable: the error is already reported by
the wrapping scalar unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s">&quot;expected a singular expression&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-375'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-375">#</a>
        </div>
        <p>The general chain of operations is as follows:
  - compile a term for the unit flow;
  - inject the unit into the unit term;
  - attach the unit term to the main term.
However, when the unit flow coincides with the term flow,
it could be reduced to:
  - inject the unit directly into the main term.
We say that the unit is <em>native</em> to the term if the unit
flow coincides with the term flow (or dominates over it).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-376'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-376">#</a>
        </div>
        <p>Note that currently the latter is always the case because
all correlated units are wrapped with a scalar unit sharing
the same unit flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-377'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-377">#</a>
        </div>
        <p>Check if the unit is native to the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_native</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">dominates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_native</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-378'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-378">#</a>
        </div>
        <p>If so, we are going to inject the unit directly into the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span>
        <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-379'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-379">#</a>
        </div>
        <p>Otherwise, compile a separate term for the unit flow.
Note: not reachable as currently correlated units are always
wrapped by a scalar unit with the same base flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-380'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-380">#</a>
        </div>
        <p>Compile a term for the correlated subquery.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">plural_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">plural_flow</span><span class="p">,</span>
                                         <span class="n">unit_term</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span><span class="p">])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-381'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-381">#</a>
        </div>
        <p>The ties connecting the correlated subquery to the main query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glue_terms</span><span class="p">(</span><span class="n">unit_term</span><span class="p">,</span> <span class="n">plural_term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-382'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-382">#</a>
        </div>
        <p>Make sure that the unit term could export tie conditions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">unit_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_joints</span><span class="p">(</span><span class="n">unit_term</span><span class="p">,</span> <span class="n">joints</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-383'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-383">#</a>
        </div>
        <p>Connect the plural term to the unit term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">plural_term</span> <span class="o">=</span> <span class="n">CorrelationTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">plural_term</span><span class="p">,</span>
                                      <span class="n">unit_term</span><span class="p">,</span> <span class="n">joints</span><span class="p">,</span> <span class="n">plural_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span>
                                      <span class="n">plural_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">plural_term</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-384'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-384">#</a>
        </div>
        <p>Implant the correlation term into the term tree.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">routes</span> <span class="o">=</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">routes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">plural_term</span><span class="o">.</span><span class="n">tag</span>
        <span class="n">unit_term</span> <span class="o">=</span> <span class="n">EmbeddingTerm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tag</span><span class="p">(),</span> <span class="n">unit_term</span><span class="p">,</span> <span class="n">plural_term</span><span class="p">,</span>
                                  <span class="n">unit_term</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="n">unit_term</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-385'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-385">#</a>
        </div>
        <p>If we attached the unit directly to the main term, we are done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">is_native</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unit_term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-386'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-386">#</a>
        </div>
        <p>Otherwise, we need to attach the unit term to the main term.
Not reachable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">extra_routes</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span> <span class="n">plural_term</span><span class="o">.</span><span class="n">tag</span> <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">unit_term</span><span class="p">,</span> <span class="n">extra_routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-387'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-387">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectKernel</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">KernelUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-388'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-388">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-389'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-389">#</a>
        </div>
        <p>Check if the unit is already exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-390'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-390">#</a>
        </div>
        <p>Not reachable since already checked in <code>state.inject()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-391'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-391">#</a>
        </div>
        <p>Check if the unit is singular against the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s">&quot;expected a singular expression&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-392'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-392">#</a>
        </div>
        <p>Inject the quotient space -- this should automatically
provide the unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-393'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-393">#</a>
        </div>
        <p>Verify that the unit is injected.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-394'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-394">#</a>
        </div>
        <p>Return an augmented term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-395'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-395">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">InjectCovering</span><span class="p">(</span><span class="n">Inject</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">CoveringUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-396'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-396">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-397'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-397">#</a>
        </div>
        <p>Check if the unit is already exported by the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-398'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-398">#</a>
        </div>
        <p>Not reachable since already checked in <code>state.inject()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-399'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-399">#</a>
        </div>
        <p>Ensure that the unit is singular against the term flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">spans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-400'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-400">#</a>
        </div>
        <p>Not reachable since covering units are never generated
by the user directly, only by the compiler.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="s">&quot;expected a singular expression&quot;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">mark</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-401'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-401">#</a>
        </div>
        <p>FIXME: the rewritter should optimize the flow graph
so that this code is not reachable.
Add a hint to the flow node to ask the compiler generate
the unit when compiling the flow term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">companions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">companions</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span><span class="p">]</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">companions</span><span class="o">=</span><span class="n">companions</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-402'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-402">#</a>
        </div>
        <p>In general, we can't inject the flow into the term
directly as we could hit the special case when the
flow is an ancestor of the term flow.  Instead, we
inject the flow manually.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-403'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-403">#</a>
        </div>
        <p>Compile a shoot term for the flow.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">flow_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile_shoot</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-404'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-404">#</a>
        </div>
        <p>Add the route to the new unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">extra_routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extra_routes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_term</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-405'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-405">#</a>
        </div>
        <p>Join the shoot to the main term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">flow_term</span><span class="p">,</span> <span class="n">extra_routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-406'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-406">#</a>
        </div>
        <p>Verify that the unit is injected.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-407'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-407">#</a>
        </div>
        <p>Return the augmented term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">term</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-408'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-408">#</a>
        </div>
        <p>Compiles a new term node for the given expression.</p>
<p>Returns a :class:<code>htsql.tr.term.Term</code> instance.</p>
<p><code>expression</code> (:class:<code>htsql.tr.flow.Expression</code>)
<pre>An expression node.
</pre>
<code>state</code> (:class:<code>CompilingState</code> or <code>None</code>)
The compiling state to use.  If not set, a new compiling state
is instantiated.</p>
<p><code>baseline</code> (:class:<code>htsql.tr.flow.Flow</code> or <code>None</code>)
The baseline flow.  Specifies an axis that the compiled
term must export.  If not set, the current baseline flow of
the state is used.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-409'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-409">#</a>
        </div>
        <p>Instantiate a new compiling state if not given one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">CompilingState</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-410'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-410">#</a>
        </div>
        <p>If passed, assign new baseline and mask flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">push_baseline</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-411'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-411">#</a>
        </div>
        <p>Realize and apply the <code>Compile</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="nb">compile</span> <span class="o">=</span> <span class="n">Compile</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">term</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-412'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-412">#</a>
        </div>
        <p>Restore old baseline and mask flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop_baseline</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-413'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-413">#</a>
        </div>
        <p>Return the compiled term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">return</span> <span class="n">term</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
