<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>reduce.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>reduce.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql.tr.reduce</code></h1>
<p>This module implements the reducing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">..adapter</span> <span class="kn">import</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">adapts</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="n">BooleanDomain</span><span class="p">,</span> <span class="n">StringDomain</span>
<span class="kn">from</span> <span class="nn">.coerce</span> <span class="kn">import</span> <span class="nb">coerce</span>
<span class="kn">from</span> <span class="nn">.stitch</span> <span class="kn">import</span> <span class="n">arrange</span>
<span class="kn">from</span> <span class="nn">.term</span> <span class="kn">import</span> <span class="n">PermanentTerm</span>
<span class="kn">from</span> <span class="nn">.frame</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Clause</span><span class="p">,</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">ScalarFrame</span><span class="p">,</span> <span class="n">BranchFrame</span><span class="p">,</span> <span class="n">NestedFrame</span><span class="p">,</span>
                    <span class="n">QueryFrame</span><span class="p">,</span> <span class="n">Phrase</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">,</span>
                    <span class="n">TruePhrase</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">,</span> <span class="n">CastPhrase</span><span class="p">,</span> <span class="n">FormulaPhrase</span><span class="p">,</span>
                    <span class="n">ExportPhrase</span><span class="p">,</span> <span class="n">ReferencePhrase</span><span class="p">,</span> <span class="n">Anchor</span><span class="p">,</span> <span class="n">LeadingAnchor</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.signature</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Signature</span><span class="p">,</span> <span class="n">isformula</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">,</span> <span class="n">IsTotallyEqualSig</span><span class="p">,</span>
                        <span class="n">IsInSig</span><span class="p">,</span> <span class="n">IsNullSig</span><span class="p">,</span> <span class="n">IfNullSig</span><span class="p">,</span> <span class="n">NullIfSig</span><span class="p">,</span>
                        <span class="n">AndSig</span><span class="p">,</span> <span class="n">OrSig</span><span class="p">,</span> <span class="n">NotSig</span><span class="p">,</span> <span class="n">FromPredicateSig</span><span class="p">,</span>
                        <span class="n">ToPredicateSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Encapsulates the state of the reducing and collapsing processes.</p>
<p>State attributes:</p>
<p><code>substitutes</code> (a mapping <code>tag -&gt; list of phrases</code>)
<pre>A mapping containing the <code>SELECT</code> clause of collapsed frames.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReducingState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p><code>SELECT</code> clauses of collapsed frames by the frame tag.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">substitutes</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p></pre>Clears the state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">substitutes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>Reduces (simplifies) a SQL clause.</p>
<p>Returns an equivalent (possibly the same) clause.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
<pre>The clause to simplify.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Realize and apply the <code>Reduce</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p></pre>Collapses a frame.</p>
<p>Returns an equivalent (possibly the same) frame.</p>
<p>Note that the generated frame may contain some clauses that refer
to subframes which no longer exist.  To fix broken references,
apply :meth:<code>reduce</code> to the returned frame.</p>
<p><code>frame</code> (:class:<code>htsql.tr.frame.Frame</code>)
<pre>The frame to collapse.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">collapse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>Realize and apply the <code>Collapse</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">collapse</span> <span class="o">=</span> <span class="n">Collapse</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collapse</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">):</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">ToPredicateSig</span><span class="p">(),</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                               <span class="n">phrase</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                               <span class="n">op</span><span class="o">=</span><span class="n">phrase</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">from_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">):</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">FromPredicateSig</span><span class="p">(),</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                               <span class="n">phrase</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                               <span class="n">op</span><span class="o">=</span><span class="n">phrase</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p></pre>Reduces (simplifies) a SQL clause.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>The :class:<code>Reduce</code> adapter has the following signature::</p>
<pre>Reduce: (Clause, ReducingState) -> Clause
</pre>

<p>The adapter is polymorphic on the <code>Claim</code> argument.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
The clause node.</p>
<p><code>state</code> (:class:<code>ReducingState</code>)
The current state of the reducing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Reduce</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="n">Clause</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ReducingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clause</span> <span class="o">=</span> <span class="n">clause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p>Implement in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the reduce adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p>Reduces a SQL frame.</p>
<p>The adapter collapses the subframes of the frame node and simplifies
its clauses.  This is an abstract adapter; see subclasses for concrete
implementations.</p>
<p><code>frame</code> (:class:<code>htsql.tr.frame.Frame</code>)
<pre>The frame node.
</pre>
<code>state</code> (:class:<code>ReducingState</code>)
The current state of the reducing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceFrame</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ReduceFrame</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p>Return the frame itself; this default implementation is used
only by a table frame.  The scalar, the nested and the segment
frames have more elaborate implementations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p>Reduces a scalar frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceScalar</span><span class="p">(</span><span class="n">ReduceFrame</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">ScalarFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p>The databases we currently support have no notion of a <code>DUAL</code>
table, so we replace scalar frame with an empty <code>SELECT</code>
statement.  Databases with a native <code>DUAL</code> table may need
to override this implementation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">expression</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">NestedFrame</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[],</span> <span class="n">embed</span><span class="o">=</span><span class="p">[],</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span>
                           <span class="n">where</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="p">[],</span> <span class="n">having</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">order</span><span class="o">=</span><span class="p">[],</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">term</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        <p>Reduces a top-level or a nested <code>SELECT</code> statement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceBranch</span><span class="p">(</span><span class="n">ReduceFrame</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">BranchFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_include</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        <p>Reduce the anchors of the subframes.  This will also
collapse and reduce the subframes themselves.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>Collapse and reduce the embedded subframes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">embed</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Reduce the <code>SELECT</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">select</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_where</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <p>Reduce the <code>WHERE</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">where</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>Eliminate a <code>WHERE TRUE</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">):</span>
            <span class="n">where</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">where</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        <p>Reduce the <code>GROUP BY</code> clause.
Here we reduce all the phrases in the <code>GROUP BY</code> clause and
also eliminate duplicates and literals.  As a result of the latter,
we may produce an empty <code>GROUP BY</code> clause (for instance, for scalar
projections), which may confuse the frame collapser or even
change the semantics of the <code>SELECT</code> statement.  Because of that,
<code>collapse()</code> should never be applied after <code>reduce()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
            <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_having</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        <p>Reduce the <code>HAVING</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">having</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Eliminate a <code>HAVING TRUE</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">having</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">):</span>
            <span class="n">having</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">having</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reduce_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Reduce the <code>ORDER BY</code> clause.
Here we reduce all the phrases in the <code>ORDER BY</code> clause and
also eliminate duplicates and literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">phrase</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>Reduce a <code>SELECT</code> statement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        <p>Reduce and collapse the subframes in the <code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">include</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_include</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>Reduce and collapse the embedded subframes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_embed</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>Reduce the <code>SELECT</code>, <code>WHERE</code>, <code>GROUP BY</code>, <code>HAVING</code>, and
<code>ORDER BY</code> clauses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_select</span><span class="p">()</span>
        <span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_where</span><span class="p">()</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_group</span><span class="p">()</span>
        <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_having</span><span class="p">()</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_order</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p>Return a frame with reduced clauses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="n">embed</span><span class="p">,</span>
                                <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
                                <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="o">=</span><span class="n">having</span><span class="p">,</span>
                                <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p>Collapses nested subframes of the given frame.</p>
<p>Returns an equivalent (possibly the same) frame.</p>
<p>This is an auxiliary adapter used for flattening the frame structure.
Using this adapter may remove some frames from the frame tree and thus
invalidate any references to these frames.  Apply the :class:<code>Reduce</code>
adapter to fix the references.</p>
<p><code>frame</code> (:class:<code>htsql.tr.frame.Frame</code>)
<pre>The frame node.
</pre>
<code>state</code> (:class:<code>ReducingState</code>)
The current state of the reducing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Collapse</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">Frame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ReducingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        <p>The default implementation does nothing; used by leaf frames.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Collapses a branch frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">CollapseBranch</span><span class="p">(</span><span class="n">Collapse</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">BranchFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        <p>Here we attempt to dismantle the first subframe in the <code>FROM</code>
clause and include its content to the outer frame.  We continue
this process until no further reductions could be done.
We must be especially careful to not change the semantics
of the query!
FIXME: we do not attempt to absorb the content of any other
subframe but the first one.  It may be even trickier because
we need to carry over the <code>JOIN</code> condition.  There are some
cases when we may want to absorb the second subframe
(see a special case in <code>InjectFlow</code> when we grow a missing
axis).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>No subframes in the <code>FROM</code> clause -- nothing to do.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        <p>The first subframe; let us try to eliminate it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        <p>The rest of the <code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        <p>A frame corresponding to a permanent term is never collapsed down.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">PermanentTerm</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        <p>Any subframe, including the head frame, is one of theses:
- a scalar frame, we could just discard it;
- a table frame, there is nothing we can do;
- a nested <code>SELECT</code> frame, if possible, include the
  content of the subframe into the outer frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        <p>First, check if the head frame is scalar.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        <p>We could only discard the head subframe if the subframe
next to it has no <code>JOIN</code> condition (or the <code>FROM</code> clause
contains a single subframe).
FIXME: Some databases (i.e., Oracle) forbid an empty
<code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">tail</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_cross</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        <p>Indicate that the first anchor in the tail is now
a leading anchor.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">tail</span><span class="p">:</span>
                <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone_to</span><span class="p">(</span><span class="n">LeadingAnchor</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Make a new frame with a reduced <code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">tail</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        <p>Try to further collapse the frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        <p>Now, only two possibilities are left: the head frame is either
a nested frame or a table frame.  If it is a table frame,
we are done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">head</span><span class="o">.</span><span class="n">is_nested</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        <p>Here goes a long list of checks to ensure we could merge the
content of the head subframe without breaking the query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        <p>If the head subframe by itself has no subframes, the subframe
next to the head leads the <code>FROM</code> clause.  It is only valid
if the subframe has no <code>JOIN</code> condition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">head</span><span class="o">.</span><span class="n">include</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tail</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_cross</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        <p>We cannot safely collapse the head subframe if some other
subframe is attached using a <code>RIGHT OUTER</code> join.  Currently,
the compiler never generates right joins, so this check
is effectively no-op.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">anchor</span><span class="o">.</span><span class="n">is_right</span> <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">tail</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        <p>A tricky case, the head subframe contains a <code>GROUP BY</code> clause.
We collapse frames like this only when they correspond to a
scalar projection, like in <code>/count(table)</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">group</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        <p>Verify that the kernel of the projection contains only
literal phrases, and thus will be eliminated by the reducer
(technically, it should contain a single <code>TRUE</code> literal,
but checking for arbitrary literals does not hurt).
if not all(isinstance(phrase, LiteralPhrase)
          for phrase in head.group):
   return self.frame</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        <p>We only collapse a projection subframe if it is the only
subframe in the <code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">tail</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        <p>Ensure that the outer frame has no projection clauses, i.e.,
<code>GROUP BY</code> and <code>HAVING</code>.
The outer frame could still have <code>WHERE</code> clause (to be
moved to <code>HAVING</code>), as well as <code>ORDER BY</code>, <code>LIMIT</code>, and <code>OFFSET</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">group</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        <p>Ensure that the subframe has no <code>HAVING</code> clause.
The subframe could still have <code>WHERE</code>, <code>ORDER BY</code>, <code>LIMIT</code>,
and <code>OFFSET</code> clauses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        <p>If the outer frame has a <code>WHERE</code> clause, make sure the
<code>GROUP BY</code> clause of the subframe is not trivial since
not every database engine can handle <code>HAVING</code> without
<code>GROUP BY</code> (PostgreSQL can, SQLite cannot).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">head</span><span class="o">.</span><span class="n">group</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        <p>If we reached this point, the <code>HAVING</code> clause of the head subframe
must be empty.  This check is no-op though since we never generate
<code>HAVING</code> in the first place.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">head</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        <p>Another tricky case: the subframe has a <code>LIMIT</code> or an <code>OFFSET</code>
clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="n">head</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        <p>Now we need to answer the question: could we safely merge
the head frame to the outer frame.  It is only safe when
both the outer and the inner frames produce the same
number of rows.  However we cannot deduce that from the
frame structure only, so we analyze the flows from which
the frames were compiled.
The inner and the outer frames would produce the same number
of rows if they are compiled from the same flow, or, at
least, the flows they are compiled from conform to each
other.  We also verify that their baseline flows are equal,
but this is a redundant check -- precense of a non-trivial
<code>LIMIT</code> or <code>OFFSET</code> implies that the baseline is the scalar
flow (see <code>CompileOrdered</code> in <code>htsql.tr.compile</code>).
Other than that, we also need to check that the <code>ORDER BY</code>
clauses of the inner and outer frames coincide (if they
both are non-empty).  We cannot compare the clauses directly
since they contain different export references, but we
can compare the ordering of the underlying flows.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">conforms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">head</span><span class="o">.</span><span class="n">baseline</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">baseline</span> <span class="ow">and</span>
                    <span class="n">arrange</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span> <span class="o">==</span> <span class="n">arrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">flow</span><span class="p">)):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        <p>Another safe case is when the outer frame contains
no clauses that may change the cardinality of the inner
frame, including no other <code>FROM</code> subframes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">group</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">having</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">order</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="n">tail</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        <p>Since the inner and the outer flows conform to each other,
the outer frame cannot contain non-trivial <code>LIMIT</code> and <code>OFFSET</code>
clauses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        <p>All checks passed, now we merge the head subframe to the outer
frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>Merge the <code>FROM</code> clause of the head with the rest of the <code>FROM</code>
clause of the frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">head</span><span class="o">.</span><span class="n">include</span> <span class="ow">and</span> <span class="n">tail</span><span class="p">:</span>
            <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone_to</span><span class="p">(</span><span class="n">LeadingAnchor</span><span class="p">)</span>
        <span class="n">include</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">include</span><span class="o">+</span><span class="n">tail</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>Merge the embedded subframes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">embed</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">embed</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">embed</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        <p>Now that we merged the head subframe, all references to it
are broken and have to be replaced with the referenced phrases.
It is done by <code>reduce()</code>, but here we need to save the referenced
phrases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">head</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">substitutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">substitutes</span><span class="p">[</span><span class="n">head</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">select</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        <p>Merge the <code>WHERE</code> clauses; both the inner and the outer <code>WHERE</code>
clauses could be non-empty, in which case we join them with <code>AND</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">where</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">head</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
            <span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">where</span>
        <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">where</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">where</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">head</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
                <span class="n">where</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">AndSig</span><span class="p">(),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                      <span class="n">is_nullable</span><span class="p">,</span> <span class="n">where</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                      <span class="n">ops</span><span class="o">=</span><span class="p">[</span><span class="n">where</span><span class="p">,</span> <span class="n">head</span><span class="o">.</span><span class="n">where</span><span class="p">])</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        <p>Pull the <code>GROUP BY</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">group</span>
        <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">group</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">group</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        <p>If the subframe contains a <code>GROUP BY</code> clause, move the <code>WHERE</code>
clause of the outer frame to <code>HAVING</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">having</span>
        <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">having</span> <span class="ow">is</span> <span class="bp">None</span>
            <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">where</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <p>Merge the <code>ORDER BY</code> clauses.  There are several possibilities:
- the inner <code>ORDER BY</code> is empty;
- the outer <code>ORDER BY</code> is empty;
- both the inner and the outer <code>ORDER BY</code> clauses are non-empty;
  in this case, they must be identical (but not necessarily equal
  by-value).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">head</span><span class="o">.</span><span class="n">order</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">order</span> <span class="ow">or</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">order</span><span class="p">))</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">order</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">order</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        <p>Merge the <code>LIMIT</code> and the <code>OFFSET</code> clauses.  Here either the
inner <code>LIMIT/OFFSET</code> or the outer <code>LIMIT/OFFSET</code> must be empty.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="p">((</span><span class="n">head</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">head</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">))</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">limit</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">offset</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        <p>Update the frame node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="o">=</span><span class="n">embed</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span>
                                 <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="o">=</span><span class="n">having</span><span class="p">,</span>
                                 <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        <p>Try to collapse the frame once again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        <p>Reduces a <code>JOIN</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceAnchor</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Anchor</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        <p>Collapse and reduce (in that order!) the subframe.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">frame</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        <p>Reduce the join condition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">condition</span><span class="p">)</span>
                     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        <p>Update the anchor.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <p>Reduces a top-level query frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceQuery</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">QueryFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        <p>If there is no segment frame, there is nothing to reduce.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        <p>Collapse and reduce (in that order!) the segment frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">segment</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        <p>Clear the state variables.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        <p>Update the query frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">segment</span><span class="o">=</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        <p>Reduces a SQL phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReducePhrase</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        <p>Note that we do not provide a default no-op implementation: every
non-leaf phrase node must at least apply <code>reduce()</code> to its subnodes
in order to fix broken references.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ReducePhrase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span> <span class="o">=</span> <span class="n">phrase</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        <p>Reduces a literal phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceLiteral</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">LiteralPhrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        <p>We cannot really simplify a literal value; instead, we encode
some common literals: <code>NULL</code>, <code>TRUE</code>, <code>FALSE</code> so that they
could be recognized with a single <code>isinstance()</code> check.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>Reduces a <code>CAST</code> operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceCast</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">CastPhrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        <p>Reduce the operand of the cast.  We do not specialize
on the domains here because we assume that any domain
specific conversion is already done by the encoder.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">base</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        <p>Reduces a formula node.</p>
<p>Reducing a formula is specific to the formula signature and is
implemented by the :class:<code>ReduceBySignature</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceFormula</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">FormulaPhrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        <p>Delegate the reduction to the <code>ReduceBySignature</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">reduce</span> <span class="o">=</span> <span class="n">ReduceBySignature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        <p>Reduces a formula node.</p>
<p>This is an auxiliary adapter used to reduce
:class:<code>htsql.tr.frame.FormulaPhrase</code> nodes.  The adapter is polymorphic
on the formula signature.</p>
<p>Unless overridden, the adapter reduces the arguments of the formula
and generates a new formula with the same signature.</p>
<p><code>phrase</code> (:class:<code>htsql.tr.frame.FormulaPhrase</code>)
<pre>The formula node to reduce.
</pre>
<code>state</code> (:class:<code>ReducingState</code>)
The current state of the reducing process.</p>
<p>Aliases:</p>
<p><code>signature</code> (:class:<code>htsql.tr.signature.Signature</code>)
The signature of the formula.</p>
<p><code>domain</code> (:class:<code>htsql.tr.domain.Domain</code>)
The co-domain of the formula.</p>
<p><code>arguments</code> (:class:<code>htsql.tr.signature.Bag</code>)
The arguments of the formula.</p>
<p><code>is_nullable</code> (Boolean)
Indicates that the formula may produce a <code>NULL</code> value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceBySignature</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Signature</span><span class="p">)</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        <p>Override the default dispatch since the adapter is polymorphic
not on the type of the formula, but on the type of the formula
signature.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">FormulaPhrase</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">phrase</span><span class="o">.</span><span class="n">signature</span><span class="p">),)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phrase</span><span class="p">,</span> <span class="n">FormulaPhrase</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ReducingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span> <span class="o">=</span> <span class="n">phrase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_nullable</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">is_nullable</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        <p>By default, just reduce the arguments of the formula.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">arguments</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        <p>Reduces an (in)equality operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceIsEqual</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">IsEqualSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>Start with reducing the operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        <p>Check if both operands are <code>NULL</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        <p>Reduce:
  null()=null(), null()!=null() =&gt; null()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                    <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>Now suppose one of the operands (<code>rop</code>) is <code>NULL</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="o">=</span> <span class="n">rop</span><span class="p">,</span> <span class="n">lop</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        <p>We could reduce:
  lop=null(), lop!=null() =&gt; null(),
but that completely removes <code>lop</code> from the clause tree, and thus
may change the semantics of SQL (for instance, when <code>lop</code> is an
aggregate expression).  So we only do that when <code>lop</code> is a
literal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        <p>Check if both arguments are boolean literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="p">(</span><span class="n">TruePhrase</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">))</span> <span class="ow">and</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="p">(</span><span class="n">TruePhrase</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">))):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        <p>Reduce:
  true()=true() =&gt; true()
  ...
Note: we do not apply the same optimization for literals of
arbitrary type because we cannot precisely replicate the
database equality operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span>
            <span class="k">if</span> <span class="n">lop</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">rop</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">polarity</span> <span class="o">=</span> <span class="o">-</span><span class="n">polarity</span>
            <span class="k">if</span> <span class="n">polarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        <p>None of specific optimizations were applied, just return
the same operator with reduced operands.  Update the <code>is_nullable</code>
status since it may change after reducing the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        <p>Reduces a total (in)equality operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceIsTotallyEqual</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">IsTotallyEqualSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        <p>The polarity of the operator: +1 for <code>==</code>, -1 for <code>!==</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        <p>Start with reducing the operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        <p>Check if both operands are <code>NULL</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        <p>Reduce:
  null()==null() =&gt; true, null()!==null() =&gt; false()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">polarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>Now suppose one of the operands (<code>rop</code>) is <code>NULL</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="n">lop</span><span class="p">,</span> <span class="n">rop</span> <span class="o">=</span> <span class="n">rop</span><span class="p">,</span> <span class="n">lop</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        <p>We could always reduce:
  lop==null() =&gt; is_null(lop)
  lop!==null() =&gt; !is_null(lop)
In addition, if we know that <code>lop</code> is not nullable, we could have
reduced:
  lop==null() =&gt; false()
  lop!==null() =&gt; true()
However that completely removes <code>lop</code> from the clause tree, which,
in some cases, may change the semantics of SQL (for instance, when
<code>lop</code> is an aggregate expression).  Therefore, we only apply this
optimization when <code>lop</code> is a literal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">polarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                            <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                            <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">(</span><span class="n">polarity</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                                 <span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">lop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        <p>Check if both arguments are boolean literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="p">(</span><span class="n">TruePhrase</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">))</span> <span class="ow">and</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="p">(</span><span class="n">TruePhrase</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">))):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p>Reduce:
  true()==true() =&gt; true()
  ...
Note: we do not apply the same optimization for literals of
arbitrary type because we cannot precisely replicate the
database equality operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">polarity</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">rop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        <p>When both operands are not nullable, we could replace a total
comparison operator with a regular one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">signature</span><span class="o">=</span><span class="n">IsEqualSig</span><span class="p">(</span><span class="n">polarity</span><span class="p">),</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        <p>FIXME: we also need to replace a total comparison operator
with a regular one for databases that do not have a native
total comparison operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        <p>None of specific optimizations were applied, just return
the same operator with reduced operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>Reduces the <code>IN</code> and <code>NOT IN</code> clauses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceIsIn</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">IsInSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-160'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-160">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-161'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-161">#</a>
        </div>
        <p>Reduce the left operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-162'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-162">#</a>
        </div>
        <p>Reduce the right operands, eliminating duplicates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">rops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">rops</span><span class="p">:</span>
            <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-163'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-163">#</a>
        </div>
        <p>Reduce:
  null()={...} =&gt; null()
We could do this substitution safely only when all operands
on the right are literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">rops</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-164'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-164">#</a>
        </div>
        <p>Similarly, reduce:
  x={null(),null(),...}</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">rops</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-165'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-165">#</a>
        </div>
        <p>Reduce:
  x={y} =&gt; x=y</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rop</span> <span class="o">=</span> <span class="p">[</span><span class="n">rops</span><span class="p">]</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">IsEqualSig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span><span class="p">)</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-166'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-166">#</a>
        </div>
        <p>None of specific optimizations were applied, just return
the same operator with reduced operands.  Update the <code>is_nullable</code>
status since it may change after reducing the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">rops</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rops</span><span class="o">=</span><span class="n">rops</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-167'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-167">#</a>
        </div>
        <p>Reduces the <code>IS NULL</code> and <code>IS NOT NULL</code> clauses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceIsNull</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-168'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-168">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">IsNullSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-169'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-169">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-170'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-170">#</a>
        </div>
        <p>Start with reducing the operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-171'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-171">#</a>
        </div>
        <p>Reduce:
  is_null(null()) =&gt; true()
  !is_null(null()) =&gt; false()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-172'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-172">#</a>
        </div>
        <p>If the operand is not nullable, we could reduce the operator
to a <code>TRUE</code> or a <code>FALSE</code> clause.  However it is only safe
to do for a literal operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-173'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-173">#</a>
        </div>
        <p>Return the same operator with a reduced operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-174'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-174">#</a>
        </div>
        <p>Reduces the <code>IFNULL</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceIfNull</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-175'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-175">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">IfNullSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-176'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-176">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-177'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-177">#</a>
        </div>
        <p>Reduce the operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-178'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-178">#</a>
        </div>
        <p>If the first operand is not nullable, then the operation is no-op,
and we could just return the first operand discarding the second
one.  However discarding a clause is not safe in general, so we
only do that when the second operand is a literal.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-179'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-179">#</a>
        </div>
        <p>Reduce:
  if_null(lop,null()) =&gt; lop</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-180'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-180">#</a>
        </div>
        <p>Reduce:
  if_null(null(),rop) =&gt; rop</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-181'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-181">#</a>
        </div>
        <p>Return the same operator with reduced operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">and</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-182'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-182">#</a>
        </div>
        <p>Reduces the <code>NULLIF</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceNullIf</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-183'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-183">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">NullIfSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-184'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-184">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-185'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-185">#</a>
        </div>
        <p>Reduce the operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-186'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-186">#</a>
        </div>
        <p>Reduce (when it is safe, i.e., when <code>rop</code> is a literal):
  null_if(null(),rop) =&gt; null()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-187'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-187">#</a>
        </div>
        <p>Reduce:
  null_if(lop,null()) =&gt; lop</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-188'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-188">#</a>
        </div>
        <p>When both operands are literals, we could determine the result
immediately.  We should be careful though since we cannot precisely
mimic the equality operator of the database.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-189'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-189">#</a>
        </div>
        <p>Assume that if the literals are equal in Python, they would
be equal for the database too.  The reverse is not valid in
general, but still valid for some literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">lop</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">rop</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-190'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-190">#</a>
        </div>
        <p>We could safely rely on comparison for Boolean values.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-191'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-191">#</a>
        </div>
        <p>In general, we can't rely on comparison for string values,
but we could assume that an empty string is only equal to itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">lop</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-192'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-192">#</a>
        </div>
        <p>Return the same operator with reduced operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-193'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-193">#</a>
        </div>
        <p>Reduces "AND" (<code>&amp;</code>) operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceAnd</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-194'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-194">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">AndSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-195'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-195">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-196'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-196">#</a>
        </div>
        <p>Start with reducing the operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-197'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-197">#</a>
        </div>
        <p>Reduce the operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-198'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-198">#</a>
        </div>
        <p>Weed out duplicates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">continue</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-199'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-199">#</a>
        </div>
        <p>Weed out <code>TRUE</code> literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">):</span>
                <span class="k">continue</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-200'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-200">#</a>
        </div>
        <p>Expand a nested <code>AND</code> operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">AndSig</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-201'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-201">#</a>
        </div>
        <p>The operands of the nested <code>AND</code> are already reduced,
but we still need to weed out duplicates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">for</span> <span class="n">nop</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nop</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nop</span><span class="p">)</span>
                    <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nop</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-202'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-202">#</a>
        </div>
        <p>Reduce:
  "&amp;"() =&gt; true()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ops</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span><span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-203'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-203">#</a>
        </div>
        <p>Reduce:
  "&amp;"(op) =&gt; op</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-204'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-204">#</a>
        </div>
        <p>We could reduce:
  "&amp;"(...,false(),...) =&gt; false()
but that means we discard the rest of the operands
from the clause tree, which is unsafe.  So we only
do that when all operands are literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-205'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-205">#</a>
        </div>
        <p>Reduce:
  x!=a&amp;x!=b&amp;... =&gt; x!={a,b,...}</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">all</span><span class="p">((</span><span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">))</span>
               <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">lop</span> <span class="o">==</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lop</span> <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
               <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
            <span class="n">lop</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lop</span>
            <span class="n">rops</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">rop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                        <span class="n">rops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                        <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">rops</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                            <span class="n">rops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span>
                                                      <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">rops</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">IsInSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rops</span><span class="o">=</span><span class="n">rops</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">[</span><span class="n">rop</span><span class="p">]</span> <span class="o">=</span> <span class="n">rops</span>
                <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">IsEqualSig</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-206'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-206">#</a>
        </div>
        <p>Return the same operator with reduced operands.  Update
the <code>is_nullable</code> status since it could change after reducing
the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="n">ops</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-207'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-207">#</a>
        </div>
        <p>Reduces "OR" (<code>|</code>) operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceOr</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-208'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-208">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">OrSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-209'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-209">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-210'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-210">#</a>
        </div>
        <p>Start with reducing the operands.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-211'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-211">#</a>
        </div>
        <p>Reduce the operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-212'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-212">#</a>
        </div>
        <p>Weed out duplicates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">continue</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-213'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-213">#</a>
        </div>
        <p>Weed out <code>FALSE</code> literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">):</span>
                <span class="k">continue</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-214'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-214">#</a>
        </div>
        <p>Expand a nested <code>OR</code> operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">OrSig</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-215'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-215">#</a>
        </div>
        <p>The operands of the nested <code>OR</code> are already reduced,
but we still need to weed out duplicates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">for</span> <span class="n">nop</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nop</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nop</span><span class="p">)</span>
                    <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nop</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-216'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-216">#</a>
        </div>
        <p>Reduce:
  "|"() =&gt; false()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ops</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span><span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-217'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-217">#</a>
        </div>
        <p>Reduce:
  "|"(op) =&gt; op</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-218'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-218">#</a>
        </div>
        <p>We could reduce:
  "|"(...,true(),...) =&gt; true()
but that means we discard the rest of the operands
from the clause tree, which is unsafe.  So we only
do that when all operands are literals.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                        <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-219'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-219">#</a>
        </div>
        <p>Reduce:
  x=a|x=b|... =&gt; x={a,b,...}</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">all</span><span class="p">((</span><span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">))</span>
               <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">lop</span> <span class="o">==</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lop</span> <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span>
               <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
            <span class="n">lop</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lop</span>
            <span class="n">rops</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">rop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                        <span class="n">rops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                        <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">rops</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                            <span class="n">rops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
                            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">rop</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span>
                                                      <span class="k">for</span> <span class="n">rop</span> <span class="ow">in</span> <span class="n">rops</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">IsInSig</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rops</span><span class="o">=</span><span class="n">rops</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">[</span><span class="n">rop</span><span class="p">]</span> <span class="o">=</span> <span class="n">rops</span>
                <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">IsEqualSig</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-220'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-220">#</a>
        </div>
        <p>Return the same operator with reduced operands.  Update
the <code>is_nullable</code> status since it could change after reducing
the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="n">ops</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-221'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-221">#</a>
        </div>
        <p>Reduces a "NOT" (<code>!</code>) operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceNot</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-222'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-222">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">NotSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-223'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-223">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-224'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-224">#</a>
        </div>
        <p>Start with reducing the operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-225'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-225">#</a>
        </div>
        <p>Reduce:
  !null() =&gt; null()
  !true() =&gt; false()
  !false() =&gt; true()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span>
                    <span class="n">NullPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span><span class="n">FalsePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">FalsePhrase</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span><span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-226'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-226">#</a>
        </div>
        <p>Reverse polarity of equality operators:
  !(lop=rop) =&gt; lop!=rop
  ...</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">isformula</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="p">(</span><span class="n">IsEqualSig</span><span class="p">,</span> <span class="n">IsTotallyEqualSig</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">,</span> <span class="n">IsNullSig</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">signature</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">reverse</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-227'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-227">#</a>
        </div>
        <p>Return the same operator with a reduced operand.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-228'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-228">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceFromPredicate</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">FromPredicateSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-229'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-229">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-230'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-230">#</a>
        </div>
        <p>op = self.state.reduce(self.phrase.op)
if isformula(op, ToPredicateSig):
   return op.op
return self.phrase.clone(is_nullable=op.is_nullable, op=op)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-231'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-231">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceToPredicate</span><span class="p">(</span><span class="n">ReduceBySignature</span><span class="p">):</span>

    <span class="n">adapts</span><span class="p">(</span><span class="n">ToPredicateSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-232'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-232">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-233'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-233">#</a>
        </div>
        <p>op = self.state.reduce(self.phrase.op)
if isformula(op, FromPredicateSig):
   return op.op
return self.phrase.clone(is_nullable=op.is_nullable, op=op)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">op</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-234'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-234">#</a>
        </div>
        <p>Reduces an export phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceExport</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-235'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-235">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">ExportPhrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-236'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-236">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-237'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-237">#</a>
        </div>
        <p>The default implementation (used for columns and embeddings)
is no-op.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-238'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-238">#</a>
        </div>
        <p>Reduce a reference phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">ReduceReference</span><span class="p">(</span><span class="n">Reduce</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-239'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-239">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">ReferencePhrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-240'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-240">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-241'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-241">#</a>
        </div>
        <p>Reduce an export reference: if the reference points to
a collapsed frame, replace the reference with the referenced
phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">substitutes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span>
        <span class="n">select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">substitutes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="n">select</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">index</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-242'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-242">#</a>
        </div>
        <p>Return a (reduced) referenced phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-243'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-243">#</a>
        </div>
        <p>Reduces (simplifies) a SQL clause.</p>
<p>Returns an equivalent (possibly the same) clause.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
<pre>The clause to simplify.
</pre>
<code>state</code> (:class:<code>ReducingState</code> or <code>None</code>)
The reducing state to use.  If not set, a new reducing state
is instantiated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-244'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-244">#</a>
        </div>
        <p>Instantiate a new reducing state if necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">ReducingState</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-245'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-245">#</a>
        </div>
        <p>Realize and apply the <code>Reduce</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="nb">reduce</span> <span class="o">=</span> <span class="n">Reduce</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">reduce</span><span class="p">()</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
