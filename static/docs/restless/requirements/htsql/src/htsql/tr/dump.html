<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>dump.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>dump.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql.tr.dump</code></h1>
<p>This module implements the SQL serialization process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">listof</span><span class="p">,</span> <span class="n">maybe</span>
<span class="kn">from</span> <span class="nn">..adapter</span> <span class="kn">import</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">adapts</span><span class="p">,</span> <span class="n">named</span>
<span class="kn">from</span> <span class="nn">.error</span> <span class="kn">import</span> <span class="n">SerializeError</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Domain</span><span class="p">,</span> <span class="n">BooleanDomain</span><span class="p">,</span> <span class="n">IntegerDomain</span><span class="p">,</span> <span class="n">DecimalDomain</span><span class="p">,</span>
                      <span class="n">FloatDomain</span><span class="p">,</span> <span class="n">StringDomain</span><span class="p">,</span> <span class="n">EnumDomain</span><span class="p">,</span> <span class="n">DateDomain</span><span class="p">,</span>
                      <span class="n">TimeDomain</span><span class="p">,</span> <span class="n">DateTimeDomain</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.syntax</span> <span class="kn">import</span> <span class="n">IdentifierSyntax</span><span class="p">,</span> <span class="n">ApplicationSyntax</span><span class="p">,</span> <span class="n">LiteralSyntax</span>
<span class="kn">from</span> <span class="nn">.frame</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Clause</span><span class="p">,</span> <span class="n">Frame</span><span class="p">,</span> <span class="n">TableFrame</span><span class="p">,</span> <span class="n">BranchFrame</span><span class="p">,</span> <span class="n">NestedFrame</span><span class="p">,</span>
                    <span class="n">SegmentFrame</span><span class="p">,</span> <span class="n">QueryFrame</span><span class="p">,</span>
                    <span class="n">Phrase</span><span class="p">,</span> <span class="n">NullPhrase</span><span class="p">,</span> <span class="n">CastPhrase</span><span class="p">,</span> <span class="n">LiteralPhrase</span><span class="p">,</span>
                    <span class="n">ColumnPhrase</span><span class="p">,</span> <span class="n">ReferencePhrase</span><span class="p">,</span> <span class="n">EmbeddingPhrase</span><span class="p">,</span>
                    <span class="n">FormulaPhrase</span><span class="p">,</span> <span class="n">Anchor</span><span class="p">,</span> <span class="n">LeadingAnchor</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.signature</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Signature</span><span class="p">,</span> <span class="n">isformula</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">,</span> <span class="n">IsTotallyEqualSig</span><span class="p">,</span>
                        <span class="n">IsInSig</span><span class="p">,</span> <span class="n">IsNullSig</span><span class="p">,</span> <span class="n">IfNullSig</span><span class="p">,</span> <span class="n">NullIfSig</span><span class="p">,</span> <span class="n">CompareSig</span><span class="p">,</span>
                        <span class="n">AndSig</span><span class="p">,</span> <span class="n">OrSig</span><span class="p">,</span> <span class="n">NotSig</span><span class="p">,</span> <span class="n">ToPredicateSig</span><span class="p">,</span>
                        <span class="n">FromPredicateSig</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.plan</span> <span class="kn">import</span> <span class="n">Plan</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">re</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Implements a writable file-like object.</p>
<p>Use :meth:<code>write</code> to write a string to the stream.  The data is
accumulated in an internal buffer of the stream.</p>
<p>Use :meth:<code>flush</code> to get the accumulated content and truncate
the stream.</p>
<p>:class:<code>Stream</code> also provides means for automatic indentation.
Use :meth:<code>indent</code> to set a new indentation level, :meth:<code>dedent</code>
to revert to the previous indentation level, :meth:<code>newline</code>
to set the position to the current indentation level.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Stream</span><span class="p">(</span><span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Note: we inherit from <code>object</code> to be able to use <code>super()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>Initialize the <code>StringIO</code> object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">Stream</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>The current cursor position.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>The current indentation level.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">=</span> <span class="mi">0</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>The stack of previous indentation levels.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">indentation_stack</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Writes a string to the stream.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>Call <code>StringIO.write</code>, which performs the action.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">Stream</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>Update the cursor position.  Note that we count
Unicode codepoints rather than bytes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">u&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">u&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p>Sets the cursor to the current indentation level.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p>Sets the indentation level to the current cursor position.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">indentation_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indentation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p>Reverts to the previous indentation level.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dedent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p>Returns the accumulated content and truncates the stream.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p>FIXME: we override the builtin <code>StringIO.flush()</code>
(which is no-op though)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p>Make sure the indentation level is at zero position.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentation_stack</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p>The accumulated content of the stream.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <p>Blank the stream and return the content.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">output</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p>Encapsulates serializing hints and instructions.</p>
<p><code>with_aliases</code> (Boolean)
<pre>If set, indicates that the generated <code>SELECT</code> clause
must contain aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Hook</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_aliases</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">with_aliases</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_aliases</span> <span class="o">=</span> <span class="n">with_aliases</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p></pre>Encapsulates the state of the serializing process.</p>
<p>State attributes:</p>
<p><code>stream</code> (:class:<code>Stream</code>)
<pre>A file-like object accumulating the generated SQL statement.
</pre>
<code>frame_by_tag</code> (a mapping: integer -&gt; :class:<code>htsql.tr.frame.Frame</code>)
Maps the frame tag to the respective frame.</p>
<p><code>select_aliases_by_tag</code> (a mapping: integer -&gt; a list of aliases)
Maps the frame tag to the list of aliases for the frame
<code>SELECT</code> clause.</p>
<p><code>frame_alias_by_tag</code> (a mapping: integer -&gt; an alias)
Maps the frame tag to the alias of the frame.</p>
<p><code>hook</code> (:class:<code>Hook</code>)
Encapsulates serializing hints and directives.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">SerializingState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <p>The stream that accumulates the generated SQL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>A mapping: tag -&gt; frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">frame_by_tag</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        <p>A mapping: tag -&gt; a list of <code>SELECT</code> aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">select_aliases_by_tag</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p>A mapping: tag -&gt; the frame alias.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">frame_alias_by_tag</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p>The stack of previous values of serializing directives.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">hook_stack</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p>The active serializing hints and directives.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Initializes the serializing state.</p>
<p>This method must be called before dumping any clauses.</p>
<p><code>frame</code> (:class:<code>htsql.tr.frame.SegmentFrame</code>)
<pre>The term corresponding to the top-level <code>SELECT</code> statement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">SegmentFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <p>Initialize serializing directives.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">Hook</span><span class="p">(</span><span class="n">with_aliases</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p>Populate <code>frame_by_tag</code> mapping: use BFS over the frame tree.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame_by_tag</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">kids</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p></pre>Updates serializing directives.</p>
<p><code>with_aliases</code> (Boolean)
<pre>If set, indicates that the <code>SELECT</code> clause must have aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">push_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_aliases</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">with_aliases</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">Hook</span><span class="p">(</span><span class="n">with_aliases</span><span class="o">=</span><span class="n">with_aliases</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p></pre>Restores the previous serializing directives.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pop_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p>Clears the serializing state and returns the generated SQL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        <p>Revert all attributes to their pristine state.  We assume
that the <code>hook_stack</code> must be already empty.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">frame_by_tag</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_aliases_by_tag</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_alias_by_tag</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Truncate the stream and return the accumulated data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p>Serializes the given clause.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
<pre>The clause to serialize.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>Realize and call the <code>Serialize</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">serialize</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        <p></pre>Writes SQL for the given clause.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
<pre>The clause to dump.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>Realize and call the <code>Dump</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">dump</span> <span class="o">=</span> <span class="n">Dump</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>Note: returns <code>None</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">dump</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p></pre>Generates a preform alias for the given clause.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
<pre>The clause to generate an alias for.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p>Realize and call the <code>Dub</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">dub</span> <span class="o">=</span> <span class="n">Dub</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dub</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p></pre>Translates a clause to SQL.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>The :class:<code>Serialize</code> has the following signature::</p>
<pre>Serialize: (Clause, SerializingState) -> SQL
</pre>

<p>The adapter is polymorphic on the <code>Clause</code> argument.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
The clause to serialize.</p>
<p><code>state</code> (:class:<code>SerializingState</code>)
The current state of the serializing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Serialize</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="n">Clause</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SerializingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clause</span> <span class="o">=</span> <span class="n">clause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Must be implemented in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the serialize adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        <p>Serializes an HTSQL query to an execution plan.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">SerializeQuery</span><span class="p">(</span><span class="n">Serialize</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">QueryFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>When exists, serialize the query segment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">sql</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        <p>Produce an execution plan.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">Plan</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        <p>Serializes an HTSQL segment to SQL.</p>
<p>Class attributes:</p>
<p><code>max_alias_length</code> (an integer)
<pre>The maximum length of an alias.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">SerializeSegment</span><span class="p">(</span><span class="n">Serialize</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">SegmentFrame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        <p>The maximum length of an alias.  We could choose an arbitrary
value and let the backends override it.  Here we have chosen
the PostgreSQL limit <code>NAMEDATALEN-1</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">max_alias_length</span> <span class="o">=</span> <span class="mi">63</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        <p>Populate the <code>frame_by_tag</code> mapping.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        <p>Generate <code>SELECT</code> and <code>FROM</code> aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasing</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Dump the <code>SELECT</code> statement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clause</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        <p>Retrieve and return the generated SQL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sql</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        <p></pre>Generates <code>SELECT</code> and <code>FROM</code> aliases.</p>
<p><code>frame</code> (:class:<code>htsql.tr.frame.BranchFrame</code> or <code>None</code>)
<pre>The frame to generate aliases for.
</pre>
<code>taken_select_aliases</code> (a set or <code>None</code>)
The <code>SELECT</code> aliases to avoid.  Note that :meth:<code>aliasing</code>
may update the collection.</p>
<p><code>taken_include_aliases</code> (a set of <code>None</code>)
The <code>FROM</code> aliases to avoid.  Note that :meth:<code>aliasing</code>
may update the collection.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">aliasing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">taken_select_aliases</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">taken_include_aliases</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        <p>Initialize default values for the arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clause</span>
        <span class="k">if</span> <span class="n">taken_select_aliases</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">taken_select_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">taken_include_aliases</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">taken_include_aliases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        <p>Get preform aliases for the <code>SELECT</code> phrases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">dub</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">select</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        <p>Complete and assign the <code>SELECT</code> aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_to_aliases</span><span class="p">(</span><span class="n">select_names</span><span class="p">,</span>
                                               <span class="n">taken_select_aliases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">select_aliases_by_tag</span><span class="p">[</span><span class="n">frame</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_aliases</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        <p>Get preform aliases for the <code>FROM</code> subframes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">include_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">dub</span><span class="p">(</span><span class="n">anchor</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        <p>Complete and assign the <code>FROM</code> aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">include_aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_to_aliases</span><span class="p">(</span><span class="n">include_names</span><span class="p">,</span>
                                                <span class="n">taken_include_aliases</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">include_aliases</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">frame_alias_by_tag</span><span class="p">[</span><span class="n">anchor</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        <p>Generate aliases for each sub-<code>SELECT</code> in the <code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">include</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">anchor</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">is_branch</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aliasing</span><span class="p">(</span><span class="n">anchor</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        <p>Generate aliases for the embedded subframes.  Since embedded
subframes may refer to its parent frame's subframes, we need
to pass the aliases reserved by the parent frame.
FIXME: only need to pass <code>FROM</code> aliases since <code>SELECT</code> aliases
are not referrable from an embedded subframe?  It's a moot
point since embedded subframes do not use <code>SELECT</code> aliases anyway.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">subframe</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">embed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aliasing</span><span class="p">(</span><span class="n">subframe</span><span class="p">,</span>
                          <span class="n">taken_select_aliases</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                          <span class="n">taken_include_aliases</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">names_to_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">taken_aliases</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        <p>Converts a list of preform aliases to actual aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        <p>We got a list of proposed aliases, now we need to amend it
to make sure that:
- all aliases are unique among themselves and do not clash
  with any reserved aliases;
- the length of an alias does not exceed <code>max_alias_length</code>.
We generate aliases of the form <code>preform_N</code>, where <code>N</code>
is a sequiental numeric index; however, when possible, we try
to avoid adding the <code>_N</code> suffix.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        <p>A mapping: preform alias -&gt; the next suffix to try.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">next_number_by_name</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        <p>Initialize the mapping with <code>1</code> for duplicate preforms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">next_number_by_name</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        <p>The generated aliases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">aliases</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        <p>For each preform, generate an alias.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        <p>The generated alias.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>Try it until the alias is generated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">while</span> <span class="n">alias</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>Generate an alias of the form <code>preform</code> or <code>preform_N</code>,
where <code>N</code> are consecutive numbers.  Note that we may need
to cut the preform to fit the allowed alias length limit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">number</span> <span class="o">=</span> <span class="n">next_number_by_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_alias_length</span><span class="p">]</span>
                    <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_alias_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="n">cut</span><span class="p">],</span> <span class="n">number</span><span class="p">)</span>
                    <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">next_number_by_name</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        <p>Check if the alias is already reserved.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">taken_aliases</span><span class="p">:</span>
                    <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        <p>A unique alias is generated; save and reserve it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">aliases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">taken_aliases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aliases</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        <p>Translates a clause node to SQL.</p>
<p>This is a base class for the family of <code>Dump</code> adapters; it encapsulates
methods and attributes shared between these adapters.</p>
<p>A <code>Dump</code> adapter generates a SQL expression for the given frame or
phrase clause node and writes it to the stream that accumulates a SQL
statement.</p>
<p><code>clause</code> (:class:<code>htsql.tr.frame.Clause</code>)
<pre>A clause to serialize.
</pre>
<code>state</code> (:class:<code>SerializingState</code>)
The current state of the serializing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">DumpBase</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <p>A pattern to match expressions of the forms:
  {name}
  {name:kind}
  {name:kind{modifier}}
  ...a chunk of text without {}...</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">template_pattern</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">        \{</span>
<span class="s">            (?P&lt;name&gt; \w+ )</span>
<span class="s">            (?:</span>
<span class="s">                :</span>
<span class="s">                (?P&lt;kind&gt; \w+ )</span>
<span class="s">                (?:</span>
<span class="s">                    \{</span>
<span class="s">                        (?P&lt;modifier&gt; [^{}]* )</span>
<span class="s">                    \}</span>
<span class="s">                )?</span>
<span class="s">            )?</span>
<span class="s">        \}</span>
<span class="s">        |</span>
<span class="s">        (?P&lt;chunk&gt; (?: [^{}] | \{\{ | \}\} )+ )</span>
<span class="s">#DIVIDER</span>
<span class="s">        Serializes a set of variables according to a template.</span>

<span class="s">        The :meth:`format` method expects a template string containing</span>
<span class="s">        variable fields denoted by ``{}``.  The method writes the string</span>
<span class="s">        to the SQL stream replacing variables with respective values.</span>

<span class="s">        The format of the variable fields is::</span>

<span class="s">            {name}</span>
<span class="s">            {name:kind}</span>
<span class="s">            {name:kind{modifier}}</span>

<span class="s">        Here,</span>

<span class="s">        * `name` is the name of the variable;</span>
<span class="s">        * `kind` indicates how the variable is converted to a string;</span>
<span class="s">        * `modifier` is an optional conversion parameter.</span>

<span class="s">        The :class:`Format` protocol defines various conversion methods.</span>

<span class="s">        `template` (a string)</span>
<span class="s">            A template string.</span>

<span class="s">        `namespaces`, `keywords` (dictionaries)</span>
<span class="s">            Dictionaries containing substitution variables.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Writes a string to the SQL stream.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Sets the indentation level to the current cursor position.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Reverts to the previous indentation level.</span>
<span class="s">#DIVIDER</span>
<span class="s">        Sets the cursor to the current indentation level.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a substitution variable.</span>

<span class="s">    This is an auxiliary protocol used by :meth:`DumpBase.format`.  It is</span>
<span class="s">    called to serialize a substitution variable of the form::</span>

<span class="s">        {variable:kind{modifier}}</span>

<span class="s">    `kind` (a string)</span>
<span class="s">        The name of the conversion operation.  The protocol is polymorphic</span>
<span class="s">        on this argument.</span>

<span class="s">    `value` (an object)</span>
<span class="s">        The value of the variable to be serialized.</span>

<span class="s">    `modifier` (an object or ``None``)</span>
<span class="s">        An optional conversion parameter.</span>

<span class="s">    `state` (:class:`SerializingState`)</span>
<span class="s">        The current state of the serializing process.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps a clause node.</span>

<span class="s">    This is the default conversion, used when the conversion kind is</span>
<span class="s">    not specified explicitly::</span>

<span class="s">        {clause}</span>

<span class="s">    Here, the value of `clause` is a :class:`htsql.tr.frame.Clause`</span>
<span class="s">    instance to serialize.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps a list of clause nodes.</span>

<span class="s">    Usage::</span>

<span class="s">        {clauses:union}</span>
<span class="s">        {clauses:union{ separator }}</span>

<span class="s">    Here,</span>

<span class="s">    * the value of the `clauses` variable is a list of</span>
<span class="s">      :class:`htsql.tr.frame.Clause` nodes;</span>
<span class="s">    * `separator` is a separator between clauses (``&#39;, &#39;``, by default).</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps a SQL identifier.</span>

<span class="s">    Usage::</span>

<span class="s">        {identifier:name}</span>

<span class="s">    The value of `identifier` is a string, which is serialized</span>
<span class="s">    as a quoted SQL identifier.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps a SQL literal.</span>

<span class="s">    Usage::</span>

<span class="s">        {value:literal}</span>

<span class="s">    The value of the `value` variable is serialized as a quoted SQL literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps a ``NOT`` clause.</span>

<span class="s">    Usage::</span>

<span class="s">        {polarity:not}</span>

<span class="s">    The action depends on the value of the `polarity` variable:</span>

<span class="s">    * writes nothing when `polarity` is equal to ``+1``;</span>
<span class="s">    * writes ``NOT`` followed by a space when `polarity` is equal to ``-1``.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps one of two given clauses.</span>

<span class="s">    Usage::</span>

<span class="s">        {polarity:switch{P|N}}</span>

<span class="s">    The action depends on the value of the `polarity` variable:</span>

<span class="s">    * writes the ``P`` clause when `polarity` is equal to ``+1``;</span>
<span class="s">    * writes the ``N`` clause when `polarity` is equal to ``-1``.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Dumps the given string.</span>

<span class="s">    Usage::</span>

<span class="s">        {string:pass}</span>

<span class="s">    The value of the `string` variable is written directly to the SQL stream.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Generates a preform alias name for a clause node.</span>

<span class="s">    This is an auxiliary adapter used to generate aliases for</span>
<span class="s">    ``SELECT`` and ``FROM`` clauses.</span>

<span class="s">    `clause` (:class:`htsql.tr.frame.Clause`)</span>
<span class="s">        A clause node to make an alias for.</span>

<span class="s">    `state` (:class:`SerializingState`)</span>
<span class="s">        The current state of the serializing process.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Translates a clause node to SQL.</span>

<span class="s">    This is an interface adapter; see subclasses for implementations.</span>

<span class="s">    The :class:`Dump` adapter has the following signature::</span>

<span class="s">        Dump: (Clause, SerializingState) -&gt; writes to SQL stream</span>

<span class="s">    The adapter is polymorphic on the `Clause` argument.</span>

<span class="s">    The adapter generates a SQL clause for the given node and</span>
<span class="s">    writes it to the stream that accumulates a SQL statement.</span>

<span class="s">    `clause` (:class:`htsql.tr.frame.Clause`)</span>
<span class="s">        A clause to serialize.</span>

<span class="s">    `state` (:class:`SerializingState`)</span>
<span class="s">        The current state of the serializing process.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Generates a preform alias for a frame node.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Translates a frame node to SQL.</span>

<span class="s">    `frame` (:class:`htsql.tr.frame.Frame`)</span>
<span class="s">        A frame node to serialize.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Generates a preform alias for a phrase node.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Translates a phrase node to SQL.</span>

<span class="s">    `phrase` (:class:`htsql.tr.frame.Phrase`)</span>
<span class="s">        A phrase node to serialize.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a table frame.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a ``SELECT`` frame.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a nested ``SELECT`` frame.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a top-level ``SELECT`` frame.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes the leading subframe in a ``FROM`` clause.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a successive subframe in a ``FROM`` clause.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Generates a preform alias for a column reference.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a reference to a table frame.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Generates a preform alias for a reference to a nested ``SELECT``.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a reference to a nested subframe.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Generates a preform alias for a correlated subquery.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes an embedded subquery.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a literal node.</span>

<span class="s">    Serialiation is delegated to the :class:`DumpByDomain` adapter.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a ``NULL`` value.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a literal node.</span>

<span class="s">    This is an auxiliary adapter used for serialization of literal nodes.</span>
<span class="s">    The adapter is polymorphic on the domain of the literal.</span>

<span class="s">    `phrase` (:class:`htsql.tr.frame.LiteralPhrase`)</span>
<span class="s">        A literal node to serialize.</span>

<span class="s">    `state` (:class:`SerializingState`)</span>
<span class="s">        The current state of the serializing process.</span>

<span class="s">    Other attributes:</span>

<span class="s">    `value` (depends on the domain or ``None``)</span>
<span class="s">        The value of the literal.</span>

<span class="s">    `domain` (:class:`htsql.domain.Domain`)</span>
<span class="s">        The domain of the literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a Boolean literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes an integer literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a float literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a decimal literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a string literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a value of an enumerated type.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a date literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a time literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a datetime literal.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a ``CAST`` clause.</span>

<span class="s">    Serialiation is delegated to the :class:`DumpByDomain` adapter.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a ``CAST`` clause.</span>

<span class="s">    This is an auxiliary adapter used for serialization of cast phrase nodes.</span>
<span class="s">    The adapter is polymorphic on the pair of the origin and the target</span>
<span class="s">    domains.</span>

<span class="s">    `phrase` (:class:`htsql.tr.frame.CastPhrase`)</span>
<span class="s">        A cast node to serialize.</span>

<span class="s">    `state` (:class:`SerializingState`)</span>
<span class="s">        The current state of the serializing process.</span>

<span class="s">    Other attributes:</span>

<span class="s">    `base` (:class:`htsql.tr.frame.Phrase`)</span>
<span class="s">        The operand of the ``CAST`` expression.</span>

<span class="s">    `domain` (:class:`htsql.domain.Domain`)</span>
<span class="s">        The target domain.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to an integer value.</span>

<span class="s">    Handles conversion from a string and other numeric data types.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to a floating-point number.</span>

<span class="s">    Handles conversion from a string and other numeric data types.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to a decimal number.</span>

<span class="s">    Handles conversion from a string and other numeric data types.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to a string.</span>

<span class="s">    Handles conversion from other data types to a string.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to a date value.</span>

<span class="s">    Handles conversion from a string and a datetime.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to a time value.</span>

<span class="s">    Handles conversion from a string and a datetime.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes conversion to a datetime value.</span>

<span class="s">    Handles conversion from a string.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a formula node.</span>

<span class="s">    Serialiation is delegated to the :class:`DumpBySignature` adapter.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a formula node.</span>

<span class="s">    This is an auxiliary adapter used for serialization of formula nodes.</span>
<span class="s">    The adapter is polymorphic on the formula signature.</span>

<span class="s">    `phrase` (:class:`htsql.tr.frame.FormulaPhrase`)</span>
<span class="s">        A formula node to serialize.</span>

<span class="s">    `state` (:class:`SerializingState`)</span>
<span class="s">        The current state of the serializing process.</span>

<span class="s">    Other attributes:</span>

<span class="s">    `signature` (:class:`htsql.tr.signature.Signature`)</span>
<span class="s">        The signature of the formula.</span>

<span class="s">    `domain` (:class:`htsql.tr.domain.Domain`)</span>
<span class="s">        The co-domain of the formula.</span>

<span class="s">    `arguments` (:class:`htsql.tr.signature.Bag`)</span>
<span class="s">        The arguments of the formula.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes an (in)equality (``=`` or ``!=``) operator</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a total (in)equality (``==`` or ``!==``) operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes an N-ary equality (``={}``) operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a logical &quot;AND&quot; (``&amp;``) operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a logical &quot;OR&quot; (``|``) operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a logical &quot;NOT&quot; (``!``) operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes an ``is_null()`` operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes an ``if_null()`` operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a ``null_if()`` operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Serializes a comparison operator.</span>
<span class="s">#DIVIDER</span>
<span class="s">    Translates a clause node to SQL.</span>

<span class="s">    `clause` (:class:`htsql.tr.frame.Clause`)</span>
<span class="s">        The clause to serialize.</span>

<span class="s">    `state` (:class:`SerializingState` or ``None``)</span>
<span class="s">        The serializing state to use.  If not set, a new serializing</span>
<span class="s">        state is instantiated.</span>
<span class="s">#DIVIDER</span>

</pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        <p>template_regexp = re.compile(template_pattern, re.X)</p>
<p>def <strong>init</strong>(self, clause, state):
<pre>assert isinstance(clause, Clause)
assert isinstance(state, SerializingState)
self.clause = clause
self.state = state
self.stream = state.stream
</pre>
def <strong>call</strong>(self):</p>
<h1>By default, generate an error.</h1>
<p>raise SerializeError("unable to serialize an expression",
<pre>self.clause.mark)
</pre>
def format(self, template, <em>namespaces, </em>*keywords):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        <p>assert isinstance(template, str)</p>
<h1>Aggregate variables from the given namespaces.  A namespace is</h1>
<h1>either a dictionary or an object with variables as attributes.</h1>
<p>variables = {}
for namespace in namespaces:
<pre>if isinstance(namespace, dict):
variables.update(namespace)
else:
assert hasattr(namespace, '<strong>dict</strong>')
variables.update(namespace.<strong>dict</strong>)
variables.update(keywords)</p>
<h1>Parse the template string till the end.</h1>
<p>start = 0
while start &lt; len(template):</p>
<h1>Extract the next part from the template string.  It is</h1>
<h1>either a chunk of regular text or a variable field.</h1>
<p>match = self.template_regexp.match(template, start)
assert match is not None, (template, start)
start = match.end()</p>
<h1>Is it a regular text?  Write it to the stream then.</h1>
<h1>Note that we have escaping rules:</h1>
<h1>{{ -&gt; {</h1>
<h1>}} -&gt; }</h1>
<p>chunk = match.group('chunk')
if chunk is not None:
chunk = chunk.replace("", "}")
self.stream.write(chunk)</p>
<h1>It must be variable substitution then.  Extract the value</h1>
<h1>of the variable and realize a <code>Format</code> instance to perform</h1>
<h1>the substitution.</h1>
<p>else:
name = match.group('name')
kind = match.group('kind')
if kind is None:
kind = 'default'
modifier = match.group('modifier')
assert name in variables, name
value = variables[name]
format = Format(kind, value, modifier, self.state)
format()
</pre>
def write(self, data):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        <p>self.stream.write(data)</p>
<p>def indent(self):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        <p>self.stream.indent()</p>
<p>def dedent(self):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        <p>self.stream.dedent()</p>
<p>def newline(self):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        <p>self.stream.newline()</p>
<p>class Format(Protocol):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        <p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert isinstance(kind, str)
assert isinstance(state, SerializingState)
self.kind = kind
self.value = value
self.modifier = modifier
self.state = state
self.stream = state.stream
</pre>
def <strong>call</strong>(self):</p>
<h1>Must be overridden in subclasses.</h1>
<p>raise NotImplementedError("the format %r is not implemented"
<pre>% self.kind)
</pre></p>
<p>class FormatDefault(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        <p>named('default')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert isinstance(value, Clause)
assert modifier is None
super(FormatDefault, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):</p>
<h1>Delegate serialization to the <code>Dump</code> adapter.</h1>
<p>self.state.dump(self.value)</p>
<p>class FormatUnion(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        <p>named('union')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert isinstance(value, listof(Clause)) and len(value) &gt; 0
assert isinstance(modifier, maybe(str))</p>
<h1>The default separator is <code>', '</code>.</h1>
<p>if modifier is None:
modifier = ", "
super(FormatUnion, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):</p>
<h1>Dump:</h1>
<h1><clause><separator><clause><separator>...</h1>
<p>for index, phrase in enumerate(self.value):
if index &gt; 0:
<pre>self.stream.write(self.modifier)
self.state.dump(phrase)
</pre></p>
<p>class FormatName(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <p>named('name')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert isinstance(value, str)
assert modifier is None</p>
<h1>This is the last place where we could prevent an injection attack,</h1>
<h1>so check that the string is well-formed.</h1>
<p>assert "0" not in value
assert len(value) &gt; 0
value.decode('utf-8')
super(FormatName, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):</p>
<h1>Assume standard SQL quoting rules for identifiers:</h1>
<h1>- an identifier is enclosed by <code>"</code>;</h1>
<h1>- any <code>"</code> character must be replaced with <code>""</code>.</h1>
<h1>A backend with non-standard quoting rules must override this method.</h1>
<p>self.stream.write(""%s"" % self.value.replace(""", """"))</p>
<p>class FormatLiteral(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        <p>named('literal')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert isinstance(value, str)
assert modifier is None</p>
<h1>This is the last place where we could prevent an injection attack,</h1>
<h1>so check that the string is well-formed.</h1>
<p>assert "0" not in value
value.decode('utf-8')
super(FormatLiteral, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):</p>
<h1>Assume standard SQL quoting rules for literals:</h1>
<h1>- a value is enclosed by <code>'</code>;</h1>
<h1>- any <code>'</code> character must be replaced with <code>''</code>.</h1>
<h1>A backend with non-standard quoting rules must override this method.</h1>
<p>self.stream.write("'%s'" % self.value.replace("'", "''"))</p>
<p>class FormatNot(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        <p>named('not')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert value in [+1, -1]
assert modifier is None
super(FormatNot, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):</p>
<h1>For <code>{polarity:not}</code>, dump:</h1>
<h1>polarity=+1 =&gt; ""</h1>
<h1>polarity=-1 =&gt; "NOT "</h1>
<p>if self.value &lt; 0:
<pre>self.stream.write("NOT ")
</pre></p>
<p>class FormatSwitch(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        <p>named('switch')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert value in [+1, -1]
assert isinstance(modifier, str) and modifier.count("|")
super(FormatSwitch, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):</p>
<h1>For <code>{polarity:switch{P|N}}</code>, dump</h1>
<h1>polarity=+1 =&gt; P</h1>
<h1>polarity=-1 =&gt; N</h1>
<p>positive, negative = self.modifier.split("|")
if self.value &gt; 0:
<pre>self.stream.write(positive)
else:
self.stream.write(negative)
</pre></p>
<p>class FormatPass(Format):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        <p>named('pass')</p>
<p>def <strong>init</strong>(self, kind, value, modifier, state):
<pre>assert isinstance(value, str)
assert modifier is None
super(FormatPass, self).<strong>init</strong>(kind, value, modifier, state)
</pre>
def <strong>call</strong>(self):
self.stream.write(self.value)</p>
<p>class Dub(Adapter):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        <p>adapts(Clause)</p>
<p>def <strong>init</strong>(self, clause, state):
<pre>self.clause = clause
self.state = state
</pre>
def <strong>call</strong>(self):</p>
<h1>The adapter must never fail, so the default implementation</h1>
<h1>provides a valid, though meaningless, alias name.</h1>
<p>return "!"</p>
<p>class Dump(DumpBase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        <p>adapts(Clause)</p>
<p>class DubFrame(Dub):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        <p>adapts(Frame)</p>
<p>def <strong>call</strong>(self):
<pre># For a frame, a good alias is the name of the table</p>
<h1>represented by the frame.</h1>
<p>flow = self.clause.flow
while flow.family.is_quotient:
flow = flow.family.seed
if flow.family.is_table:
return flow.family.table.name</p>
<h1>Use the default alias when the frame does not represent</h1>
<h1>any table.</h1>
<p>return super(DubFrame, self).<strong>call</strong>()
</pre></p>
<p>class DumpFrame(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        <p>adapts(Frame)</p>
<p>def <strong>init</strong>(self, frame, state):
<pre>super(DumpFrame, self).<strong>init</strong>(frame, state)
self.frame = frame
</pre></p>
<p>class DubPhrase(Dub):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        <p>adapts(Phrase)</p>
<p>def <strong>call</strong>(self):
<pre># Generate a useful alias for a phrase node.  We base the alias</p>
<h1>on the underlying syntax node.</h1>
<p>syntax = self.clause.syntax</p>
<h1>For an identifier node, take the identifier name.</h1>
<p>if isinstance(syntax, IdentifierSyntax):
return syntax.value</p>
<h1>For a function call node, take the function name.</h1>
<p>if isinstance(syntax, ApplicationSyntax):
return syntax.name</p>
<h1>For a literal node, take the value of the literal.</h1>
<p>if isinstance(syntax, LiteralSyntax):
return syntax.value</p>
<h1>Otherwise, use the default alias.</h1>
<p>return super(DubPhrase, self).<strong>call</strong>()
</pre></p>
<p>class DumpPhrase(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        <p>adapts(Phrase)</p>
<p>def <strong>init</strong>(self, phrase, state):
<pre>super(DumpPhrase, self).<strong>init</strong>(phrase, state)
self.phrase = phrase
</pre></p>
<p>class DumpTable(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        <p>adapts(TableFrame)</p>
<p>def <strong>call</strong>(self):
<pre># Serialize a table reference in a <code>FROM</code> clause.  Dump:</p>
<h1><schema>.<table></h1>
<h1>Must be overridden for backends which lack schemas.</h1>
<p>table = self.frame.flow.family.table
self.format("{schema:name}.{table:name}",
schema=table.schema_name,
table=table.name)
</pre></p>
<p>class DumpBranch(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        <p>adapts(BranchFrame)</p>
<p>def <strong>call</strong>(self):
<pre># Sequentially serialize the clauses of the <code>SELECT</code> frame.
self.dump_select()
self.dump_include()
self.dump_where()
self.dump_group()
self.dump_having()
self.dump_order()
self.dump_limit()
</pre>
def dump_select(self):</p>
<h1>Serialize a <code>SELECT</code> clause.  Dump:</h1>
<h1>SELECT <phrase> AS <alias>,</h1>
<p><pre>#          <phrase> AS <alias>,</p>
<h1>...</h1>
</pre>

<h1>The <code>SELECT</code> aliases for the current frame.</h1>
<p>aliases = self.state.select_aliases_by_tag[self.frame.tag]</p>
<h1>Write <code>SELECT</code> and set the indentation level to the position</h1>
<h1>after <code>SELECT</code>.</h1>
<p>self.write("SELECT ")
self.indent()</p>
<h1>Serialize the selection phrases.</h1>
<p>for index, phrase in enumerate(self.frame.select):</p>
<h1>Check if we need to provide an alias, and if so, fetch it.</h1>
<p>alias = None
if self.state.hook.with_aliases:
alias = aliases[index]</p>
<h1>Now even if we are required to provide an alias, we may</h1>
<h1>still be able to omit it if it coincides with an implicit</h1>
<h1>alias generated by the SQL engine.  It may happen in two</h1>
<h1>cases.</h1>
<h1>(1) The selection refers to a column, and the alias</h1>
<p><pre>#     coincides with the column name.
if isinstance(phrase, ColumnPhrase):
if alias == phrase.column.name:
alias = None</p>
<h1>(2) The selection exports a value from a nested <code>SELECT</code>,</h1>
<h1>and the alias coincides with the alias of the nested</h1>
<h1>selection.</h1>
<p>if isinstance(phrase, ReferencePhrase):
target_alias = (self.state.select_aliases_by_tag
[phrase.tag][phrase.index])
if alias == target_alias:
alias = None</p>
<h1>Write the selection and, if needed, its alias.</h1>
<p>if alias is not None:
self.format("{selection} AS {alias:name}",
selection=phrase, alias=alias)
else:
self.format("{selection}",
selection=phrase)</p>
<h1>Write the trailing comma.</h1>
<p>if index &lt; len(self.frame.select)-1:
self.write(",")
self.newline()</p>
<h1>Restore the original indentation level.</h1>
<p>self.dedent()
</pre>
def dump_include(self):</p>
<h1>Serialize a <code>FROM</code> clause.  Dump:</h1>
<h1>FROM <leading_anchor></h1>
<h1><anchor></h1>
<h1>...</h1>
<h1>Nothing two write if there are no nested subframes.</h1>
<p>if not self.frame.include:
return</p>
<h1>Write <code>FROM</code> and set the indentation level to the next position.</h1>
<p>self.newline()
self.write("FROM ")
self.indent()</p>
<h1>Serialize the subframes.</h1>
<p>for index, anchor in enumerate(self.frame.include):
self.format("{anchor}", anchor=anchor)</p>
<h1>Restore the original indentation level.</h1>
<p>self.dedent()</p>
<p>def dump_where(self):</p>
<h1>Serialize a <code>WHERE</code> clause.  Dump:</h1>
<h1>WHERE <phrase></h1>
<h1>or, if the top-level phrase is an <code>AND</code> operator,</h1>
<h1>WHERE <op></h1>
<h1>AND <op></h1>
<h1>...</h1>
<h1>Nothing to write if there is no <code>WHERE</code> condition.</h1>
<p>if self.frame.where is None:
return
self.newline()</p>
<h1>Handle the case when the condition is an <code>AND</code> operator.</h1>
<p>if isformula(self.frame.where, AndSig):
self.write("WHERE ")
self.indent()
for index, op in enumerate(self.frame.where.ops):
self.format("{op}", op=op)
if index &lt; len(self.frame.where.ops)-1:
self.newline()
self.write("AND ")
self.dedent()</p>
<h1>Handle the regular case.</h1>
<p>else:
self.format("WHERE {condition}",
condition=self.frame.where)</p>
<p>def dump_group(self):</p>
<h1>Serialize a <code>GROUP BY</code> clause.  Dump:</h1>
<h1>GROUP BY <phrase>, ...</h1>
<h1>Nothing to write if there is no <code>GROUP BY</code> items.</h1>
<p>if not self.frame.group:
return
self.newline()
self.write("GROUP BY ")</p>
<h1>Write the <code>GROUP BY</code> items.</h1>
<p>for index, phrase in enumerate(self.frame.group):</p>
<h1>SQL syntax allows us to refer to a <code>SELECT</code> column in</h1>
<h1>a <code>GROUP BY</code> clause by position.  Thus, when a <code>GROUP BY</code></h1>
<h1>element coincides with some <code>SELECT</code> phrase, we could avoid</h1>
<h1>serializing the same phrase twice.</h1>
<p>if phrase in self.frame.select:
position = self.frame.select.index(phrase)+1
self.write(str(position))</p>
<h1>Otherwise, just serialize the phrase.</h1>
<p>else:
self.format("{kernel}", kernel=phrase)</p>
<h1>Dump the trailing comma.</h1>
<p>if index &lt; len(self.frame.group)-1:
self.write(", ")</p>
<p>def dump_having(self):</p>
<h1>Serialize a <code>HAVING</code> clause.  Dump:</h1>
<h1>HAVING <phrase></h1>
<h1>or, if the top-level phrase is an <code>AND</code> operator,</h1>
<h1>HAVING <op></h1>
<h1>AND <op></h1>
<h1>...</h1>
<h1>Note: currently unused as the assembler never generates a <code>HAVING</code></h1>
<h1>clause.</h1>
<h1>Nothing to write if there is no <code>HAVING</code> condition.</h1>
<p>if self.frame.having is None:
return
self.newline()</p>
<h1>Handle the case when the condition is an <code>AND</code> operator.</h1>
<p>if isformula(self.frame.having, AndSig):
self.write("HAVING ")
self.indent()
for index, op in enumerate(self.frame.having.ops):
self.format("{op}", op=op)
if index &lt; len(self.frame.having.ops)-1:
self.newline()
self.write("AND ")
self.dedent()</p>
<h1>Handle the regular case.</h1>
<p>else:
self.format("HAVING {condition}",
condition=self.frame.having)</p>
<p>def dump_order(self):</p>
<h1>Serialize an <code>ORDER BY</code> clause.  Dump:</h1>
<h1>ORDER BY <phrase> (ASC|DESC), ...</h1>
<h1>Note: the default serializer assumes that the <code>ASC</code> modifier</h1>
<h1>lists <code>NULL</code> values first, and the <code>DESC</code> modifier lists <code>NULL</code></h1>
<h1>values last.  Backends for which it is not so must override</h1>
<h1>this method.</h1>
<h1>Nothing to write if there is no <code>ORDER BY</code> items.</h1>
<p>if not self.frame.order:
return
self.newline()
self.format("ORDER BY ")</p>
<h1>Write the <code>GROUP BY</code> items.</h1>
<p>for index, (phrase, direction) in enumerate(self.frame.order):</p>
<h1>Just as with <code>GROUP BY</code>, an <code>ORDER BY</code> item could refer</h1>
<h1>to a <code>SELECT</code> column by position.  We do it when possible</h1>
<h1>to avoid serializing the same phrase node twice.</h1>
<p>if phrase in self.frame.select:
position = self.frame.select.index(phrase)+1
self.write(str(position))</p>
<h1>The regular case: serialize the node.</h1>
<p>else:
self.format("{kernel}", kernel=phrase)</p>
<h1>Write the direction modifier.</h1>
<p>self.format(" {direction:switch{ASC|DESC}}", direction=direction)</p>
<h1>Write the trailing comma.</h1>
<p>if index &lt; len(self.frame.order)-1:
self.write(", ")</p>
<p>def dump_limit(self):</p>
<h1>Serialize <code>LIMIT</code> and <code>OFFSET</code> clauses.  Dump:</h1>
<h1>LIMIT <limit></h1>
<h1>OFFSET <offset></h1>
<h1>Note: this syntax is commonly used, but not standard.  A backend</h1>
<h1>with a different syntax for <code>LIMIT</code> and <code>SELECT</code> clauses must</h1>
<h1>override this method.</h1>
<h1>Nothing to write if there is no <code>LIMIT</code> or <code>OFFSET</code> clause.</h1>
<p>if self.frame.limit is None and self.frame.offset is None:
return</p>
<h1>Dump a <code>LIMIT</code> clause.</h1>
<p>if self.frame.limit is not None:
self.newline()
self.format("LIMIT "+str(self.frame.limit))</p>
<h1>Dump an <code>OFFSET</code> clause.</h1>
<p>if self.frame.offset is not None:
self.newline()
self.format("OFFSET "+str(self.frame.offset))</p>
<p>class DumpNested(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        <p>adapts(NestedFrame)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(SELECT ...</h1>
<h1>...)</h1>
<p>self.format("(")
self.indent()
super(DumpNested, self).<strong>call</strong>()
self.dedent()
self.format(")")
</pre></p>
<p>class DumpSegment(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        <p>adapts(SegmentFrame)</p>
<p>def <strong>call</strong>(self):
<pre>super(DumpSegment, self).<strong>call</strong>()</p>
<h1>FIXME: add a semicolon?</h1>
<h1>Make sure the statement ends with a new line.</h1>
<p>self.newline()
</pre></p>
<p>class DumpLeadingAnchor(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>adapts(LeadingAnchor)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1><frame> AS <alias></h1>
<p>alias = self.state.frame_alias_by_tag[self.clause.frame.tag]
self.state.push_hook(with_aliases=True)
self.format("{frame} AS {alias:name}",
frame=self.clause.frame, alias=alias)
self.state.pop_hook()
</pre></p>
<p>class DumpAnchor(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        <p>adapts(Anchor)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(CROSS|INNER|...) JOIN <frame> AS <alias></h1>
<h1>ON <condition></h1>
<p>alias = self.state.frame_alias_by_tag[self.clause.frame.tag]
self.newline()
if self.clause.is_cross:
self.write("CROSS JOIN ")
elif self.clause.is_inner:
self.write("INNER JOIN ")
elif self.clause.is_left and not self.clause.is_right:
self.write("LEFT OUTER JOIN ")
elif self.clause.is_right and not self.clause.is_left:
self.write("RIGHT OUTER JOIN ")
else:
self.write("FULL OUTER JOIN ")
self.indent()
self.state.push_hook(with_aliases=True)
self.format("{frame} AS {alias:name}",
frame=self.clause.frame, alias=alias)
self.state.pop_hook()
if self.clause.condition is not None:
self.newline()
self.format("ON {condition}",
condition=self.clause.condition)
self.dedent()
</pre></p>
<p>class DubColumn(Dub):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        <p>adapts(ColumnPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Use the name of the column as an alias.
return self.clause.column.name
</pre></p>
<p>class DumpColumn(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        <p>adapts(ColumnPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1><alias>.<column></h1>
<p>parent = self.state.frame_alias_by_tag[self.phrase.tag]
child = self.phrase.column.name
self.format("{parent:name}.{child:name}",
parent=parent, child=child)
</pre></p>
<p>class DubReference(Dub):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        <p>adapts(ReferencePhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Use the same alias as the target phrase.
frame = self.state.frame_by_tag[self.clause.tag]
phrase = frame.select[self.clause.index]
return self.state.dub(phrase)
</pre></p>
<p>class DumpReference(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        <p>adapts(ReferencePhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1><frame>.<column></h1>
<p>parent = self.state.frame_alias_by_tag[self.phrase.tag]
select_aliases = self.state.select_aliases_by_tag[self.phrase.tag]
child = select_aliases[self.phrase.index]
self.format("{parent:name}.{child:name}",
parent=parent, child=child)
</pre></p>
<p>class DubEmbedding(Dub):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        <p>adapts(EmbeddingPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Use the same alias as the (only) output column of the subquery.
frame = self.state.frame_by_tag[self.clause.tag]
[phrase] = frame.select
return self.state.dub(phrase)
</pre></p>
<p>class DumpEmbedding(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        <p>adapts(EmbeddingPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Fetch and serialize the suframe.
frame = self.state.frame_by_tag[self.phrase.tag]
self.state.push_hook(with_aliases=False)
self.format("{frame}", frame=frame)
self.state.pop_hook()
</pre></p>
<p>class DumpLiteral(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        <p>adapts(LiteralPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Delegate serialization to <code>DumpByDomain</code>.
dump = DumpByDomain(self.phrase, self.state)
return dump()
</pre></p>
<p>class DumpNull(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        <p>adapts(NullPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># We serialize a <code>NULL</code> value here to avoid checking for</p>
<h1><code>NULL</code> in every implementation of <code>DumpByDomain</code>.</h1>
<h1>FIXME: This assumes that we never need to add an explicit type</h1>
<h1>specifier to a <code>NULL</code> value.</h1>
<p>self.write("NULL")
</pre></p>
<p>class DumpByDomain(DumpBase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        <p>adapts(Domain)</p>
<p>@classmethod
def dispatch(interface, phrase, <em>args, </em>*kwds):
<pre># Dispatch the adapter on the domain of the literal node.
assert isinstance(phrase, LiteralPhrase)
return (type(phrase.domain),)
</pre>
def <strong>init</strong>(self, phrase, state):
assert isinstance(phrase, LiteralPhrase)
assert phrase.value is not None
super(DumpByDomain, self).<strong>init</strong>(phrase, state)
self.phrase = phrase</p>
<h1>Extract commonly used attributes of the literal node.</h1>
<p>self.value = phrase.value
self.domain = phrase.domain</p>
<p>class DumpBoolean(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        <p>adapts(BooleanDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Use the SQL standard constants: <code>TRUE</code> and <code>FALSE</code>.</p>
<h1>Backends not supporting those must override this implementation.</h1>
<p>if self.value is True:
self.write("TRUE")
if self.value is False:
self.write("FALSE")
</pre></p>
<p>class DumpInteger(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        <p>adapts(IntegerDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump an integer number.  A backend may override this implementation</p>
<h1>to support a different range of integer values.</h1>
</pre>

<h1>We assume that the database supports 8-byte signed integer values</h1>
<h1>natively and complain if the value is out of this range.</h1>
<p>if not (-2<strong>63 &lt;= self.value &lt; 2</strong>63):
<pre>raise SerializeError("invalid integer value",
self.phrase.mark)</p>
<h1>Write the number; use <code>(...)</code> around a negative number.</h1>
<p>if self.value &gt;= 0:
self.write(str(self.value))
else:
self.write("(%s)" % self.value)
</pre></p>
<p>class DumpFloat(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        <p>adapts(FloatDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump a floating-point number.  A backend may override this method</p>
<h1>to support a different range of floating-point values or to</h1>
<h1>provide an exact type specifier.</h1>
</pre>

<h1>Last check that we didn't get a non-number.</h1>
<h1>FIXME: Python 2.5/win32?</h1>
<p>assert str(self.value) not in ['inf', '-inf', 'nan']</p>
<h1>Write the standard representation of the number assuming that</h1>
<h1>the database could figure out its type from the context; use <code>(...)</code></h1>
<h1>around a negative number.</h1>
<p>if self.value &gt;= 0.0:
<pre>self.write(repr(self.value))
else:
self.write("(%r)" % self.value)
</pre></p>
<p>class DumpDecimal(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        <p>adapts(DecimalDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump a decimal number.  A backend may override this method</p>
<h1>to support a different range of values or to add an exact</h1>
<h1>type specifier.</h1>
</pre>

<h1>Last check that we didn't get a non-number.</h1>
<p>assert self.value.is_finite()</p>
<h1>Write the standard representation of the number assuming that</h1>
<h1>the database could figure out its type from the context; use <code>(...)</code></h1>
<h1>around a negative number.</h1>
<p>if not self.value.is_signed():
<pre>self.write(str(self.value))
else:
self.write("(%s)" % self.value)
</pre></p>
<p>class DumpString(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        <p>adapts(StringDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump the value as a quoted literal.
self.format("{value:literal}", value=self.value)
</pre></p>
<p>class DumpEnum(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        <p>adapts(EnumDomain)</p>
<p>def <strong>call</strong>(self):
<pre># There is no an enumerated type in the SQL standard, but most</p>
<h1>backends which support enumerated types accept quoted literals.</h1>
<p>self.format("{value:literal}", value=self.value)
</pre></p>
<p>class DumpDate(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        <p>adapts(DateDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>DATE 'YYYY-MM-DD'</h1>
<h1>A backend with a different (or no) date represetation may need</h1>
<h1>to override this implementation.</h1>
<p>self.format("DATE {value:literal}", value=str(self.value))
</pre></p>
<p>class DumpTime(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>adapts(TimeDomain)</p>
<p>def <strong>call</strong>(self):
<pre>self.format("TIME {value:literal}", value=str(self.value))
</pre></p>
<p>class DumpDateTime(DumpByDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        <p>adapts(DateTimeDomain)</p>
<p>def <strong>call</strong>(self):
<pre>if self.value.tzinfo is None:
self.format("TIMESTAMP {value:literal}", value=str(self.value))
else:
self.format("TIMESTAMP WITH TIME ZONE {value:literal}",
value=str(self.value))
</pre></p>
<p>class DumpCast(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        <p>adapts(CastPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Delegate serialization to <code>DumpToDomain</code>.
dump = DumpToDomain(self.phrase, self.state)
return dump()
</pre></p>
<p>class DumpToDomain(DumpBase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>adapts(Domain, Domain)</p>
<p>@classmethod
def dispatch(interface, phrase, <em>args, </em>*kwds):
<pre># Dispatch the adapter on the origin and the target domains</p>
<h1>of the cast.</h1>
<p>assert isinstance(phrase, CastPhrase)
return (type(phrase.base.domain), type(phrase.domain))
</pre>
def <strong>init</strong>(self, phrase, state):
assert isinstance(phrase, CastPhrase)
super(DumpToDomain, self).<strong>init</strong>(phrase, state)
self.phrase = phrase</p>
<h1>Extract commonly used attributes.</h1>
<p>self.base = phrase.base
self.domain = phrase.domain</p>
<p>class DumpToInteger(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        <p>adapts(Domain, IntegerDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>CAST(<base> AS INTEGER)</h1>
<h1>A backend with no integer data type or an integer data type</h1>
<h1>with a different name needs to override this implementation.</h1>
<p>self.format("CAST({base} AS INTEGER)", base=self.base)
</pre></p>
<p>class DumpToFloat(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        <p>adapts(Domain, FloatDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>CAST(<base> AS DOUBLE PRECISION)</h1>
<h1>A backend with no floating-point data type or a floating-point</h1>
<h1>data type with a different name needs to override this</h1>
<h1>implementation.</h1>
<p>self.format("CAST({base} AS DOUBLE PRECISION)", base=self.base)
</pre></p>
<p>class DumpToDecimal(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        <p>adapts(Domain, DecimalDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>CAST(<base> AS DECIMAL)</h1>
<h1>A backend with no decimal data type or a decimal data type</h1>
<h1>with a different name needs to override this implementation.</h1>
<p>self.format("CAST({base} AS DECIMAL)", base=self.base)
</pre></p>
<p>class DumpToString(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        <p>adapts(Domain, StringDomain)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>CAST(<base> AS CHARACTER VARYING)</h1>
<h1>A backend that supports many character types may choose a different</h1>
<h1>target data type.</h1>
<p>self.format("CAST({base} AS CHARACTER VARYING)", base=self.base)
</pre></p>
<p>class DumpToDate(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        <p>adapts(Domain, DateDomain)</p>
<p>def <strong>call</strong>(self):
<pre>self.format("CAST({base} AS DATE)", base=self.base)
</pre></p>
<p>class DumpToTime(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        <p>adapts(Domain, TimeDomain)</p>
<p>def <strong>call</strong>(self):
<pre>self.format("CAST({base} AS TIME)", base=self.base)
</pre></p>
<p>class DumpToDateTime(DumpToDomain):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        <p>adapts(Domain, DateTimeDomain)</p>
<p>def <strong>call</strong>(self):
<pre>self.format("CAST({base} AS TIMESTAMP)", base=self.base)
</pre></p>
<p>class DumpFormula(Dump):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        <p>adapts(FormulaPhrase)</p>
<p>def <strong>call</strong>(self):
<pre># Delegate serialization to <code>DumpBySignature</code>.
dump = DumpBySignature(self.phrase, self.state)
return dump()
</pre></p>
<p>class DumpBySignature(DumpBase):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        <p>adapts(Signature)</p>
<p>@classmethod
def dispatch(interface, phrase, <em>args, </em>*kwds):
<pre># Dispatch the adapter on the signature of the formula.
assert isinstance(phrase, FormulaPhrase)
return (type(phrase.signature),)
</pre>
def <strong>init</strong>(self, phrase, state):
assert isinstance(phrase, FormulaPhrase)
super(DumpBySignature, self).<strong>init</strong>(phrase, state)
self.phrase = phrase</p>
<h1>Extract commonly used attributes of the formula.</h1>
<p>self.signature = phrase.signature
self.domain = phrase.domain
self.arguments = phrase.arguments</p>
<p>class DumpIsEqual(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        <p>adapts(IsEqualSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<lop> (=|&lt;&gt;) <rop>)</h1>
<p>self.format("({lop} {polarity:switch{=|&lt;&gt;}} {rop})",
self.arguments, self.signature)
</pre></p>
<p>class DumpIsTotallyEqual(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        <p>adapts(IsTotallyEqualSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<lop> IS (NOT) DISTINCT FROM <rop>)</h1>
<h1>Note that many backends do not support <code>IS DISTINCT FROM</code></h1>
<h1>operator and need to reimplement this implementation using</h1>
<h1>the regular equality operator and <code>IS NULL</code>.</h1>
<p>self.format("({lop} IS {polarity:not}DISTINCT FROM {rop})",
self.arguments, polarity=-self.signature.polarity)
</pre></p>
<p>class DumpIsIn(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>adapts(IsInSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<lop> (NOT) IN (rop1, rop2, ...))</h1>
<p>self.format("({lop} {polarity:not}IN ({rops:union{, }}))",
self.arguments, self.signature)
</pre></p>
<p>class DumpAnd(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        <p>adapts(AndSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<op1> AND <op2> AND ...)</h1>
<p>self.format("({ops:union{ AND }})", self.arguments)
</pre></p>
<p>class DumpOr(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        <p>adapts(OrSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<op1> OR <op2> OR ...)</h1>
<p>self.format("({ops:union{ OR }})", self.arguments)
</pre></p>
<p>class DumpNot(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p>adapts(NotSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(NOT <op>)</h1>
<p>self.format("(NOT {op})", self.arguments)
</pre></p>
<p>class DumpIsNull(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        <p>adapts(IsNullSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<op> IS (NOT) NULL)</h1>
<p>self.format("({op} IS {polarity:not}NULL)",
self.arguments, self.signature)
</pre></p>
<p>class DumpIfNull(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        <p>adapts(IfNullSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>COALESCE(<lop>, <rop>)</h1>
<p>self.format("COALESCE({lop}, {rop})", self.arguments)
</pre></p>
<p>class DumpNullIf(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        <p>adapts(NullIfSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>NULLIF(<lop>, <rop>)</h1>
<p>self.format("NULLIF({lop}, {rop})", self.arguments)
</pre></p>
<p>class DumpCompare(DumpBySignature):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>adapts(CompareSig)</p>
<p>def <strong>call</strong>(self):
<pre># Dump:</p>
<h1>(<lop> (&lt;|&lt;=|&gt;|&gt;=) <rop>)</h1>
<p>self.format("({lop} {relation:pass} {rop})",
self.arguments, self.signature)
</pre></p>
<p>class DumpToPredicate(DumpBySignature):</p>
<p>adapts(ToPredicateSig)</p>
<p>def <strong>call</strong>(self):
return self.state.dump(self.phrase.op)</p>
<p>class DumpFromPredicate(DumpBySignature):</p>
<p>adapts(FromPredicateSig)</p>
<p>def <strong>call</strong>(self):
return self.state.dump(self.phrase.op)</p>
<p>def serialize(clause, state=None):</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        <h1>Create a new serializing state if necessary.</h1>
<p>if state is None:
<pre>state = SerializingState()</p>
<h1>Realize and apply the <code>Serialize</code> adapter.</h1>
<p>serialize = Serialize(clause, state)
return serialize()
</pre></p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
