<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>assemble.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>assemble.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Copyright (c) 2006-2011, Prometheus Research, LLC
See <code>LICENSE</code> for license information, <code>AUTHORS</code> for the list of authors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>:mod:<code>htsql.tr.assemble</code></h1>
<p>This module implements the assembling process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">Printable</span><span class="p">,</span> <span class="n">Comparable</span>
<span class="kn">from</span> <span class="nn">..adapter</span> <span class="kn">import</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">adapts</span><span class="p">,</span> <span class="n">adapts_many</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="n">BooleanDomain</span>
<span class="kn">from</span> <span class="nn">.coerce</span> <span class="kn">import</span> <span class="nb">coerce</span>
<span class="kn">from</span> <span class="nn">.flow</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Code</span><span class="p">,</span> <span class="n">LiteralCode</span><span class="p">,</span> <span class="n">FormulaCode</span><span class="p">,</span> <span class="n">CastCode</span><span class="p">,</span> <span class="n">Unit</span><span class="p">,</span> <span class="n">ColumnUnit</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.term</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PreTerm</span><span class="p">,</span> <span class="n">Term</span><span class="p">,</span> <span class="n">UnaryTerm</span><span class="p">,</span> <span class="n">BinaryTerm</span><span class="p">,</span> <span class="n">TableTerm</span><span class="p">,</span>
                   <span class="n">ScalarTerm</span><span class="p">,</span> <span class="n">FilterTerm</span><span class="p">,</span> <span class="n">JoinTerm</span><span class="p">,</span> <span class="n">CorrelationTerm</span><span class="p">,</span>
                   <span class="n">EmbeddingTerm</span><span class="p">,</span> <span class="n">ProjectionTerm</span><span class="p">,</span> <span class="n">OrderTerm</span><span class="p">,</span> <span class="n">SegmentTerm</span><span class="p">,</span>
                   <span class="n">QueryTerm</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.frame</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ScalarFrame</span><span class="p">,</span> <span class="n">TableFrame</span><span class="p">,</span> <span class="n">NestedFrame</span><span class="p">,</span>
                    <span class="n">SegmentFrame</span><span class="p">,</span> <span class="n">QueryFrame</span><span class="p">,</span>
                    <span class="n">LiteralPhrase</span><span class="p">,</span> <span class="n">TruePhrase</span><span class="p">,</span> <span class="n">CastPhrase</span><span class="p">,</span>
                    <span class="n">ColumnPhrase</span><span class="p">,</span> <span class="n">ReferencePhrase</span><span class="p">,</span> <span class="n">EmbeddingPhrase</span><span class="p">,</span>
                    <span class="n">FormulaPhrase</span><span class="p">,</span> <span class="n">Anchor</span><span class="p">,</span> <span class="n">LeadingAnchor</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.signature</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Signature</span><span class="p">,</span> <span class="n">IsEqualSig</span><span class="p">,</span> <span class="n">IsTotallyEqualSig</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">,</span>
                        <span class="n">IsNullSig</span><span class="p">,</span> <span class="n">NullIfSig</span><span class="p">,</span> <span class="n">IfNullSig</span><span class="p">,</span> <span class="n">CompareSig</span><span class="p">,</span>
                        <span class="n">AndSig</span><span class="p">,</span> <span class="n">OrSig</span><span class="p">,</span> <span class="n">NotSig</span><span class="p">,</span> <span class="n">ToPredicateSig</span><span class="p">,</span>
                        <span class="n">FromPredicateSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Represents an export request.</p>
<p>A :class:<code>Claim</code> object represents a request to the broker frame
to export a unit from the target frame.</p>
<p>The claim indicates that the <code>SELECT</code> clause of the broker frame
must contain a phrase that evaluates the unit.</p>
<p>The target frame must either coincide with the broker frame or
be a descendant of the broker frame.  When the target and the
broker coincide, the broker is responsible for evaluating the
unit value.  Otherwise, the broker imports the unit value from
one of its subframes.</p>
<p>Claim objects are compared by-value.  That is, two claim objects
are equal if their units, brokers, and targets are equal to each
other.</p>
<p><code>unit</code> (:class:<code>htsql.tr.flow.Unit</code>)
<pre>The exported unit.
</pre>
<code>broker</code> (an integer)
The tag of the broker term/frame.  The broker frame is expected
to export a phrase corresponding to the given unit.</p>
<p><code>target</code> (an integer)
The tag of the target term/frame.  The target frame is responsible
for evaluating the unit.  The target term must be a descendant
of the broker term or coincide with the broker term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Claim</span><span class="p">(</span><span class="n">Comparable</span><span class="p">,</span> <span class="n">Printable</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">Unit</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">broker</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>Claim objects need by-value comparison to avoid assigning
multiple claims for the same unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">equality_vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Claim</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equality_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">broker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s">)-&gt;</span><span class="si">%s</span><span class="s">-&gt;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>Encapsulates a dispatching context.</p>
<p>Dispatching context provides information necessary to demand
and supply unit claims.</p>
<p><code>is_nullable</code> (Boolean)
<pre>Indicates that the currently assembled frame is going
to be joined to the parent frame using an outer join.
</pre>
This flag affects the <code>is_nullable</code> indicator of
exported phrases.</p>
<p><code>dispatches</code> (a dictionary <code>tag -&gt; tag</code>)
Maps a descendant term to the immediate child whose subtree contains
the term.</p>
<p>The <code>dispatches</code> table is used when generating unit claims
to determine the broker term by the target term.</p>
<p>See also the <code>offsprings</code> attribute of :class:<code>htsql.tr.term.Term</code>.</p>
<p><code>routes</code> (a dictionary <code>Unit | Flow -&gt; tag</code>)
Maps a unit to a term capable of evaluating the unit.</p>
<p>The <code>routes</code> table is used when generating unit claims
to determine the target term by the unit.</p>
<p>A key of the <code>routes</code> table is either a :class:<code>htsql.tr.flow.Unit</code>
node or a :class:<code>htsql.tr.flow.Flow</code> node.  The latter indicates
that the corresponding term is capable of exporting any primitive
unit from the given flow.</p>
<p>See also the <code>routes</code> attribute of :class:<code>htsql.tr.term.Term</code>.</p>
<p>Note that <code>dispatches</code> and <code>routes</code> come from <code>offsprings</code> and <code>routes</code>
attributes of :class:<code>htsql.tr.term.Term</code>.  However they do not have to
come from the same term!  Typically, <code>dispatches</code> comes from the term
which is currently translated to a frame, and <code>routes</code> comes either
from the same term or from one of its direct children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Gate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span> <span class="n">dispatches</span><span class="p">,</span> <span class="n">routes</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>Sanity check on the arguments.  We do not perform a costly check
on the keys and the values of the mappings since they come directly
from term attributes and it is hard to mess them up.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_nullable</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dispatches</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_nullable</span> <span class="o">=</span> <span class="n">is_nullable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatches</span> <span class="o">=</span> <span class="n">dispatches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span> <span class="o">=</span> <span class="n">routes</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>Encapsulates the state of the assembling process.</p>
<p>State attributes:</p>
<p><code>gate</code> (:class:<code>Gate</code>)
<pre>The current dispatching context.
</pre>
<code>claim_set</code> (a set of :class:<code>Claim</code>)
All requested unit claims.</p>
<p><code>claims_by_broker</code> (a mapping <code>tag -&gt; [Claim]</code>)
Unit claims grouped by the broker.</p>
<p>A key of the mapping is the broker tag.  A value of the mapping
is a list of :class:<code>Claim</code> objects with the same broker.</p>
<p><code>phrase_by_claim</code> (a mapping <code>Claim -&gt; Phrase</code>)
Satisfied claims.</p>
<p>A key of the mapping is a :class:<code>Claim</code> object.  A value of the
mapping is a :class:<code>htsql.tr.frame.ExportPhrase</code> object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssemblingState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p>The stack of previous gates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gate_stack</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p>The current gate (dispatching context).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p>The set of all unit claims (used for checking for duplicates).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">claim_set</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p>Unit claims grouped by the broker.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">claims_by_broker</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p>Satisfied unit claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">phrase_by_claim</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p>Initializes the assembling state.</p>
<p>This method must be called before assembling any frames.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.SegmentTerm</code>)
<pre>The term corresponding to the top-level <code>SELECT</code> statement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">SegmentTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p>Use the segment term both as the dispatcher and the router.  We
set <code>is_nullable</code> to <code>False</code>, but the value does not really matter
since we never export from the segment frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">Gate</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">offsprings</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <p>Initialize claim containers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">claim_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">claims_by_broker</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phrase_by_claim</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p>Initialize <code>claims_by_broker</code> with an empty list for each node
in the term tree.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">claims_by_broker</span><span class="p">[</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">offspring</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">offsprings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">claims_by_broker</span><span class="p">[</span><span class="n">offspring</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p></pre>Clears the assembling state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p>Revert all attributes to their pristine state.  We assume that
<code>gate_stack</code> is already empty.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">claim_set</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">claims_by_broker</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phrase_by_claim</span> <span class="o">=</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <p>Updates the current dispatching context.</p>
<p><code>is_nullable</code> (Boolean or <code>None</code>)
<pre>Indicates that the currently assembled frame is to be
attached to the parent frame using an <code>OUTER</code> join.
</pre>
If <code>None</code>, keeps the current value.</p>
<p>When satisfying the claims directed to the currently
constructed frame, this flag is used to determine whether
the exported values are nullable or not.</p>
<p><code>dispatcher</code> (:class:<code>htsql.tr.term.Term</code> or <code>None</code>)
Specifies the dispatcher term.</p>
<p>If <code>None</code>, keeps the current dispatcher.</p>
<p>The dispatcher term (more exactly, the <code>offsprings</code> table
of the term) maps a descendant term to the immediate
child whose subtree contains the term.</p>
<p>When generating claims, the dispatcher is used to find
the broker term by the target term.</p>
<p>Typically, the dispatcher term is the one currently
translated to a frame node.</p>
<p><code>router</code> (:class:<code>htsql.tr.term.Term</code> or <code>None</code>)
Specifies the router term.</p>
<p>If <code>None</code>, uses <code>dispatcher</code> as the router term.
If both <code>dispatcher</code> and <code>router</code> are <code>None</code>,
keeps the current router.</p>
<p>The router term (more exactly, the <code>routes</code> table of the
term) maps a unit to a term capable of evaluating the unit.</p>
<p>When generating claims, the router is used to find
the target term by the unit.</p>
<p>Typically, the router term is the one currently translated
to a frame node or one of its immediate children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">push_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_nullable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p>If <code>is_nullable</code> is not set, keep the current value.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">is_nullable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">is_nullable</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        <p>Extract the dispatching table from the given <code>dispatcher</code> term,
keeps the current table if <code>dispatcher</code> is not specified.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">dispatcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dispatches</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">offsprings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dispatches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">dispatches</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <p>When changing the dispatcher, we always want to change the router
as well.  Thus, when <code>dispatcher</code> is specified, but <code>router</code> is not,
we assume that <code>router</code> coincides with <code>dispatcher</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">router</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">router</span> <span class="o">=</span> <span class="n">dispatcher</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p>Extract the routing table from the given <code>router</code> term, keeps
the current table if <code>router</code> is not specified.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="n">router</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">routes</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">routes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">routes</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        <p>Save the current gate and install the new one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gate_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">Gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">dispatches</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p>Restores the previous dispatching context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pop_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p>Assembles a frame node for the given term.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.Term</code>)
<pre>A term node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p>Realize and call the <code>Assemble</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">assemble</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <p></pre>Generates a claim for the given unit.</p>
<p>This method finds the target and the broker terms that are
capable of evaluating the unit and returns the corresponding
:class:<code>Claim</code> object.</p>
<p><code>unit</code> (:class:<code>htsql.tr.flow.Unit</code>)
<pre>The unit to make a claim for.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">appoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <p>To make a claim, we need to find two terms:
- the target term, one that is capable of evaluating the unit;
- the broker term, an immediate child which contains the target
  term (or, possibly coincides with the target term).
We use the current routing and dispatching tables to determine
the target and the broker terms respectively.
Note that it is a responsibility of the caller to ensure that
the current routing table contains the given unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <h1>Extract the (tag of the) target term from the current routing</h1>
<h1>table.  Recall that <code>routes</code> does not keep primitive units directly,</h1>
<h1>instead a flow node represents all primitive units that belong</h1>
<h1>to that flow.</h1>
<p>if unit.is_primitive:
   assert unit.flow in self.gate.routes
   target = self.gate.routes[unit.flow]
if unit.is_compound:
   assert unit in self.gate.routes
   target = self.gate.routes[unit]</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">routes</span><span class="p">,</span> <span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-39'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-39">#</a>
        </div>
        <p>Extract the (tag of the) broker term from the current dispatch
table.
FIXME?: there is a possibility that the target coincides with
the current term -- it may happen, for instance, with scalar units.
To handle this case properly, we need to dismantle the unit
and appoint all its sub-units.  However currently the compiler
takes special care to ensure that scalar units are never routed
to the term where they are defined, so we do not bother with
handling this case here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">dispatches</span>
        <span class="n">broker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">dispatches</span><span class="p">[</span><span class="n">target</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-40'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-40">#</a>
        </div>
        <p>Generate and return a claim object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">Claim</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-41'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-41">#</a>
        </div>
        <p></pre>Generates a forward claim for the given claim.</p>
<p>This function takes a claim targeted to one of the current term's
descendants and returns a new claim dispatched to the current term's
immediate child.</p>
<p><code>claim</code> (:class:<code>Claim</code>)
<pre>A claim dispatched to the current term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">claim</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-42'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-42">#</a>
        </div>
        <p>This function is used when a term gets a claim targeted not
to the term itself, but to one of its descendants.  In this
case, we need to re-dispatch the claim to the immediate child
whose subtree contains the target term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">dispatches</span>
        <span class="n">broker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">dispatches</span><span class="p">[</span><span class="n">claim</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Claim</span><span class="p">(</span><span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">claim</span><span class="o">.</span><span class="n">target</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-43'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-43">#</a>
        </div>
        <p></pre>Appoints and assigns claims for all units of the given code.</p>
<p><code>code</code> (:class:<code>htsql.tr.flow.Code</code>)
<pre>A code object to schedule.
</pre>
<code>dispatcher</code> (:class:<code>htsql.tr.term.Term</code> or <code>None</code>)
Specifies the dispatcher to use when appointing units.</p>
<p>If <code>None</code>, keeps the current dispatcher.</p>
<p><code>router</code> (:class:<code>htsql.tr.term.Term</code> or <code>None</code>)
Specifies the router to use when appointing units.</p>
<p>If <code>None</code>, uses <code>dispacher</code> as the router term;
if both are <code>None</code>, keeps the current router.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-44'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-44">#</a>
        </div>
        <p>Update the gate to use the given dispatcher and router.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">=</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="n">router</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-45'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-45">#</a>
        </div>
        <p>Iterate over all units included to the given code node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-46'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-46">#</a>
        </div>
        <p>Generate a claim for the unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appoint</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-47'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-47">#</a>
        </div>
        <p>Assign the claim to the broker.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-48'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-48">#</a>
        </div>
        <p>Restore the original gate.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-49'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-49">#</a>
        </div>
        <p>Evaluates the given code node.</p>
<p>Returns the corresponding :class:<code>htsql.tr.frame.Phrase</code> node.</p>
<p>It is assumed that the code node was previously scheduled
with :meth:<code>schedule</code> and all the claims were satisfied.</p>
<p><code>code</code> (:class:<code>htsql.tr.flow.Code</code>)
<pre>The code node to evaluate.
</pre>
<code>dispatcher</code> (:class:<code>htsql.tr.term.Term</code> or <code>None</code>)
Specifies the dispatcher to use when appointing units.</p>
<p>If <code>None</code>, keeps the current dispatcher.</p>
<p><code>router</code> (:class:<code>htsql.tr.term.Term</code> or <code>None</code>)
Specifies the router to use when appointing units.</p>
<p>If <code>None</code> uses <code>dispacher</code> as the router term;
if both are <code>None</code>, keeps the current router.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-50'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-50">#</a>
        </div>
        <p>Update the gate to use the given dispatcher and router.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">=</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="n">router</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-51'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-51">#</a>
        </div>
        <p>Realize and call the <code>Evaluate</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">evaluate</span> <span class="o">=</span> <span class="n">Evaluate</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-52'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-52">#</a>
        </div>
        <p>Restore the original gate.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-53'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-53">#</a>
        </div>
        <p>Return the generated phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">phrase</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-54'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-54">#</a>
        </div>
        <p>Assigns the given claim to the broker.</p>
<p><code>claim</code> (:class:<code>Claim</code>)
<pre>The claim to assign.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">claim</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-55'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-55">#</a>
        </div>
        <p>Check is the claim (remember, they are compared by value) was
already assigned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">claim_set</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-56'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-56">#</a>
        </div>
        <p>Add it to the list of all claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">claim_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-57'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-57">#</a>
        </div>
        <p>Assign it to the broker.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">claims_by_broker</span><span class="p">[</span><span class="n">claim</span><span class="o">.</span><span class="n">broker</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-58'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-58">#</a>
        </div>
        <p></pre>Satisfies the claim.</p>
<p><code>claim</code> (:class:<code>Claim</code>)
<pre>The claim to satisfy.
</pre>
<code>phrase</code> (:class:<code>htsql.tr.frame.Phrase</code>)
The phrase that satisfies the claim.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">supply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">claim</span><span class="p">,</span> <span class="n">phrase</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-59'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-59">#</a>
        </div>
        <p>A few sanity checks.  Verify that the claim was actually requested.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">claim_set</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-60'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-60">#</a>
        </div>
        <p>Verify that the claim was not satisfied already.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">claim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phrase_by_claim</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-61'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-61">#</a>
        </div>
        <p>Save the phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">phrase_by_claim</span><span class="p">[</span><span class="n">claim</span><span class="p">]</span> <span class="o">=</span> <span class="n">phrase</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-62'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-62">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">to_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">ToPredicateSig</span><span class="p">(),</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                             <span class="n">phrase</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-63'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-63">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">from_predicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phrase</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">FromPredicateSig</span><span class="p">(),</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                             <span class="n">phrase</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span> <span class="n">phrase</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-64'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-64">#</a>
        </div>
        <p>Translates a term node to a frame node.</p>
<p>This is an interface adapter, see subclasses for implementations.</p>
<p>The :class:<code>Assemble</code> adapter has the following signature::</p>
<pre>Assemble: (Term, AssemblingState) -> Frame
</pre>

<p>The adapter is polymorphic on the <code>Term</code> argument.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.Term</code>)
A term node.</p>
<p><code>state</code> (:class:<code>AssemblingState</code>)
The current state of the assembling process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Assemble</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-65'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-65">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">PreTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-66'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-66">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">PreTerm</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AssemblingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">term</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-67'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-67">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-68'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-68">#</a>
        </div>
        <p>Implement in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the compile adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-69'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-69">#</a>
        </div>
        <p>Assembles a frame for a proper term node.</p>
<p>This adapts :class:<code>Assemble</code> for proper term nodes (i.e., not a
:class:<code>htsql.tr.term.QueryTerm</code>).</p>
<p>Attributes:</p>
<p><code>claims</code> (a list of :class:<code>Claim</code>)
<pre>The claims that are dispatched to the term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleTerm</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-70'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-70">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-71'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-71">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AssembleTerm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-72'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-72">#</a>
        </div>
        <p>Extract claims dispatched to the given term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">claims</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">claims_by_broker</span><span class="p">[</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-73'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-73">#</a>
        </div>
        <p></pre>Assembles a (scalar) frame for a scalar term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleScalar</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-74'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-74">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">ScalarTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-75'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-75">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-76'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-76">#</a>
        </div>
        <p>A scalar term cannot export anything and thus should never receive
any claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-77'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-77">#</a>
        </div>
        <p>Generate and return a frame node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">ScalarFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-78'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-78">#</a>
        </div>
        <p>Assembles a (table) frame for a table term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleTable</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-79'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-79">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">TableTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-80'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-80">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-81'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-81">#</a>
        </div>
        <p>The actual table entity.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">table</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-82'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-82">#</a>
        </div>
        <p>Iterate over and satisfy all the claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-83'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-83">#</a>
        </div>
        <p>Sanity checks.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">broker</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-84'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-84">#</a>
        </div>
        <p>FIXME: Currently, a table term could only expect claims for
column units.  In the future, however, we may wish to allow
other kinds of units (for instance, to support pseudo-columns).
To handle that, we may need to introduce a new adapter
dispatched on the unit type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">is_primitive</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">ColumnUnit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-85'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-85">#</a>
        </div>
        <p>The requested column entity.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">column</span> <span class="o">=</span> <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">column</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-86'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-86">#</a>
        </div>
        <p>More sanity checks.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">assert</span> <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">schema_name</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">schema_name</span> <span class="ow">and</span>
                    <span class="n">column</span><span class="o">.</span><span class="n">table_name</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-87'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-87">#</a>
        </div>
        <p>The exported phrase is nullable if the column itself is nullable,
but also if the frame is attached to its parent using an
<code>OUTER JOIN</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-88'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-88">#</a>
        </div>
        <p>Satisfy the claim with a column phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">export</span> <span class="o">=</span> <span class="n">ColumnPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                  <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">supply</span><span class="p">(</span><span class="n">claim</span><span class="p">,</span> <span class="n">export</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-89'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-89">#</a>
        </div>
        <p>Generate and return a frame node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">TableFrame</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-90'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-90">#</a>
        </div>
        <p>Assembles a branch frame.</p>
<p>This is a default implementation used by all non-terminal (i.e. unary
or binary) terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleBranch</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-91'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-91">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">(</span><span class="n">UnaryTerm</span><span class="p">,</span> <span class="n">BinaryTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-92'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-92">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-93'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-93">#</a>
        </div>
        <p>Review all the given claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">broker</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-94'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-94">#</a>
        </div>
        <p>If the claim is not targeted to us directly, we are not
responsible for evaluating it.  Just forward it to the
next hop.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">claim</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
                <span class="n">next_claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">demand</span><span class="p">(</span><span class="n">next_claim</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-95'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-95">#</a>
        </div>
        <p>Otherwise, the frame will evaluate the unit of the claim.
Dismantle the unit and submit claims for all of its sub-units.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-96'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-96">#</a>
        </div>
        <p>FIXME: Here we assume that a claim targeted to a non-leaf
term is always compound.  This may (or may not) change
in the future.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">is_compound</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-97'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-97">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_include</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-98'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-98">#</a>
        </div>
        <p>Assemle the <code>FROM</code> list; should be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-99'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-99">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-100'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-100">#</a>
        </div>
        <p>Assemble the embedded frames; override in subclasses.
The default implementations assumes there are no embedded subframes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-101'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-101">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-102'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-102">#</a>
        </div>
        <p>Assemble the <code>SELECT</code> clause and satisfy all the claims; may be
overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-103'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-103">#</a>
        </div>
        <p>Note that this method is called after <code>assemble_include()</code> and
<code>assemble_embed()</code>, so any claims requested by <code>delegate()</code> should
be already satisfied.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-104'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-104">#</a>
        </div>
        <p>List of <code>SELECT</code> phrases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-105'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-105">#</a>
        </div>
        <p>A mapping: <code>phrase</code> -&gt; the position of the phrase in the <code>select</code>
list.  We use it to avoid duplicates in the <code>SELECT</code> list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">index_by_phrase</span> <span class="o">=</span> <span class="p">{}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-106'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-106">#</a>
        </div>
        <p>For each of the claims:
- generate a phrase corresponding to the unit of the claim;
- add the phrase to the <code>SELECT</code> list;
- satisfy the claim with a reference to the generated phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-107'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-107">#</a>
        </div>
        <p>Generate a phrase corresponding to the claim.  Check if
the claim is not targeted to us directly -- then it was
targeted to one of our descendants.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">claim</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-108'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-108">#</a>
        </div>
        <p>Generate a forward claim (again).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">next_claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-109'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-109">#</a>
        </div>
        <p>We expect the forward claim to be already satisfied.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="k">assert</span> <span class="n">next_claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">phrase_by_claim</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-110'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-110">#</a>
        </div>
        <p>Get the export phrase that satisfied the claim.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">phrase_by_claim</span><span class="p">[</span><span class="n">next_claim</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-111'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-111">#</a>
        </div>
        <p>Otherwise, the claim is targeted to us and we are responsible
for evaluating the unit of the claim.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-112'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-112">#</a>
        </div>
        <p>Since it is a branch term, the unit must be compound.
So we evaluate the code expression of the unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-113'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-113">#</a>
        </div>
        <p>Check if the generated phrase is a duplicate.  Even though
all claims are unique, different claims may still produce
identical phrases.  Therefore an extra check here is necessary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">phrase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index_by_phrase</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-114'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-114">#</a>
        </div>
        <p>So it is not a duplicate: add it to the <code>SELECT</code> list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
                <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
                <span class="n">index_by_phrase</span><span class="p">[</span><span class="n">phrase</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-115'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-115">#</a>
        </div>
        <p>Generate an export reference to the phrase.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">index</span> <span class="o">=</span> <span class="n">index_by_phrase</span><span class="p">[</span><span class="n">phrase</span><span class="p">]</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-116'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-116">#</a>
        </div>
        <p>The reference is nullable if the referenced phrase itself is
nullable or the assembled frame is to be attached using an
<code>OUTER JOIN</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">phrase</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">gate</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
            <span class="n">export</span> <span class="o">=</span> <span class="n">ReferencePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span>
                                     <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-117'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-117">#</a>
        </div>
        <p>Satisfy the claim with the generated reference.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">supply</span><span class="p">(</span><span class="n">claim</span><span class="p">,</span> <span class="n">export</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-118'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-118">#</a>
        </div>
        <p>It might happen (though with the way the compiler generates the term
tree, it is probably impossible) that the frame has no claims
dispatched to it and therefore the <code>SELECT</code> list is empty.  Since
SQL syntax does not permit an empty <code>SELECT</code> list, we add a dummy
phrase to the list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">select</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">)]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-119'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-119">#</a>
        </div>
        <p>All claims are satisfied; return the generated <code>SELECT</code> list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">select</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-120'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-120">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_where</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-121'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-121">#</a>
        </div>
        <p>Assemble the <code>WHERE</code> clause; could be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-122'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-122">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-123'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-123">#</a>
        </div>
        <p>Assemble the <code>GROUP BY</code> clause; could be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-124'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-124">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_having</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-125'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-125">#</a>
        </div>
        <p>Assemble the <code>HAVING</code> clause; could be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-126'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-126">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-127'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-127">#</a>
        </div>
        <p>Assemble the <code>ORDER BY</code> clause; could be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-128'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-128">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-129'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-129">#</a>
        </div>
        <p>Assemble the <code>LIMIT</code> clause; could be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-130'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-130">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-131'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-131">#</a>
        </div>
        <p>Assemble the <code>OFFSET</code> clause; could be overridden in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">None</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-132'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-132">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span>
                       <span class="n">where</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="p">,</span>
                       <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-133'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-133">#</a>
        </div>
        <p>Assemble a frame node with the given clauses; could be overridden
in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">NestedFrame</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span>
                           <span class="n">where</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="p">,</span>
                           <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-134'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-134">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-135'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-135">#</a>
        </div>
        <p>Review the given claims and dispatch new ones.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-136'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-136">#</a>
        </div>
        <p>Assemble a <code>FROM</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">include</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_include</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-137'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-137">#</a>
        </div>
        <p>Assemble all embedded frames.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_embed</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-138'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-138">#</a>
        </div>
        <p>Assemble the <code>SELECT</code> clause and satisfy the claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_select</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-139'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-139">#</a>
        </div>
        <p>Assemble the remaining clauses of the frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_where</span><span class="p">()</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_group</span><span class="p">()</span>
        <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_having</span><span class="p">()</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_order</span><span class="p">()</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_limit</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_offset</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-140'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-140">#</a>
        </div>
        <p>Generate and return a frame node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_frame</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span>
                                   <span class="n">where</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="p">,</span>
                                   <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-141'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-141">#</a>
        </div>
        <p>Assembles a frame for an unary term.</p>
<p>This is a default implementation used by all unary terms.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleUnary</span><span class="p">(</span><span class="n">AssembleBranch</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-142'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-142">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">UnaryTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-143'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-143">#</a>
        </div>
        <p>Note that <code>AssembleUnary</code> is inherited from <code>AssembleBranch</code> (not
<code>Assemble</code>) to indicate relative priority of these two implementations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-144'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-144">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_include</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-145'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-145">#</a>
        </div>
        <p>Assemble the <code>FROM</code> list.  All unary terms have just one child,
so they could all share the same implementation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-146'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-146">#</a>
        </div>
        <p>Set up the dispatch context for the child term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-147'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-147">#</a>
        </div>
        <p>Assemble the frame by the child term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-148'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-148">#</a>
        </div>
        <p>Restore the original dispatch context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-149'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-149">#</a>
        </div>
        <p>Generate a <code>JOIN</code> clause.  Since it is the first (and the only)
subframe, the <code>JOIN</code> clause has no join condition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">anchor</span> <span class="o">=</span> <span class="n">LeadingAnchor</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-150'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-150">#</a>
        </div>
        <p>Return a <code>FROM</code> list with a single subframe.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">anchor</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-151'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-151">#</a>
        </div>
        <p>Assembles a frame for a filter term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleFilter</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-152'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-152">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">FilterTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-153'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-153">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-154'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-154">#</a>
        </div>
        <p>Call the super <code>delegate()</code> to review and forward claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">AssembleFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delegate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-155'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-155">#</a>
        </div>
        <p>Appoint and assign claims for the <code>filter</code> expression.
Note that we route the filter units against the term's child --
it could do routing because we injected <code>filter</code> to the <code>kid</code>
term when the filter term was compiled.  (However since the filter
term contains all the routes of its child, we could have routed
the filter against the parent term with the same effect.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
                            <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-156'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-156">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_where</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-157'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-157">#</a>
        </div>
        <p>Assemble a <code>WHERE</code> clause.
Evaluate the <code>filter</code> expression (we expect all its claims
to be already satisfied).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span>
                                     <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-158'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-158">#</a>
        </div>
        <p>Assembles a frame for an order term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleOrder</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-159'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-159">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">OrderTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-160'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-160">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-161'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-161">#</a>
        </div>
        <p>Call the super <code>delegate()</code> to review and forward claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">AssembleOrder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delegate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-162'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-162">#</a>
        </div>
        <p>Appoint and assign claims for all code expressions in
the order list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-163'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-163">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-164'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-164">#</a>
        </div>
        <p>Assemble the <code>ORDER BY</code> clause.
The list of <code>(phrase, direction)</code> pairs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-165'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-165">#</a>
        </div>
        <p>Evaluate the code expressions in the order list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">order</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-166'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-166">#</a>
        </div>
        <p>If a code does not have units, it must be a literal or
a scalar function, and thus it cannot affect the ordering
of the frame rows.  We can safely weed it out.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">phrase</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">order</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-167'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-167">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-168'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-168">#</a>
        </div>
        <p>Assemble the <code>LIMIT</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">limit</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-169'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-169">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-170'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-170">#</a>
        </div>
        <p>Assemble the <code>OFFSET</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">offset</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-171'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-171">#</a>
        </div>
        <p>Assembles a frame for a projection term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleProjection</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-172'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-172">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">ProjectionTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-173'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-173">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-174'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-174">#</a>
        </div>
        <p>Update the dispatching context to use the routing table
of the child term.
Note: a projection term is special in that it does not provide
all the routes of its child term.  In particular, when evaluating
an aggregate expression, all its units must be appointed against
the child's routing table.  Only aggregate units target a projection
term directly, therefore updating the routing table should not
affect evaluation of any other claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-175'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-175">#</a>
        </div>
        <p>Call the super <code>delegate()</code> to review and forward claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">AssembleProjection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delegate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-176'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-176">#</a>
        </div>
        <p>Appoint and assign claims for the projection kernel.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-177'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-177">#</a>
        </div>
        <p>Restore the original dispatching context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-178'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-178">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-179'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-179">#</a>
        </div>
        <p>Just like in <code>delegate()</code>, we update the dispatching context
to use the routing table of the child term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-180'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-180">#</a>
        </div>
        <p>Call the super implementation to generate a <code>SELECT</code> list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AssembleProjection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">assemble_select</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-181'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-181">#</a>
        </div>
        <p>Restore the original dispatching context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">select</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-182'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-182">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-183'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-183">#</a>
        </div>
        <p>Assemble a <code>GROUP BY</code> clause.
The list of phrases included to the clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">group</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-184'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-184">#</a>
        </div>
        <p>Evaluate all the code expressions in the kernel.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kernels</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-185'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-185">#</a>
        </div>
        <p>If a code does not have units, it must be a scalar function
or a literal, and therefore it cannot affect the projection.
We can safely weed it out.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">units</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span>
            <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-186'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-186">#</a>
        </div>
        <p>It may happen that the kernel of the projection is empty, which
means the range of the projection is the scalar flow.  SQL
recognizes scalar projections by detecting an aggregate in
the <code>SELECT</code> list, so, technically, we could keep the <code>GROUP BY</code>
list empty.  However, when collapsing frames, we must be able
to distinguish between projection (scalar or not) and non-projection
frames.  To make it easy, we never generate an empty <code>GROUP BY</code>
list for projection terms.  When the projection kernel is empty,
we just add a dummy literal to the list.  This literal will be
removed by the reducing process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">group</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-187'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-187">#</a>
        </div>
        <p>Assembles a frame for a join term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleJoin</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-188'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-188">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">JoinTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-189'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-189">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-190'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-190">#</a>
        </div>
        <p>Call the super <code>delegate()</code> to review and forward claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">AssembleJoin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delegate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-191'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-191">#</a>
        </div>
        <p>Appoint and assign claims for the join condition.
The join condition is composed of equality expressions
of the form: <code>lop = rop</code>, where the the operands are
exported from the left child and the right child respectively.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">joints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">lkid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-192'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-192">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_include</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-193'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-193">#</a>
        </div>
        <p>Assemble the <code>FROM</code> list.
Set up the dispatch context for the first child term.
Note that currently right joins are never generated
by the compiler, so <code>is_nullable</code> is always <code>False</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">is_right</span><span class="p">,</span>
                             <span class="n">dispatcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">lkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-194'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-194">#</a>
        </div>
        <p>Assemble a frame for the first child.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">lkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-195'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-195">#</a>
        </div>
        <p>Restore the original dispatch context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-196'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-196">#</a>
        </div>
        <p>Generate a <code>JOIN</code> clause for the first subframe.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">lanchor</span> <span class="o">=</span> <span class="n">LeadingAnchor</span><span class="p">(</span><span class="n">lframe</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-197'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-197">#</a>
        </div>
        <p>Set up the dispatch context for the second child term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">is_left</span><span class="p">,</span>
                             <span class="n">dispatcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-198'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-198">#</a>
        </div>
        <p>Assemble a frame for the second child.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">rframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-199'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-199">#</a>
        </div>
        <p>Restore the original dispatch context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-200'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-200">#</a>
        </div>
        <p>Generate the join condition, which is a conjunction of equalities
of the form: <code>lop = rop</code>.  The operands of the equality operator
are evaluated against the left subframe and the right subframe
respectively.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">equalities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">joints</span><span class="p">:</span>
            <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">lkid</span><span class="p">)</span>
            <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span><span class="p">)</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">IsEqualSig</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">equality</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="n">is_nullable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span>
            <span class="n">equalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equality</span><span class="p">)</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">equalities</span><span class="p">:</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">equality</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">equality</span> <span class="ow">in</span> <span class="n">equalities</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">AndSig</span><span class="p">(),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                      <span class="n">is_nullable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                      <span class="n">ops</span><span class="o">=</span><span class="n">equalities</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">is_left</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">is_right</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">TruePhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-201'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-201">#</a>
        </div>
        <p>Generate a <code>JOIN</code> clause for the second subframe.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">ranchor</span> <span class="o">=</span> <span class="n">Anchor</span><span class="p">(</span><span class="n">rframe</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">is_left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">is_right</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-202'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-202">#</a>
        </div>
        <p>Return the generated <code>FROM</code> list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">lanchor</span><span class="p">,</span> <span class="n">ranchor</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-203'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-203">#</a>
        </div>
        <p>Assembles a frame for an embedding term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleEmbedding</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-204'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-204">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">EmbeddingTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-205'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-205">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-206'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-206">#</a>
        </div>
        <p>Call the super <code>delegate()</code> to review and forward claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">AssembleEmbedding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">delegate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-207'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-207">#</a>
        </div>
        <p>An embedding term adds an embedded term (i.e. a term whose frame
is not attached to the <code>FROM</code> list of its parent) to the regular
term tree.  Here, <code>lkid</code> belongs to the regular tree and <code>rkid</code>
is the embedded (correlation) term.  An embedded term (<code>rkid</code>)
contains a join condition connecting it to its regular counterpart
(<code>lkid</code>).  Now the tricky part is that <code>rkid</code> cannot assign claims
to <code>lkid</code> since the latter does not belong to its subtree, and by
the time the embedded frame is assembled, <code>lkid</code> is already
translated, so it is too late to request any claims.  Therefore,
it's the parent term which is going to request the claims on
behalf of the correlation term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-208'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-208">#</a>
        </div>
        <p>The embedded term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">correlation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-209'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-209">#</a>
        </div>
        <p>The join condition is a sequence of equalities: <code>lop = rop</code>,
where <code>lop</code> is exported from <code>lkid</code> and <code>rop</code> is exported
from (the child of) <code>rkid</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">correlation</span><span class="o">.</span><span class="n">joints</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-210'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-210">#</a>
        </div>
        <p>Assign the claims from th embedded term to its sibling term;
here <code>correlation.link</code> coincides with <code>lkid</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="n">correlation</span><span class="o">.</span><span class="n">link</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-211'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-211">#</a>
        </div>
        <p>While we are on it, we also assign claims to <code>rkid</code> (or rather
the child of <code>rkid</code>), although that is something <code>rkid</code> could
do for itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="n">correlation</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-212'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-212">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_include</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-213'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-213">#</a>
        </div>
        <p>Assemble the <code>FROM</code> list.
Although embedding is a binary term, only its first child goes
to the <code>FROM</code> list, so the assembling here practically coincides
with the one for a unary term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-214'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-214">#</a>
        </div>
        <p>Set up the dispatch context for the child term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">lkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-215'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-215">#</a>
        </div>
        <p>Assemble a frame corresponding to the first child.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">lkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-216'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-216">#</a>
        </div>
        <p>Restore the original dispatch context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-217'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-217">#</a>
        </div>
        <p>Generate a <code>JOIN</code> clause (without any join condition).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">anchor</span> <span class="o">=</span> <span class="n">LeadingAnchor</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-218'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-218">#</a>
        </div>
        <p>Return a <code>FROM</code> list with a single subframe.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">anchor</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-219'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-219">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-220'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-220">#</a>
        </div>
        <p>Assemble the list of embedded frames.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-221'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-221">#</a>
        </div>
        <p>Set up the dispatch context for the embedded term.  An embedded
frame is always considered nullable, although it may not be true
in some cases.  In practice, nullability of an embedded frame does
not affect the translator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-222'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-222">#</a>
        </div>
        <p>Generate a frame for the embedded term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">rkid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-223'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-223">#</a>
        </div>
        <p>Restore the original dispatch context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-224'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-224">#</a>
        </div>
        <p>Return a list of subframes embedded to the assembled frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">frame</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-225'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-225">#</a>
        </div>
        <p>Assembles a frame for a correlation term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleCorrelation</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-226'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-226">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">CorrelationTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-227'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-227">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-228'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-228">#</a>
        </div>
        <p>An embedded frame is special in that its <code>SELECT</code> clause could
contain only one phrase (corresponding to a correlation unit).
It is a responsibility of the compiler to ensure that there is
one and only one unit targeted to a correlation term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">claims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-229'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-229">#</a>
        </div>
        <p>Get the (only) claim.  It must be a compound claim of a correlation
unit targeted to the term itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">assert</span> <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">is_compound</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-230'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-230">#</a>
        </div>
        <p>Dismantle the unit, appoint and assign its subunits.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-231'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-231">#</a>
        </div>
        <p>Note that we do not need to assign the units of <code>joints</code>: it is done
by our parent, see <code>AssembleEmbedding.delegate()</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-232'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-232">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-233'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-233">#</a>
        </div>
        <p>Assemble a <code>SELECT</code> clause.
The (only) claim delegated (and targeted) to the frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-234'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-234">#</a>
        </div>
        <p>All the subunits must be already satisfied, so we could evaluate
a phrase corresponding to the claim unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-235'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-235">#</a>
        </div>
        <p>Generate an export phrase and satisfy the claim.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">domain</span> <span class="o">=</span> <span class="n">phrase</span><span class="o">.</span><span class="n">domain</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-236'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-236">#</a>
        </div>
        <p>Values produced by embedded frames are always nullable.
FIXME: is it always true? Still, it is safe to assume so, and it is
unlikely to significantly degrade the generated SQL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">export</span> <span class="o">=</span> <span class="n">EmbeddingPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">is_nullable</span><span class="p">,</span> <span class="n">claim</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">supply</span><span class="p">(</span><span class="n">claim</span><span class="p">,</span> <span class="n">export</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-237'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-237">#</a>
        </div>
        <p>Return the <code>SELECT</code> list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="p">[</span><span class="n">phrase</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-238'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-238">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_where</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-239'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-239">#</a>
        </div>
        <p>Assemble a <code>WHERE</code> clause.
The <code>WHERE</code> clause of a correlated frame is a conjunction of
equalities: <code>lop = rop</code>, where <code>rop</code> belongs to the child of the
correlated frame and <code>lop</code> belongs to the sibling frame.
It is tricky to evaluate <code>lop</code> because the sibling frame is
not a descendant of the correlated frame.
List of equality phrases.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">equalities</span> <span class="o">=</span> <span class="p">[]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-240'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-240">#</a>
        </div>
        <p>Iterate over <code>lop = rop</code> expressions:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">joints</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-241'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-241">#</a>
        </div>
        <p>We cannot dispatch <code>lop</code> directly because <code>link</code> is not
our descendant and thus, it is not in the dispatch table.
So we temporarily pop the current gate making the parent
gate current -- that puts <code>link</code> to the dispatching table.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pop_gate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-242'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-242">#</a>
        </div>
        <p>Evaluate the left operand against our sibling (<code>link</code> coincides
with <code>lkid</code> of our parent term).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">lop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">link</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-243'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-243">#</a>
        </div>
        <p>Restore the original dispatching context.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">push_gate</span><span class="p">(</span><span class="n">is_nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">dispatcher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-244'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-244">#</a>
        </div>
        <p>Evaluate the right operand against the child frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">rop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">rop</span><span class="p">,</span> <span class="n">router</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">kid</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-245'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-245">#</a>
        </div>
        <p>An individual condition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">is_nullable</span> <span class="o">=</span> <span class="p">(</span><span class="n">lop</span><span class="o">.</span><span class="n">is_nullable</span> <span class="ow">or</span> <span class="n">rop</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">)</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">IsEqualSig</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">equality</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                     <span class="n">is_nullable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                     <span class="n">lop</span><span class="o">=</span><span class="n">lop</span><span class="p">,</span> <span class="n">rop</span><span class="o">=</span><span class="n">rop</span><span class="p">)</span>
            <span class="n">equalities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equality</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-246'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-246">#</a>
        </div>
        <p>Generate and return the clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">condition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">equalities</span><span class="p">:</span>
            <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">equality</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">equality</span> <span class="ow">in</span> <span class="n">equalities</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="n">AndSig</span><span class="p">(),</span> <span class="nb">coerce</span><span class="p">(</span><span class="n">BooleanDomain</span><span class="p">()),</span>
                                      <span class="n">is_nullable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span>
                                      <span class="n">ops</span><span class="o">=</span><span class="n">equalities</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">condition</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-247'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-247">#</a>
        </div>
        <p>Assembles a frame for a segment term.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleSegment</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-248'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-248">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">SegmentTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-249'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-249">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-250'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-250">#</a>
        </div>
        <p>This is a top-level frame, so it can't have claims.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">claims</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-251'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-251">#</a>
        </div>
        <p>Assign all the units in the <code>SELECT</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-252'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-252">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_select</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-253'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-253">#</a>
        </div>
        <p>Assemble a <code>SELECT</code> clause.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="n">phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">select</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-254'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-254">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">assemble_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span>
                       <span class="n">where</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="p">,</span>
                       <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-255'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-255">#</a>
        </div>
        <p>Assemble a <code>SELECT</code> statement.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">SegmentFrame</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">embed</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span>
                            <span class="n">where</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">having</span><span class="p">,</span>
                            <span class="n">order</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-256'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-256">#</a>
        </div>
        <p>Assembles a top-level query frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AssembleQuery</span><span class="p">(</span><span class="n">Assemble</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-257'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-257">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">QueryTerm</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-258'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-258">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-259'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-259">#</a>
        </div>
        <p>Compile the segment frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">segment</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-260'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-260">#</a>
        </div>
        <p>Initialize the state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-261'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-261">#</a>
        </div>
        <p>Compile the segment.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-262'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-262">#</a>
        </div>
        <p>Clean up the state.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-263'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-263">#</a>
        </div>
        <p>Generate a frame node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">QueryFrame</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-264'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-264">#</a>
        </div>
        <p>Translates a code node to a phrase node.</p>
<p>This is an interface adapter; see subclasses for implementations.</p>
<p>The :class:<code>Evaluate</code> adapter has the following signature::</p>
<pre>Evaluate(Code, AssemblingState) -> Phrase
</pre>

<p>The adapter is polymorphic on the <code>Code</code> argument.</p>
<p><code>code</code> (:class:<code>htsql.tr.flow.Code</code>)
The code node to translate.</p>
<p><code>state</code> (:class:<code>AssemblingState</code>)
The current state of the assembling process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">Evaluate</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-265'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-265">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-266'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-266">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">Code</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AssemblingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-267'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-267">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-268'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-268">#</a>
        </div>
        <p>Implement in subclasses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;the evaluate adapter is not implemented&quot;</span>
                                  <span class="s">&quot; for a </span><span class="si">%r</span><span class="s"> node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-269'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-269">#</a>
        </div>
        <p>Evaluates a literal code.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateLiteral</span><span class="p">(</span><span class="n">Evaluate</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-270'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-270">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">LiteralCode</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-271'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-271">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-272'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-272">#</a>
        </div>
        <p>Keep all attributes, but switch the class.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">LiteralPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-273'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-273">#</a>
        </div>
        <p>Evaluates a cast code.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateCast</span><span class="p">(</span><span class="n">Evaluate</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-274'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-274">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">CastCode</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-275'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-275">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-276'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-276">#</a>
        </div>
        <p>Evaluate the operand and generate a phrase node.
Note that the for some source and target domains, the reducer will
retranslate a generic cast phrase to a more specific expression.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CastPhrase</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">is_nullable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-277'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-277">#</a>
        </div>
        <p>Evaluates a formula node.</p>
<p>The evaluation could be specific to the formula signature and is
implemented by the :class:<code>EvaluateBySignature</code> adapter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateFormula</span><span class="p">(</span><span class="n">Evaluate</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-278'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-278">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">FormulaCode</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-279'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-279">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-280'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-280">#</a>
        </div>
        <p>Delegate the evaluation to <code>EvaluteBySignature</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">evaluate</span> <span class="o">=</span> <span class="n">EvaluateBySignature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">evaluate</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-281'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-281">#</a>
        </div>
        <p>Evaluates a formula node.</p>
<p>This is an auxiliary adapter used to evaluate
:class:<code>htsql.tr.flow.FormulaCode</code> nodes.  The adapter is polymorphic
on the formula signature.</p>
<p>Unless overridden, the adapter evaluates the arguments of the formula
and generates a new formula phrase with the same signature.</p>
<p><code>code</code> (:class:<code>htsql.tr.flow.FormulaCode</code>)
<pre>The formula node to evaluate.
</pre>
<code>state</code> (:class:<code>AssemblingState</code>)
The current state of the assembling process.</p>
<p>Aliases:</p>
<p><code>signature</code> (:class:<code>htsql.tr.signature.Signature</code>)
The signature of the formula.</p>
<p><code>domain</code> (:class:<code>htsql.tr.domain.Domain</code>)
The co-domain of the formula.</p>
<p><code>arguments</code> (:class:<code>htsql.tr.signature.Bag</code>)
The arguments of the formula.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateBySignature</span><span class="p">(</span><span class="n">Adapter</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-282'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-282">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Signature</span><span class="p">)</span>

    <span class="nd">@classmethod</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-283'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-283">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-284'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-284">#</a>
        </div>
        <p>Override the default dispatch since the adapter is polymorphic
on the type of the formula signature, not on the formula itself.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">FormulaCode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">signature</span><span class="p">),)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-285'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-285">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">FormulaCode</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">AssemblingState</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-286'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-286">#</a>
        </div>
        <p>Extract commonly used attributes of the node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">arguments</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-287'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-287">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-288'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-288">#</a>
        </div>
        <p>Evaluate the arguments of the formula.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-289'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-289">#</a>
        </div>
        <p>By default, assume that the formula is null-regular.  The adapter
should be overridden for nodes where it is not the case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">cells</span><span class="p">())</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-290'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-290">#</a>
        </div>
        <p>Generate a new formula node.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                             <span class="n">is_nullable</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">arguments</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-291'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-291">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateIsEqualBase</span><span class="p">(</span><span class="n">EvaluateBySignature</span><span class="p">):</span>

    <span class="n">adapts_many</span><span class="p">(</span><span class="n">IsEqualSig</span><span class="p">,</span> <span class="n">IsInSig</span><span class="p">,</span> <span class="n">CompareSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-292'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-292">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">EvaluateIsEqualBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">from_predicate</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-293'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-293">#</a>
        </div>
        <p>Evaluates the total equality (<code>==</code>) operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateIsTotallyEqualBase</span><span class="p">(</span><span class="n">EvaluateBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-294'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-294">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts_many</span><span class="p">(</span><span class="n">IsTotallyEqualSig</span><span class="p">,</span> <span class="n">IsNullSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-295'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-295">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-296'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-296">#</a>
        </div>
        <p>Override the default implementation since the total equality
operator is not null-regular, and, in fact, always not nullable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                               <span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">from_predicate</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-297'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-297">#</a>
        </div>
        <p>Evaluates the <code>null_if()</code> operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateNullIf</span><span class="p">(</span><span class="n">EvaluateBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-298'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-298">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">NullIfSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-299'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-299">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-300'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-300">#</a>
        </div>
        <p>Override the default implementation since the <code>null_if()</code>
operator is not null-regular, and, in fact, is always nullable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                             <span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-301'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-301">#</a>
        </div>
        <p>Evaluates the <code>if_null()</code> operator.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateIfNull</span><span class="p">(</span><span class="n">EvaluateBySignature</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-302'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-302">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">IfNullSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-303'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-303">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-304'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-304">#</a>
        </div>
        <p>Override the default implementation since the <code>null_if()</code>
operator is not null-regular.  It is nullable only if all of
its arguments are nullable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
        <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">cells</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                             <span class="n">is_nullable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-305'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-305">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateAndOrNot</span><span class="p">(</span><span class="n">EvaluateBySignature</span><span class="p">):</span>

    <span class="n">adapts_many</span><span class="p">(</span><span class="n">AndSig</span><span class="p">,</span> <span class="n">OrSig</span><span class="p">,</span> <span class="n">NotSig</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-306'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-306">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
                                   <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_predicate</span><span class="p">))</span>
        <span class="n">is_nullable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">is_nullable</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">cells</span><span class="p">())</span>
        <span class="n">phrase</span> <span class="o">=</span> <span class="n">FormulaPhrase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
                               <span class="n">is_nullable</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">from_predicate</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-307'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-307">#</a>
        </div>
        <p>Evaluates a unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">EvaluateUnit</span><span class="p">(</span><span class="n">Evaluate</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-308'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-308">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">adapts</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-309'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-309">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-310'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-310">#</a>
        </div>
        <p>Generate a claim for a unit (for the second time).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">appoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-311'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-311">#</a>
        </div>
        <p>We expect the claim to be already satisfied.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">assert</span> <span class="n">claim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">phrase_by_claim</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-312'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-312">#</a>
        </div>
        <p>Return the export phrase corresponding to the claim.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">phrase_by_claim</span><span class="p">[</span><span class="n">claim</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-313'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-313">#</a>
        </div>
        <p>Compiles a new frame node for the given term.</p>
<p>Returns a :class:<code>htsql.tr.frame.Frame</code> instance.</p>
<p><code>term</code> (:class:<code>htsql.tr.term.Term</code>)
<pre>A term node.
</pre>
<code>state</code> (:class:<code>AssemblingState</code> or <code>None</code>)
The assembling state to use.  If not set, a new assembling
state is instantiated.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-314'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-314">#</a>
        </div>
        <p>Instantiate a new assembling state if not given one.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">AssemblingState</span><span class="p">()</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-315'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-315">#</a>
        </div>
        <p>Realize and apply the <code>Assemble</code> adapter; return the generated frame.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">assemble</span> <span class="o">=</span> <span class="n">Assemble</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">assemble</span><span class="p">()</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
