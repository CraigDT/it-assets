<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>middleware.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>middleware.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Models for restless to store app links &amp; tests::</span>

<span class="sd">    Copyright (C) 2011 Department of Environment &amp; Conservation           </span>

<span class="sd">    Authors:</span>
<span class="sd">     * Adon Metcalfe</span>
<span class="sd">     * Ashley Felton</span>
<span class="sd">                                                                            </span>
<span class="sd">    This program is free software: you can redistribute it and/or modify    </span>
<span class="sd">    it under the terms of the GNU Affero General Public License as          </span>
<span class="sd">    published by the Free Software Foundation, either version 3 of the      </span>
<span class="sd">    License, or (at your option) any later version.                         </span>
<span class="sd">                                                                            </span>
<span class="sd">    This program is distributed in the hope that it will be useful,         </span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of          </span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the           </span>
<span class="sd">    GNU Affero General Public License for more details.                     </span>
<span class="sd">                                                                            </span>
<span class="sd">    You should have received a copy of the GNU Affero General Public License</span>
<span class="sd">    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;. </span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;log.&quot;</span><span class="o">+</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="nb">compile</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="kn">from</span> <span class="nn">restless.models</span> <span class="kn">import</span> <span class="n">Token</span><span class="p">,</span> <span class="n">get_locals</span>

<span class="n">EXEMPT_URLS</span> <span class="o">=</span> <span class="p">[</span><span class="nb">compile</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_URL</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))]</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;LOGIN_EXEMPT_URLS&#39;</span><span class="p">):</span>
    <span class="n">EXEMPT_URLS</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_EXEMPT_URLS</span><span class="p">]</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">class</span> <span class="nc">AuthenticationMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">_locals</span> <span class="o">=</span> <span class="n">get_locals</span><span class="p">()</span>
        <span class="n">_locals</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">akey</span> <span class="o">=</span> <span class="s">&quot;access_token&quot;</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Add site name to request object</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="n">request</span><span class="o">.</span><span class="n">SITE_NAME</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SITE_NAME</span>
        <span class="n">request</span><span class="o">.</span><span class="n">footer</span> <span class="o">=</span> <span class="s">&quot; (( {0} {1} ))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">SITE_NAME</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;11.06&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">akey</span><span class="p">:</span>
                <span class="n">akey</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">akey</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>if the request is made with a token check auth/magically authenticate</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="n">akey</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="n">akey</span><span class="p">])</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">token</span><span class="o">.</span><span class="n">modified</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">valid</span><span class="p">:</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>set backend to first available and log user in</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                    <span class="n">token</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTHENTICATION_BACKENDS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">user</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>refresh tokens modified date</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>                    <span class="n">token</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                    <span class="n">token</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">token</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">False</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>Required user authentication for all views</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;ALLOW_ANONYMOUS_ACCESS&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span> <span class="c"># Ignore authenticated tokens</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>Non-brainer: check django.contrib.auth.middlware.AuthenticationMiddleware is installed</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Require user authentication by default, except for any exempt URLs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALLOW_ANONYMOUS_ACCESS</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path_info</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">EXEMPT_URLS</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_URL</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
